/* @preserve
    Copyright (c) 2005-2016, Mendix bv. All rights reserved.
    See mxclientsystem/licenses.txt for third party licenses that apply.
*/
(window.mxJsonp=window.mxJsonp||[]).push([[1],{591:function(t,e,n){var r=n(20);Object.defineProperty(e,"__esModule",{value:!0}),e.buildOfflineDataBackend=function(t,e,n){var r,c,s,l,f,d,p,h;return a.default.async(function(m){for(;;)switch(m.prev=m.next){case 0:return r=n.createStoreFn,c=n.getStorageDirFn,s=n.downloadFileFn,l=n.getDocumentUrlFn,f=new o(window.mx.session.getConfig("sync_config.schema"),r),d=new e({downloadFileFn:s,getStorageDirFn:c}),p=new u.Synchronizer(f,d,t),h=new i.OfflineDataBackend({getDocumentUrlFn:l},t,f,d,p),m.next=7,a.default.awrap(h.initialize());case 7:return m.abrupt("return",h);case 8:case"end":return m.stop()}},null,this)};var a=r(n(115)),i=n(605),u=n(606),o=n(607)},592:function(t,e,n){var r=n(20);Object.defineProperty(e,"__esModule",{value:!0}),e.FileBackend=void 0;var a=r(n(103)),i=r(n(115)),u=r(n(34)),o=r(n(35)),c=n(266),s=n(26),l=function(){function t(e){(0,u.default)(this,t),this._config=e,this._storageDirPromise=null}return(0,o.default)(t,[{key:"listDir",value:function(t){var e,n,r;return i.default.async(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,i.default.awrap(this._openDir(t));case 3:return e=a.sent,n=e.createReader(),a.next=7,i.default.awrap((0,c.callbackToPromise)(n.readEntries.bind(n)));case 7:return r=a.sent,a.abrupt("return",r.map(function(t){return t.name}));case 11:if(a.prev=11,a.t0=a.catch(0),1===a.t0.code){a.next=15;break}throw a.t0;case 15:return a.abrupt("return",[]);case 16:case"end":return a.stop()}},null,this,[[0,11]])}},{key:"removeDir",value:function(t){var e;return i.default.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,i.default.awrap(this._openDir(t));case 3:return e=n.sent,n.next=6,i.default.awrap((0,c.callbackToPromise)(e.removeRecursively.bind(e)));case 6:n.next=12;break;case 8:if(n.prev=8,n.t0=n.catch(0),1===n.t0.code){n.next=12;break}throw n.t0;case 12:case"end":return n.stop()}},null,this,[[0,8]])}},{key:"readFile",value:function(t){return this._openFile(t).then(function(t){return function(t){return(0,c.callbackToPromise)(t.file.bind(t)).then(d).then(function(t){return new Blob([t])})}(t)})}},{key:"storeFile",value:function(t,e){return this._openFile(e,!0).then(function(e){return n=e,r=t,(0,c.callbackToPromise)(n.createWriter.bind(n)).then(function(t){return function(t,e){return new Promise(function(n,r){e.onwrite=n,e.onerror=r,e.write(t)})}(r,t)});var n,r})}},{key:"moveFile",value:function(t,e){var n,r,u,o,c,s;return i.default.async(function(l){for(;;)switch(l.prev=l.next){case 0:return l.next=2,i.default.awrap(this._openFile(t));case 2:return n=l.sent,r=f(e),u=(0,a.default)(r,2),o=u[0],c=u[1],l.next=6,i.default.awrap(this._openDir(o));case 6:return s=l.sent,l.next=9,i.default.awrap(p(n,s,c));case 9:case"end":return l.stop()}},null,this)}},{key:"removeFile",value:function(t){var e;return i.default.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,i.default.awrap(this._openFile(t));case 2:return e=n.sent,n.next=5,i.default.awrap((0,c.callbackToPromise)(e.remove.bind(e)));case 5:case"end":return n.stop()}},null,this)}},{key:"downloadFile",value:function(t,e){var n=this;return this._config.downloadFileFn?(0,c.callbackToPromise)(this._config.downloadFileFn,t,e):(0,s.get)(t,"blob").then(function(t){return n.storeFile(t,e)})}},{key:"_openFile",value:function(t){var e,n,r,u,o,s,l=arguments;return i.default.async(function(d){for(;;)switch(d.prev=d.next){case 0:return e=l.length>1&&void 0!==l[1]&&l[1],n=f(t),r=(0,a.default)(n,2),u=r[0],o=r[1],d.next=4,i.default.awrap(this._openDir(u,e));case 4:return s=d.sent,d.abrupt("return",(0,c.callbackToPromise)(s.getFile.bind(s),o,{create:e}));case 6:case"end":return d.stop()}},null,this)}},{key:"_openDir",value:function(t){var e,n,r,a,u=arguments;return i.default.async(function(o){for(;;)switch(o.prev=o.next){case 0:return e=u.length>1&&void 0!==u[1]&&u[1],n=t.split("/").filter(function(t){return""!==t}),o.next=4,i.default.awrap(this._getStorageDir());case 4:r=o.sent,a=0;case 6:if(!(a<n.length)){o.next=13;break}return o.next=9,i.default.awrap((0,c.callbackToPromise)(r.getDirectory.bind(r),n[a],{create:e}));case 9:r=o.sent;case 10:++a,o.next=6;break;case 13:return o.abrupt("return",r);case 14:case"end":return o.stop()}},null,this)}},{key:"_getStorageDir",value:function(){return this._config.getStorageDirFn?(0,c.callbackToPromise)(this._config.getStorageDirFn):(null===this._storageDirPromise&&(this._storageDirPromise=(0,c.callbackToPromise)(window.webkitRequestFileSystem,window.TEMPORARY,1048576).then(function(t){return t.root})),this._storageDirPromise)}}]),t}();function f(t){return t.split(/\/([^\/]+)$/)}function d(t){return new Promise(function(e,n){var r=new FileReader;r.onload=function(t){return e(t.target.result)},r.onerror=function(t){return n(t.target.error)},r.readAsArrayBuffer(t)})}function p(t,e,n){return new Promise(function(r,a){t.moveTo(e,n,r,a)})}e.FileBackend=l},597:function(t,e,n){t.exports={LIKE_ESCAPE_CHAR:"~",QUOTE_CHAR:'"'}},598:function(t,e,n){function r(t){this.fork=t}r.of=function(t){return new r(function(e,n){n(t)})},r.prototype.chain=function(t){var e=this;return new r(function(n,r){e.fork(n,function(e){t(e).fork(n,r)})})},r.prototype.orElse=function(t){var e=this;return new r(function(n,r){e.fork(function(e){t(e).fork(n,r)},r)})},r.prototype.ap=function(t){var e,n,a,i=this,u=2;return new r(function(r,o){function c(){0==--u&&o(e(n))}function s(t){void 0===a&&r(a=t)}i.fork(s,function(t){e=t,c()}),t.fork(s,function(t){n=t,c()})})},r.prototype.map=function(t){return this.chain(function(e){return r.of(t(e))})},r.rejected=r.prototype.rejected=function(t){return new r(function(e,n){e(t)})},r.parallel=function(t){return new r(function(e,n){var r,a=t.length,i=new Array(t.length);0!==t.length?t.forEach(function(t,u){t.fork(function(t){void 0===r&&(r=t,e(t))},function(t){return function(e){i[t]=e,void 0===r&&0==--a&&n(i)}}(u))}):n(i)})},r.sequence=function(t){return t.reduce(function(t,e){return t.chain(function(t){return e})},r.of(null))},t.exports=r},599:function(t,e,n){var r=n(612),a=n(598),i=new r(a);i.rejected=function(t){return new i(function(e){return a.rejected(t)})},i.parallel=function(t){return new i(function(e){return new a(function(n,r){if(0!==t.length){var a=new Array(t.length),i=t.length,u=!1;t.forEach(function(t,o){t.run(e).fork(function(t){u||(u=!0,n(t))},function(t){a[o]=t,u||0!=--i||r(a)})})}else r([])})})},i.sequence=function(t){return t.reduce(function(t,e){return t.chain(function(t){return e.map(function(e){return t.concat([e])})})},i.of([]))},t.exports=i},600:function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.getFsFileName=function(t,e){return t.replace(/:/g,"_")+"@"+(null!=e&&""!==e?e.toString():"local")},e.createUnsyncedGuid=function(){return a+r.getUniqueId()},e.wasGuidSynced=function(t){return!i.test(t)},e.isSpecialAttributeName=u,e.isReadonlyAttr=o,e.objectToJson=function(t){var e=Object.keys(t).filter(function(t){return!u(t)}).reduce(function(e,n){return e[n]={value:t[n]},o(t,n)&&(e[n].readonly=!0),e},{});return{guid:t.guid,objectType:t.$objectType,attributes:e}},e.jsonToObject=function(t){var e={guid:t.guid,$objectType:t.objectType,$readonlyAttrs:[]};for(var n in t.attributes)e[n]=t.attributes[n].value,t.attributes[n].readonly&&e.$readonlyAttrs.push(n);return e},e.THUMBNAIL_DIR_PATH=e.DOCUMENT_DIR_PATH=void 0;var r=n(12);e.DOCUMENT_DIR_PATH="files/documents/";e.THUMBNAIL_DIR_PATH="files/thumbnails/";var a="GUID:",i=new RegExp("^"+a);function u(t){return"guid"===t||"$"===t[0]}function o(t,e){return t.$readonlyAttrs.includes(e)}},601:function(t,e,n){var r=n(598),a={promiseFromTask:function(t){return new Promise(function(e,n){t.fork(n,e)})},callbackFromTask:function(t,e,n){t.fork(function(t){n&&n(t)},function(t){e&&e(t)})},taskFromPromise:function(t){return new r(function(e,n){t.then(n,e)})}};t.exports=a},605:function(t,e,n){var r=n(20);Object.defineProperty(e,"__esModule",{value:!0}),e.OfflineDataBackend=void 0;var a=r(n(215)),i=r(n(103)),u=r(n(115)),o=r(n(34)),c=r(n(35)),s=r(n(59)),l=r(n(53)),f=r(n(60)),d=n(600),p=n(108),h=n(23),m=n(350),y=n(12),b={String:null,Integer:"0",Long:"0",Decimal:"0",Float:"0",Currency:"0",Enum:null,HashString:null,ObjectReference:null,DateTime:null,Boolean:!1,AutoNumber:"0",Binary:null},v=function(t){function e(t,n,r,a,i){var u;return(0,o.default)(this,e),t=t||{},(u=(0,s.default)(this,(0,l.default)(e).call(this)))._store=r,u._getDocumentUrl=t.getDocumentUrlFn||w,u._objectCache=n,u._fileBackend=a,u._synchronizer=i,u._dirtyGuids=[],u}return(0,f.default)(e,t),(0,c.default)(e,[{key:"initialize",value:function(){var t;return u.default.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u.default.awrap(this._store.fetchDirty());case 2:t=e.sent,this._dirtyGuids=t.map(function(t){return t.guid});case 4:case"end":return e.stop()}},null,this)}},{key:"getByGuid",value:function(t,e){return Promise.all(t.map(this._getByGuid,this)).then(function(t){return{mxobjects:t.filter(function(t){return null!=t}).map(d.objectToJson)}})}},{key:"getByPath",value:function(t,e,n,r){var a,o,c,s,l,f,d,p,m,y,b,v,_,g,w=this;return u.default.async(function(j){for(;;)switch(j.prev=j.next){case 0:if("reverse"!==r){j.next=11;break}return a=this._objectCache.getAllObjects().filter(function(n){return n.getReferences(e).includes(t)}).map(function(t){return t.jsonData}),j.next=4,u.default.awrap(this.getSlice(n,[{attribute:e,operator:"equals",value:t}]));case 4:return o=j.sent,c=o.mxobjects,s=c.map(function(t){return h.MxObject.fromJson(t)}).filter(function(n){return n.getReferences(e).includes(t)}),l=s.filter(function(t){return!a.some(function(e){return e.guid===t.getGuid()})}).map(function(t){return t.jsonData}),j.abrupt("return",{mxobjects:a.concat(l)});case 11:if(f=this._objectCache.getObject(t)){j.next=19;break}return j.next=15,u.default.awrap(this.getByGuid([t]));case 15:d=j.sent,p=(0,i.default)(d.mxobjects,1),(m=p[0])&&(f=h.MxObject.fromJson(m));case 19:if(f){j.next=21;break}return j.abrupt("return",{mxobjects:[]});case 21:return y=f.getReferences(e),b=y.map(function(t){return w._objectCache.getObject(t)}).filter(function(t){return null!==t}).map(function(t){return t.jsonData}),v=y.filter(function(t){return!w._objectCache.has(t)}),j.next=26,u.default.awrap(this.getByGuid(v));case 26:return _=j.sent,g=_.mxobjects,j.abrupt("return",{mxobjects:g.concat(b)});case 29:case"end":return j.stop()}},null,this)}},{key:"getSlice",value:function(t,e,n){var r=this,a=window.mx.meta.getEntity(t),u=(e||[]).map(function(t){return t.attribute&&a.isReference(t.attribute)&&(t.value=r._synchronizer.getInternalGuid(t.value)),t});return this._store.getSlice(t,u,n).then(function(t){var e=(0,i.default)(t,2),n=e[0],a=e[1];return{mxobjects:n.map(r._synchronizer.makeObjectExternal,r._synchronizer).map(d.objectToJson),count:a}})}},{key:"create",value:function(t){var e=(0,d.createUnsyncedGuid)();return this._objectCache.onCreate([e]),this._objectCache.setMxObjects([g(e,t)]),Promise.resolve({actionResult:e})}},{key:"commit",value:function(t,e){var n,r,o,c,s,l,f,p,h,m,b,v,g,w,j,T,x,k=this;return u.default.async(function(e){for(;;)switch(e.prev=e.next){case 0:return x=function(t){var e={};return Object.keys(t).forEach(function(n){e[n]=Object.keys(t[n])}),e},T=function(t){return Object.assign({},t,y.mapObject(n[t.guid],function(t){return t.value}))},n=y.objectFromArray(t.map(function(t){return[t,k._objectCache.getChanges(t)]})),r=y.partition(function(t){return k._objectCache.has(t)},t),o=(0,i.default)(r,2),c=o[0],s=o[1],l=c.map(function(t){return k._objectCache.getObject(t)}),f=y.partition(function(t){return t.isPersistable()},l),p=(0,i.default)(f,2),h=p[0],m=p[1],b=h.map(_),e.next=9,u.default.awrap(Promise.all(s.map(this._getByGuid,this)));case 9:if(v=e.sent,!((g=v.concat(b).map(T)).length>0)){e.next=16;break}return e.next=14,u.default.awrap(this._store.insertOrReplace(g.map(this._synchronizer.makeObjectInternal,this._synchronizer)));case 14:(w=this._dirtyGuids).push.apply(w,(0,a.default)(g.map(function(t){return t.guid}))),this._objectCache.setMxObjects(g.map(function(t){return(0,d.objectToJson)(t)}));case 16:return j=m.map(_).map(T),this._objectCache.setMxObjects(j.map(function(t){return(0,d.objectToJson)(t)})),this._objectCache.onCommit(t),this._objectCache.removeChanges(x(n)),e.abrupt("return",{});case 21:case"end":return e.stop()}},null,this)}},{key:"rollback",value:function(t){var e=this;this._objectCache.removeAllChanges(t);var n=t.filter(function(t){return e._objectCache.isNew(t)});return this._objectCache.removeObjects(n),Promise.resolve({})}},{key:"validate",value:function(t){return Promise.resolve({})}},{key:"saveDocument",value:function(t,e,n,r){var a,i;return u.default.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r.size/1048576>n.maxFileSize)){e.next=2;break}throw new p.DescribedError("File too large");case 2:return e.next=4,u.default.awrap(this._getByGuid(t));case 4:return a=e.sent,i=(0,d.getFsFileName)(this._synchronizer.getInternalGuid(t),a?a.changedDate:void 0),e.next=8,u.default.awrap(this._fileBackend.storeFile(r,d.DOCUMENT_DIR_PATH+i));case 8:return this._objectCache.makeChange(t,"HasContents",!0),e.next=11,u.default.awrap(this.commit([t],null));case 11:case"end":return e.stop()}},null,this)}},{key:"getDocumentUrl",value:function(t,e,n){return this._getDocumentUrl((0,d.getFsFileName)(this._synchronizer.getInternalGuid(t),e),e,n)}},{key:"getImageUrl",value:function(t){return Promise.resolve(t)}},{key:"upload",value:function(){return this._synchronizer.upload()}},{key:"download",value:function(t){return u.default.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u.default.awrap(this._synchronizer.download(t));case 2:this._dirtyGuids=[];case 3:case"end":return e.stop()}},null,this)}},{key:"cleanupDirtyObjects",value:function(){return this._store.cleanupDirtyObjects()}},{key:"isDirty",value:function(t){return this._dirtyGuids.includes(t)}},{key:"cleanup",value:function(){return u.default.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,u.default.awrap(this._store.cleanDatabase());case 2:return t.next=4,u.default.awrap(this._fileBackend.removeDir(d.DOCUMENT_DIR_PATH));case 4:return t.next=6,u.default.awrap(this._fileBackend.removeDir(d.THUMBNAIL_DIR_PATH));case 6:this._dirtyGuids=[];case 7:case"end":return t.stop()}},null,this)}},{key:"_getByGuid",value:function(t){var e=this;return this._store.getByGuid(this._synchronizer.getInternalGuid(t)).then(function(t){return e._synchronizer.makeObjectExternal(t)})}}]),e}(m._DataBackend);function _(t){return(0,d.jsonToObject)(t.jsonData)}function g(t,e){var n={guid:t,objectType:e,attributes:{}},r=window.mx.meta.getEntity(e);return r.getAttributes().forEach(function(t){n.attributes[t]={value:b[r.getAttributeType(t)]}}),n}function w(t,e,n){var r=n?"thumbnails":"documents";return"filesystem:"+window.mx.appUrl+"temporary/files/"+r+"/"+t+"?"+ +new Date}e.OfflineDataBackend=v},606:function(t,e,n){var r=n(20);Object.defineProperty(e,"__esModule",{value:!0}),e.Synchronizer=void 0;var a=r(n(215)),i=r(n(103)),u=r(n(115)),o=r(n(34)),c=r(n(35)),s=n(600),l=n(47),f=n(85),d=n(326),p=n(265),h=n(351),m=n(57),y=r(n(12)),b=n(64),v=n(83),_=function(){function t(e,n,r){(0,o.default)(this,t),this._store=e,this._fileBackend=n,this._objectCache=r,this._internalToExternal={}}return(0,c.default)(t,[{key:"upload",value:function(){return u.default.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,u.default.awrap(this._upload());case 3:t.next=16;break;case 5:if(t.prev=5,t.t0=t.catch(0),!(t.t0 instanceof f.ConnectionError)){t.next=11;break}throw new h.TemporarySynchronizationError;case 11:if(t.t0 instanceof d.DanglingError){t.next=15;break}throw new p.SynchronizationError;case 15:throw t.t0;case 16:case"end":return t.stop()}},null,this,[[0,5]])}},{key:"download",value:function(t){return u.default.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,u.default.awrap(this._download(t));case 3:e.next=12;break;case 5:if(e.prev=5,e.t0=e.catch(0),!(e.t0 instanceof f.ConnectionError)){e.next=11;break}throw new h.TemporarySynchronizationError;case 11:throw new p.SynchronizationError;case 12:case"end":return e.stop()}},null,this,[[0,5]])}},{key:"_upload",value:function(){var t,e,n,r,a,o,c,f,p,h,m,b,_,g,w,j,T,x,k,E,D,O,F,N=this;return u.default.async(function(S){for(;;)switch(S.prev=S.next){case 0:return F=function(t,e){var n=window.mx.meta.getEntity(t.$objectType),r=Object.keys(t).filter(function(e){return!(0,s.isSpecialAttributeName)(e)&&n.isSyncable(e)&&!(0,s.isReadonlyAttr)(t,e)}).map(function(r){var a=t[r];return[r,{value:n.isObjectReference(r)&&null!=a&&!(0,s.wasGuidSynced)(a)?e[a]:a}]});return[(0,s.wasGuidSynced)(t.guid)?t.guid:e[t.guid],y.default.objectFromArray(r)]},O=function(t){return(0,l.instantiate)(t.$objectType).then(function(e){var n=e.objects.find(function(t){return t.guid===e.actionResult});return{internalObj:t,remoteJson:n}})},D=function(e){var n,r,a;return u.default.async(function(i){for(;;)switch(i.prev=i.next){case 0:return n=s.DOCUMENT_DIR_PATH+(0,s.getFsFileName)(e.guid,e.changedDate),i.next=3,u.default.awrap(t.readFile(n));case 3:return r=i.sent,i.next=6,u.default.awrap((0,v.uploadWithRetries)("__sync__","",r,2));case 6:return a=i.sent,i.abrupt("return",{tempGuid:a.commits[0],fileObjGuid:e.guid});case 8:case"end":return i.stop()}},null,this)},E=function(t){return window.mx.meta.getEntity(t.$objectType).isA("System.FileDocument")&&t.HasContents},k=function(t){var e=window.mx.meta.getEntity(t.$objectType);return y.default.arrayFromObject(t).filter(function(t){var n=(0,i.default)(t,2),r=n[0];n[1];return"guid"===r||!(0,s.isSpecialAttributeName)(r)&&e.isReference(r)})},x=function(t){var e=t.map(function(t){return t.guid}),n=y.default.unique(t.map(function(t){return k(t).map(function(t){var e=(0,i.default)(t,2);e[0];return e[1]})}).reduce(function(t,e){return t.concat(e)},[])).filter(function(t){return!(0,s.wasGuidSynced)(t)}).filter(function(t){return!e.includes(t)});if(n.length>0){var r=y.default.unique(t.map(function(t){return k(t).filter(function(t){var e=(0,i.default)(t,2),r=(e[0],e[1]);return n.includes(r)}).map(function(e){var n=(0,i.default)(e,2),r=n[0];n[1];return"object of type ".concat(t.$objectType," (reference ").concat(r,")")})}).reduce(function(t,e){return t.concat(e)},[])).join(", "),a="Sync has failed due to a modeling error. Your database contains objects that reference uncommitted objects:\n".concat(r,".");throw new d.DanglingError(a)}},t=this._fileBackend,S.next=9,u.default.awrap(this._store.fetchDirty());case 9:if(0!==(e=S.sent).length){S.next=12;break}return S.abrupt("return",{});case 12:return x(e),n=y.default.partition(function(t){return(0,s.wasGuidSynced)(t.guid)},e),r=(0,i.default)(n,2),a=r[0],o=r[1],c=e.filter(E),S.next=17,u.default.awrap(Promise.all([Promise.all(c.map(D)),Promise.all(o.map(O))]));case 17:return f=S.sent,p=(0,i.default)(f,2),h=p[0],m=p[1],b=y.default.objectFromArray(m.map(function(t){var e=t.internalObj,n=t.remoteJson;return[e.guid,n.guid]})),_=y.default.objectFromArray(h.map(function(t){var e=t.tempGuid,n=t.fileObjGuid;return(0,s.wasGuidSynced)(n)?[e,n]:[e,b[n]]})),g=a.map(function(t){return t.guid}).concat(m.map(function(t){return t.remoteJson.guid})),w=m.map(function(t){return t.remoteJson}),j=y.default.objectFromArray(e.map(function(t){return F(t,b)})),S.next=28,u.default.awrap((0,l.synchronize)(g,_,j,w));case 28:return T=S.sent,S.next=31,u.default.awrap(this._store.makeClean(e));case 31:return S.next=33,u.default.awrap(Promise.all(c.map(function(e){var n,r,a,i,o;return u.default.async(function(c){for(;;)switch(c.prev=c.next){case 0:return n=b[e.guid]||e.guid,r=T.objects.find(function(t){return t.guid===n}),a=r.attributes.changedDate.value,i=s.DOCUMENT_DIR_PATH+(0,s.getFsFileName)(e.guid,e.changedDate),o=s.DOCUMENT_DIR_PATH+(0,s.getFsFileName)(n,a),c.next=7,u.default.awrap(t.moveFile(i,o));case 7:case"end":return c.stop()}},null,this)})));case 33:return y.default.arrayFromObject(b).forEach(function(t){var e=(0,i.default)(t,2),n=e[0],r=e[1];return N._mapInternalGuid(n,r)}),S.abrupt("return",{});case 35:case"end":return S.stop()}},null,this)}},{key:"_download",value:function(t){var e,n,r,o,c,f,d,p,h,v,_,g,w,j,T,x,k,E,D=this;return u.default.async(function(O){for(;;)switch(O.prev=O.next){case 0:return E=function(t,n){var r,a,i,o,c;return u.default.async(function(l){for(;;)switch(l.prev=l.next){case 0:return r=n?s.THUMBNAIL_DIR_PATH:s.DOCUMENT_DIR_PATH,a=t.filter(function(t){return window.mx.meta.getEntity(t.$objectType).isA(n?"System.Image":"System.FileDocument")}).filter(function(t){return t.HasContents}).map(function(t){return{source:(0,m.getRemoteDynamicResourceUrl)(t.guid,t.changedDate,n),destination:r+(0,s.getFsFileName)(t.guid,t.changedDate)}}),l.next=4,u.default.awrap(e.listDir(r));case 4:return l.t0=function(t){return r+t},i=l.sent.map(l.t0),o=a.filter(function(t){return!i.includes(t.destination)}),c=i.filter(function(t){return!a.find(function(e){return e.destination===t})}),l.abrupt("return",[o,c]);case 9:case"end":return l.stop()}},null,this)},k=function(t,e){return(0,l.retrieveByXPath)(e).then(function(e){return e.mxobjects.map(s.jsonToObject).map(function(e){return Object.assign({},e,{$objectType:t})})})},e=this._fileBackend,O.t0=y.default,O.next=6,u.default.awrap(Promise.all(t.map(function(t){var e=t.store,n=t.xpath;return k(e,n)})));case 6:return O.t1=O.sent,n=O.t0.flatten.call(O.t0,O.t1),O.next=10,u.default.awrap(E(n,!1));case 10:return r=O.sent,o=(0,i.default)(r,2),c=o[0],f=o[1],O.next=16,u.default.awrap(E(n,!0));case 16:return d=O.sent,p=(0,i.default)(d,2),h=p[0],v=p[1],O.next=22,u.default.awrap(Promise.all(c.concat(h).map(function(t){var n=t.source,r=t.destination;return e.downloadFile(n,r)})));case 22:return O.next=24,u.default.awrap(this._store.rebuildDatabase(n));case 24:return Promise.all(f.concat(v).map(function(t){return e.removeFile(t)})).catch(window.mx.onError),_=n.map(this.makeObjectExternal,this),g=this._objectCache.getAllObjects().filter(function(t){return t.isPersistable()&&!D._objectCache.isNew(t.getGuid())}).map(function(t){return[_.find(function(e){return e.guid===t.getGuid()}),t]}),w=y.default.partition(function(t){return void 0!==(0,i.default)(t,1)[0]},g),j=(0,i.default)(w,2),T=j[0],x=j[1],this._objectCache.setMxObjects(T.map(function(t){var e=(0,i.default)(t,1)[0];return(0,s.objectToJson)(e)})),this._objectCache.onDelete(x.map(function(t){var e=(0,i.default)(t,2);e[0];return e[1].getGuid()})),O.next=32,u.default.awrap(b.publish.apply(void 0,(0,a.default)(t.map(function(t){return{entity:t.store}})).concat((0,a.default)(T.map(function(t){return{guid:(0,i.default)(t,1)[0].guid}})),(0,a.default)(x.map(function(t){var e=(0,i.default)(t,2);e[0];return{guid:e[1].getGuid()}})))));case 32:return O.abrupt("return",{});case 33:case"end":return O.stop()}},null,this)}},{key:"getExternalGuid",value:function(t){return this._internalToExternal[t]||t}},{key:"getInternalGuid",value:function(t){for(var e in this._internalToExternal)if(this._internalToExternal[e]===t)return e;return t}},{key:"makeObjectExternal",value:function(t){return g(t,this.getExternalGuid.bind(this))}},{key:"makeObjectInternal",value:function(t){return g(t,this.getInternalGuid.bind(this))}},{key:"_mapInternalGuid",value:function(t,e){this._internalToExternal[e]=t}}]),t}();function g(t,e){if(null===t)return null;var n=window.mx.meta.getEntity(t.$objectType);return y.default.mapObject(t,function(t,r){return("guid"===r||!(0,s.isSpecialAttributeName)(r)&&n.isReference(r))&&null!=t?e(t):t})}e.Synchronizer=_},607:function(t,e,n){var r=n(608),a=n(613),i=n(614),u=n(599),o=n(601);function c(){return window.openDatabase("MendixDatabase","1","Mendix Database",10485760)}function s(t,e){i.call(this),e=e||c,this._tableNames=t;var n=e();this._databasePromise=this._initialize(n)}s.prototype=Object.create(i.prototype),s.prototype._getDatabase=function(){return this._databasePromise},s.prototype._initialize=function(t){var e=r.createCreateTransaction(this._tableNames);return o.promiseFromTask(a.runWriteTransaction(t,e)).then(function(){return t})},s.prototype._fetch=function(t){return function(e){var n=r.createFetchByGuidTransaction(t);return o.promiseFromTask(a.runReadTransaction(e,n))}},s.prototype._fetchSlice=function(t,e,n){return function(i){var u=r.createFetchSliceTransaction(t,e,n.offset,n.limit,n.sort);return o.promiseFromTask(a.runReadTransaction(i,u))}},s.prototype._rebuildDb=function(t){return u.ask().chain(function(e){var n=r.createRebuildTransaction(this._tableNames,t);return new u(function(t){return a.runWriteTransaction(e,n)})}.bind(this))},s.prototype._insertOrReplace=function(t){return function(e){var n=r.createInsertOrReplaceTransaction(t);return o.promiseFromTask(a.runWriteTransaction(e,n))}},s.prototype._cleanDatabase=function(){var t=this;return function(e){var n=r.createCleanTransaction(t._tableNames);return o.promiseFromTask(a.runWriteTransaction(e,n))}},s.prototype._fetchDirty=function(){return u.ask().chain(function(t){var e=r.createFetchDirtyObjectsTransaction();return new u(function(n){return a.runWriteTransaction(t,e)})})},s.prototype._makeClean=function(t){return u.ask().chain(function(e){var n=r.createMakeCleanTransaction(t);return new u(function(t){return a.runWriteTransaction(e,n)})})},s.prototype._cleanupDirtyObjects=function(){return function(t){var e=r.createDirtyCleanupTransaction();return o.promiseFromTask(a.runWriteTransaction(t,e))}},t.exports=s},608:function(t,e,n){var r=n(597),a=n(609),i=a.SqlSelectBuilder,u=a.constraintBuilder,o=n(610),c=n(611),s=n(599),l=n(598),f=n(11),d="_guidToTable",p={String:"text",Integer:"text",Long:"text",Decimal:"text",Float:"text",Currency:"text",Enum:"text",HashString:"text",ObjectReference:"text",DateTime:"integer",Boolean:"integer",AutoNumber:"integer",Binary:"blob"},h={String:T,Integer:j,Long:j,Decimal:j,Float:j,Currency:j,Enum:T,HashString:T,ObjectReference:T,DateTime:function(t){return null!=t?Number(t):null},Boolean:Number,AutoNumber:T,Binary:T},m={String:T,Integer:T,Long:T,Decimal:T,Float:T,Currency:T,Enum:T,HashString:T,ObjectReference:T,DateTime:x,Boolean:Boolean,AutoNumber:T,Binary:T},y={String:x,Integer:x,Long:x,Decimal:x,Float:x,Currency:x,Enum:x,HashString:x,ObjectReference:x,DateTime:function(t){return t?Number(t):null},Boolean:function(t){return"false"!==t},AutoNumber:x,Binary:x},b={createCreateTransaction:v,createCleanTransaction:function(t){var e=[d].concat(t).map(E).map(function(t){return"DELETE FROM '".concat(t,"'")}).map(function(t){return N(t,[])});return s.parallel(e).map(function(t){})},createFetchByGuidTransaction:function(t){return N((new i).from(d).where(u.equals("guid")).select(),[t]).chain(function(e){if(0===e.rows.length)return s.of(null);if(1!==e.rows.length)return s.rejected(new Error("db consistency error"));var n=e.rows.item(0),r=n.tableName,a=Boolean(n.dirty),o=n.readonlyAttrs;return N((new i).from(E(r)).where(u.equals("guid")).select(),[t]).chain(function(t){return 0===t.rows.length?s.rejected(new Error("entity not found")):1!==t.rows.length?s.rejected(new Error("db consistency error")):s.of(O(window.mx.meta.getEntity(r),a,o,t.rows.item(0)))})})},createFetchSliceTransaction:function(t,e,n,a,o){e=e||[],o=o||[];var c=window.mx.meta.getEntity(t),l=function(t,e){var n=[];return{builder:(new i).where(e.map(function e(a){if(a.constraints)return u[a.operator](a.constraints.map(e).filter(function(t){return null!==t}));if(null==a.value)switch(a.operator){case"contains":return null;case"equals":return u.isNull(E(a.attribute),a.negate)}var i=t.getAttributeType(a.attribute);var o=y[i];var c=h[i];var s=c(o(a.value));n.push("contains"===a.operator?(l=s,f=r.LIKE_ESCAPE_CHAR,l.replace(new RegExp(f,"g"),f+f).replace(/%/g,f+"%").replace(/_/g,f+"_")):s);var l,f;return u[a.operator](E(a.attribute),a.negate)}).filter(function(t){return null!==t})),args:n}}(c,e),f=l.builder.from(E(t)),p=l.args,m=f.offset(n).limit(a).join(d,"guid",["dirty","readonlyAttrs"]),b=N((m=o.reduce(function(t,e){return t.order(e[0],e[1])},m)).select(),p).map(function(t){for(var e=[],n=0;n<t.rows.length;++n){var r=t.rows.item(n),a=Boolean(r["".concat(d,".dirty")]),i=F(r,"readonlyAttrs");e.push(O(c,a,i,r))}return e}),v=N(f.selectCount("cnt"),p).map(function(t){return t.rows.item(0).cnt});return s.parallel([b,v])},createInsertOrReplaceTransaction:function(t){return s.parallel(t.map(function(t){var e=t.$objectType,n=g(),r=w(e,t);return[N(n.insertOrReplace(),[t.guid,e,1,JSON.stringify(t.$readonlyAttrs)]),N(r.builder.insertOrReplace(),r.values)]}).reduce(function(t,e){return t.concat(e)},[])).map(function(t){})},createFetchDirtyObjectsTransaction:function(){return _().chain(function(t){var e=k(t.rows).map(function(t){var e=t.tableName,n=(new i).from(E(e)).join(d,"guid",["dirty","readonlyAttrs"]).where(u.equals("".concat(d,".dirty"))).select(),r=window.mx.meta.getEntity(e);return N(n,[1]).map(function(t){return k(t.rows).map(function(t){return O(r,!0,F(t,"readonlyAttrs"),t)})})});return s.parallel(e)}).map(function(t){return t.reduce(function(t,e){return t.concat(e)},[])})},createMakeCleanTransaction:function(t){var e=t.map(function(t){return N("UPDATE ".concat(d," set dirty = 0 where guid = ?"),[t.guid])});return s.parallel(e).map(function(t){})},createDirtyCleanupTransaction:function(){return _().chain(function(t){var e=k(t.rows).map(function(t){var e=t.tableName;return N("DELETE FROM ".concat(E(e)," WHERE guid IN (\n                            SELECT guid FROM ").concat(d," WHERE tableName = ? AND dirty = 1)"),[e])});return s.sequence([s.parallel(e),N("DELETE FROM ".concat(d," WHERE dirty = 1"))]).map(function(t){})})},createRebuildTransaction:function(t,e){var n=function(t){var e=[d].concat(t).map(E).map(function(t){return"DROP TABLE IF EXISTS '"+t+"'"}).map(function(t){return N(t,[])});return s.sequence([s.parallel(e),v(t)])}(t),r=t.map(function(t){var n=e.filter(function(e){return e.$objectType===t});return function(t,e){var n=e.reduce(function(e,n){var r=g(),a=w(t,n);return e.concat([N(r.insert(),[n.guid,t,0,JSON.stringify(n.$readonlyAttrs)]),N(a.builder.insert(),a.values)])},[]);return s.parallel(n).map(function(t){})}(t,n)});return s.sequence([n,s.parallel(r)]).map(function(t){})}};function v(t){var e,n=[(e=(new o).table(d).primaryKeyColumn("guid","text").column("tableName","text").column("dirty","boolean").column("readonlyAttrs","text").createIfNotExists(),N(e,[]))].concat(t.map(function(t){return N(function(t){var e=window.mx.meta.getEntity(t);return e.getAttributes().map(function(t){var n=e.getAttributeType(t);return{attr:t,type:p[n]}})}(t).reduce(function(t,e){return t.column(E(e.attr),e.type)},(new o).table(E(t)).primaryKeyColumn("guid","text")).createIfNotExists(),[])}));return s.parallel(n).map(function(t){})}function _(){return N((new i).from(d).where(u.equals("dirty")).selectDistinct("tableName"),[1])}function g(){return(new c).into(d).column("guid").column("tableName").column("dirty").column("readonlyAttrs")}function w(t,e){var n=window.mx.meta.getEntity(t),r=n.getAttributes().reduce(function(t,r){var a=n.getAttributeType(r),i=h[a];if(!i)return t;var u=i(e[r]);return{attrs:t.attrs.concat([r]),values:t.values.concat([u])}},{attrs:["guid"],values:[e.guid]});return{builder:r.attrs.reduce(function(t,e){return t.column(E(e))},(new c).into(E(t))),values:r.values}}function j(t){if(null==t)return null;var e=new f(t),n=20-Math.max(0,e.e)-1;return(e.s<0?"-":"")+new Array(n+1).join("0")+e.abs().toFixed()}function T(t){return null!=t?String(t):null}function x(t){return t}function k(t){for(var e=[],n=0;n<t.length;++n)e.push(t.item(n));return e}function E(t){return t.replace(".","$")}function D(t){return t.replace("$",".")}function O(t,e,n,r){var a,i={guid:r.guid,$objectType:t.getEntity(),$dirty:e,$readonlyAttrs:JSON.parse(n)};for(var u in r)if(!("guid"===(a=u)||a.indexOf(".")>-1)){var o=D(u),c=t.getAttributeType(o),s=m[c];s&&(i[o]=s(r[u]))}return i}function F(t,e){return t["".concat(d,".").concat(e)]}function N(t,e){return e=e||[],new s(function(n){return new l(function(r,a){n.executeSql(t,e,function(t,e){return a(e)},function(t,e){return r(e)})})})}t.exports=b},609:function(t,e,n){var r=n(20);Object.defineProperty(e,"__esModule",{value:!0}),e.constraintBuilder=e.SqlSelectBuilder=void 0;var a=r(n(34)),i=r(n(35)),u=n(597),o=function(){function t(e,n){(0,a.default)(this,t),this._select=n&&n.select||e&&e._select||null,this._from=n&&n.from||e&&e._from||null,this._join=n&&n.join||e&&e._join||null,this._constraints=n&&n.constraints||e&&e._constraints||[],this._orderBy=n&&n.orderBy||e&&e._orderBy||[],this._limit=n&&n.limit||e&&e._limit||null,this._offset=n&&n.offset||e&&e._offset||null}return(0,i.default)(t,[{key:"from",value:function(e){return new t(this,{from:e})}},{key:"join",value:function(e,n,r){return new t(this,{join:{tableName:e,joinOnColumn:n,selectedColumns:r}})}},{key:"where",value:function(e){return new t(this,{constraints:this._constraints.concat(e)})}},{key:"order",value:function(e,n){return new t(this,{orderBy:this._orderBy.concat([[e,n]])})}},{key:"limit",value:function(e){return new t(this,{limit:e})}},{key:"offset",value:function(e){return new t(this,{offset:e})}},{key:"selectDistinct",value:function(t){return Array.isArray(t)&&(t=t.join(", ")),"SELECT DISTINCT ".concat(t," ").concat(this._buildSql())}},{key:"selectCount",value:function(t){return"SELECT COUNT(*) AS ".concat(t)+this._buildSql()}},{key:"select",value:function(){var t=this,e="SELECT ".concat(this._from,".*");return this._join&&this._join.selectedColumns.forEach(function(n){e+=", ".concat(t._join.tableName,".[").concat(n,'] as "').concat(t._join.tableName,".").concat(n,'"')}),e+this._buildSql()}},{key:"_buildSql",value:function(){var t=this,e=" FROM ".concat(this._from," AS ").concat(this._from);return this._join&&(e+=" JOIN ".concat(this._join.tableName," AS ").concat(this._join.tableName," USING (").concat(this._join.joinOnColumn,")")),this._constraints.length>0&&(e+=" WHERE "+this._constraints.map(function(e){return e.build(t._from)}).join(" AND ")),this._orderBy.length>0&&(e+=" ORDER BY "+this._orderBy.map(function(e){return"".concat(t._from,".[").concat(e[0],"] ").concat(e[1])}).join(", ")),this._limit&&(e+=" LIMIT "+this._limit),this._offset&&(e+=" OFFSET "+this._offset),e}}]),t}();e.SqlSelectBuilder=o;var c={equals:p("="),lessThan:p("<"),lessThanOrEquals:p("<="),greaterThan:p(">"),greaterThanOrEquals:p(">="),contains:function(t){var e="";return e+=t,e+=" LIKE '%' || ? || '%'",e+=" ESCAPE '"+u.LIKE_ESCAPE_CHAR+"'"}},s=function(){function t(e,n,r){(0,a.default)(this,t),this._column=e,this._operator=n,this._negate=!!r}return(0,i.default)(t,[{key:"build",value:function(t){var e=c[this._operator],n=this._column.indexOf(".")>-1?this._column:"".concat(t,".[").concat(this._column,"]");return(this._negate?"NOT ":"")+e(n)}}]),t}(),l=function(){function t(e,n){(0,a.default)(this,t),this._column=e,this._negate=!!n}return(0,i.default)(t,[{key:"build",value:function(t){return(this._column.indexOf(".")>-1?this._column:"".concat(t,".[").concat(this._column,"]"))+" IS "+(this._negate?"NOT ":"")+"NULL"}}]),t}(),f=function(){function t(e,n){(0,a.default)(this,t),this.group=e,this.constraints=n||[]}return(0,i.default)(t,[{key:"add",value:function(t){this.constraints.push(t)}},{key:"build",value:function(t){return"("+this.constraints.map(function(e){return e.build(t)}).join(" ".concat(this.group," "))+")"}}]),t}(),d={and:function(t){return new f("and",t)},or:function(t){return new f("or",t)},equals:function(t,e){return new s(t,"equals",e)},isNull:function(t,e){return new l(t,e)},lessThan:function(t,e){return new s(t,"lessThan",e)},lessThanOrEquals:function(t,e){return new s(t,"lessThanOrEquals",e)},greaterThan:function(t,e){return new s(t,"greaterThan",e)},greaterThanOrEquals:function(t,e){return new s(t,"greaterThanOrEquals",e)},contains:function(t,e){return new s(t,"contains",e)}};function p(t){return function(e){return e+" "+t+" ?"}}e.constraintBuilder=d},610:function(t,e,n){var r=n(597);function a(t,e){this._tableName=e&&e.tableName||t&&t._tableName||null,this._columns=e&&e.columns||t&&t._columns||[]}function i(t){var e=r.QUOTE_CHAR;return e+t+e}a.prototype.table=function(t){return new a(this,{tableName:t})},a.prototype.column=function(t,e){return new a(this,{columns:this._columns.concat({columnName:t,columnType:e,isPrimary:!1})})},a.prototype.primaryKeyColumn=function(t,e){return new a(this,{columns:this._columns.concat({columnName:t,columnType:e,isPrimary:!0})})},a.prototype.createIfNotExists=function(){var t="";return t+="CREATE TABLE IF NOT EXISTS "+i(this._tableName),t+=this._buildSql()},a.prototype._buildSql=function(){var t="";return this._columns.length>0&&(t+=" (",t+=this._columns.map(function(t){return[i(t.columnName),t.columnType,"text"===t.columnType?" COLLATE NOCASE ":"",t.isPrimary?"PRIMARY KEY ":""].join(" ").slice(0,-1)},this).join(", "),t+=")"),t},t.exports=a},611:function(t,e,n){var r=n(597);function a(t,e){if(!(this instanceof a))return new a;this._tableName=e&&e.tableName||t&&t._tableName||null,this._columnNames=e&&e.columnNames||t&&t._columnNames||[]}function i(t){var e=r.QUOTE_CHAR;return e+t+e}a.prototype.into=function(t){return new a(this,{tableName:t})},a.prototype.column=function(t){return new a(this,{columnNames:this._columnNames.concat(t)})},a.prototype.insert=function(){var t="";return t+="INSERT INTO "+i(this._tableName),t+=this._buildSql()},a.prototype.insertOrReplace=function(){var t="";return t+="INSERT OR REPLACE INTO "+i(this._tableName),t+=this._buildSql()},a.prototype._buildSql=function(){var t="";return this._columnNames.length>0&&(t+=" (",t+=this._columnNames.map(i).join(", "),t+=")"),t+=" VALUES (",t+="?"+new Array(this._columnNames.length).join(", ?"),t+=")"},t.exports=a},612:function(t,e,n){t.exports=function(t){function e(t){this.run=t}return e.prototype.chain=function(t){return new e(function(e){return this.run(e).chain(function(n){return t(n).run(e)})}.bind(this))},e.prototype.ap=function(t){return new e(function(e){return this.run(e).ap(t.run(e))}.bind(this))},e.prototype.map=function(t){return this.chain(function(n){return e.of(t(n))})},e.of=function(n){return new e(function(e){return t.of(n)})},e.ask=function(){return new e(t.of)},e}},613:function(t,e,n){var r=n(598);function a(t){return function(e,n){return new r(function(r,a){var i,u=2;e[t](function(t){n.run(t).fork(r,function(t){i=t,0==--u&&a(i)})},r,function(){0==--u&&a(i)})})}}t.exports={runReadTransaction:a("readTransaction"),runWriteTransaction:a("transaction")}},614:function(t,e,n){var r=n(601),a=n(599);function i(){}i.prototype.getSlice=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this._getDatabase().then(this._fetchSlice(t,e,n))},i.prototype.getByGuid=function(t){return this._getDatabase().then(this._fetch(t))},i.prototype.insertOrReplace=function(t){return this._getDatabase().then(this._insertOrReplace(t))},i.prototype.cleanDatabase=function(){return this._getDatabase().then(this._cleanDatabase())},i.prototype.rebuildDatabase=function(t){var e=this;return this._getDatabase().then(function(n){return r.promiseFromTask(e._rebuildDb(t).run(n))})},i.prototype.fetchDirty=function(){var t=this;return this._getDatabase().then(function(e){return r.promiseFromTask(t._fetchDirty().run(e))})},i.prototype.makeClean=function(t){var e=this;return this._getDatabase().then(function(n){return r.promiseFromTask(e._makeClean(t).run(n))})},i.prototype.cleanupDirtyObjects=function(){return this._getDatabase().then(this._cleanupDirtyObjects())},i.prototype._getDatabase=function(){return Promise.reject(new Error("not implemented"))},i.prototype._initialize=function(){return Promise.reject(new Error("not implemented"))},i.prototype._fetch=function(t){return function(t){return Promise.reject(new Error("not implemented"))}},i.prototype._fetchSlice=function(t,e,n){return function(t){return Promise.reject(new Error("not implemented"))}},i.prototype._insertOrReplace=function(t){return function(t){return Promise.reject(new Error("not implemented"))}},i.prototype._cleanDatabase=function(){return function(t){return Promise.reject(new Error("not implemented"))}},i.prototype._rebuildDb=function(t){return a.rejected(new Error("not implemented"))},i.prototype._fetchDirty=function(){return a.rejected(new Error("not implemented"))},i.prototype._makeClean=function(){return a.rejected(new Error("not implemented"))},i.prototype._cleanupDirtyObjects=function(){return function(t){return Promise.reject(new Error("not implemented"))}},t.exports=i}}]);