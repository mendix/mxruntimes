/* @preserve
    Copyright (c) 2005-2016, Mendix bv. All rights reserved.
    See mxclientsystem/licenses.txt for third party licenses that apply.
*/
(window.mxJsonp=window.mxJsonp||[]).push([[1],{661:function(e,t,n){var r=n(14);Object.defineProperty(t,"__esModule",{value:!0}),t.buildOfflineDataBackend=function(e,t,n,r,s){var l,f,d,p;return a.default.async((function(h){for(;;)switch(h.prev=h.next){case 0:return l=new o.SqlStore(n,t),f=new c.Synchronizer(l,r,e),d=new i.OfflineDataBackend(e,l,r,f,s),h.next=5,a.default.awrap(d.initialize());case 5:return p=new u.OfflineData(e,t),h.abrupt("return",{dataBackend:d,offlineData:p});case 7:case"end":return h.stop()}}))};var a=r(n(94)),u=n(697),i=n(676),o=n(677),c=n(686)},662:function(e,t,n){var r=n(14);Object.defineProperty(t,"__esModule",{value:!0}),t.FileBackend=void 0;var a=r(n(89)),u=r(n(94)),i=r(n(26)),o=r(n(27)),c=n(670),s=n(237),l=n(23),f=function(){function e(t){(0,i.default)(this,e),this._config=t,this._storageDirPromise=null}return(0,o.default)(e,[{key:"listDir",value:function(e){var t,n,r;return u.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,u.default.awrap(this._openDir(e));case 3:return t=a.sent,n=t.createReader(),a.next=7,u.default.awrap((0,s.callbackToPromise)(n.readEntries.bind(n)));case 7:return r=a.sent,a.abrupt("return",r.map((function(e){return e.name})));case 11:return a.prev=11,a.t0=a.catch(0),a.abrupt("return",[]);case 14:case"end":return a.stop()}}),null,this,[[0,11]])}},{key:"removeDir",value:function(e){var t;return u.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,u.default.awrap(this._openDir(e));case 3:return t=n.sent,n.next=6,u.default.awrap((0,s.callbackToPromise)(t.removeRecursively.bind(t)));case 6:n.next=10;break;case 8:n.prev=8,n.t0=n.catch(0);case 10:case"end":return n.stop()}}),null,this,[[0,8]])}},{key:"readFile",value:function(e){return this._openFile(e).then((function(e){return function(e){return(0,s.callbackToPromise)(e.file.bind(e)).then(p).then((function(e){return new Blob([e])}))}(e)}))}},{key:"storeFile",value:function(e,t){return this._openFile(t,!0).then((function(t){return n=t,r=e,(0,s.callbackToPromise)(n.createWriter.bind(n)).then((function(e){return function(e,t){return new Promise((function(n,r){t.onwrite=n,t.onerror=r,t.write(e)}))}(r,e)}));var n,r}))}},{key:"moveFile",value:function(e,t){var n,r,i,o,c,s;return u.default.async((function(l){for(;;)switch(l.prev=l.next){case 0:return l.next=2,u.default.awrap(this._openFile(e));case 2:return n=l.sent,r=d(t),i=(0,a.default)(r,2),o=i[0],c=i[1],l.next=6,u.default.awrap(this._openDir(o));case 6:return s=l.sent,l.next=9,u.default.awrap(h(n,s,c));case 9:case"end":return l.stop()}}),null,this)}},{key:"removeFile",value:function(e){var t;return u.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,u.default.awrap(this._openFile(e));case 2:return t=n.sent,n.next=5,u.default.awrap((0,s.callbackToPromise)(t.remove.bind(t)));case 5:case"end":return n.stop()}}),null,this)}},{key:"downloadFile",value:function(e,t){var n=this;return this._config.downloadFileFn?(0,s.callbackToPromise)(this._config.downloadFileFn,e,t):(0,l.get)(e,"blob").then((function(e){return n.storeFile(e,t)}))}},{key:"_openFile",value:function(e){var t,n,r,i,o,c,l=arguments;return u.default.async((function(f){for(;;)switch(f.prev=f.next){case 0:return t=l.length>1&&void 0!==l[1]&&l[1],n=d(e),r=(0,a.default)(n,2),i=r[0],o=r[1],f.next=4,u.default.awrap(this._openDir(i,t));case 4:return c=f.sent,f.abrupt("return",(0,s.callbackToPromise)(c.getFile.bind(c),o,{create:t}));case 6:case"end":return f.stop()}}),null,this)}},{key:"_openDir",value:function(e){var t,n,r,a,i=arguments;return u.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return t=i.length>1&&void 0!==i[1]&&i[1],n=e.split("/").filter((function(e){return""!==e})),o.next=4,u.default.awrap(this._getStorageDir());case 4:r=o.sent,a=0;case 6:if(!(a<n.length)){o.next=13;break}return o.next=9,u.default.awrap((0,s.callbackToPromise)(r.getDirectory.bind(r),n[a],{create:t}));case 9:r=o.sent;case 10:++a,o.next=6;break;case 13:return o.abrupt("return",r);case 14:case"end":return o.stop()}}),null,this)}},{key:"toAbsolutePath",value:function(e){return(0,c.toAbsolutePath)(c.DEFAULT_FILES_DIRECTORY,e)}},{key:"_getStorageDir",value:function(){return this._config.getStorageDirFn?(0,s.callbackToPromise)(this._config.getStorageDirFn):(null===this._storageDirPromise&&(this._storageDirPromise=(0,s.callbackToPromise)(window.webkitRequestFileSystem,window.TEMPORARY,1048576).then((function(e){return e.root}))),this._storageDirPromise)}}]),e}();function d(e){return e.split(/\/([^/]+)$/)}function p(e){return new Promise((function(t,n){var r=new FileReader;r.onload=function(e){return t(e.target.result)},r.onerror=function(e){return n(e.target.error)},r.readAsArrayBuffer(e)}))}function h(e,t,n){return new Promise((function(r,a){e.moveTo(t,n,r,a)}))}t.FileBackend=f},670:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.getFsFileName=function(e,t){return e.replace(/:/g,"_")+"@"+(null!=t&&""!==t?t.toString():"local")},t.createUnsyncedGuid=function(){return a+(0,r.getUniqueId)()},t.wasGuidSynced=function(e){return!u.test(e)},t.isSpecialAttributeName=i,t.isReadonlyAttr=o,t.objectToJson=function(e){var t=Object.keys(e).filter((function(e){return!i(e)})).reduce((function(t,n){return t[n]={value:e[n]},o(e,n)&&(t[n].readonly=!0),t}),{});return{guid:e.guid,objectType:e.$objectType,attributes:t}},t.jsonToObject=function(e){var t={guid:e.guid,$objectType:e.objectType,$readonlyAttrs:[]};for(var n in e.attributes)t[n]=e.attributes[n].value,e.attributes[n].readonly&&t.$readonlyAttrs.push(n);return t},t.toAbsolutePath=function(e,t){return e+"/"+t},t.THUMBNAIL_DIR=t.DOCUMENT_DIR=t.DEFAULT_FILES_DIRECTORY=void 0;var r=n(15);t.DEFAULT_FILES_DIRECTORY="files";t.DOCUMENT_DIR="documents";t.THUMBNAIL_DIR="thumbnails";var a="GUID:",u=new RegExp("^"+a);function i(e){return"guid"===e||"$"===e[0]}function o(e,t){return e.$readonlyAttrs.includes(t)}},671:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.QUOTE_CHAR=t.LIKE_ESCAPE_CHAR=void 0;t.LIKE_ESCAPE_CHAR="~";t.QUOTE_CHAR='"'},672:function(e,t,n){function r(e){this.fork=e}Object.defineProperty(t,"__esModule",{value:!0}),t.Task=r,r.of=function(e){return new r((function(t,n){n(e)}))},r.prototype.chain=function(e){var t=this;return new r((function(n,r){t.fork(n,(function(t){e(t).fork(n,r)}))}))},r.prototype.orElse=function(e){var t=this;return new r((function(n,r){t.fork((function(t){e(t).fork(n,r)}),r)}))},r.prototype.ap=function(e){var t,n,a,u=this,i=2;return new r((function(r,o){function c(){0==--i&&o(t(n))}function s(e){void 0===a&&r(a=e)}u.fork(s,(function(e){t=e,c()})),e.fork(s,(function(e){n=e,c()}))}))},r.prototype.map=function(e){return this.chain((function(t){return r.of(e(t))}))},r.rejected=r.prototype.rejected=function(e){return new r((function(t,n){t(e)}))},r.parallel=function(e){return new r((function(t,n){var r,a=e.length,u=new Array(e.length);0!==e.length?e.forEach((function(e,i){e.fork((function(e){void 0===r&&(r=e,t(e))}),function(e){return function(t){u[e]=t,void 0===r&&0==--a&&n(u)}}(i))})):n(u)}))},r.sequence=function(e){return e.reduce((function(e,t){return e.chain((function(e){return t}))}),r.of(null))}},673:function(e,t,n){n.r(t),n.d(t,"instantiateObjects",(function(){return o})),n.d(t,"createChange",(function(){return c}));var r=n(0),a=n(39),u=n(2),i=n(674);function o(e){return Object(r.b)(this,void 0,void 0,(function(){var t,n,o=this;return Object(r.d)(this,(function(c){switch(c.label){case 0:return t=[],n=new i.GuidMapping,[4,Promise.all(e.map((function(e){return Object(r.b)(o,void 0,void 0,(function(){var i,o;return Object(r.d)(this,(function(r){switch(r.label){case 0:return[4,Object(a.instantiate)(e.objectType,{},[])];case 1:return i=r.sent(),o=Object(u.ensure)(i.objects.find((function(e){return e.guid===i.actionResult}))),t.push(o),n.add(e.guid,o.guid),[2]}}))}))})))];case 1:return c.sent(),[2,[t,n]]}}))}))}function c(e){var t=mx.meta.getEntity(e.objectType),n=Object.keys(e.attributes).filter((function(n){return t.isSyncable(n)&&!e.attributes[n].readonly})).map((function(t){var n,r=e.attributes[t].value;return(n={})[t]={value:r},n}));return Object.assign.apply(Object,Object(r.e)([{}],n))}},674:function(e,t,n){n.r(t),n.d(t,"GuidMapping",(function(){return a}));var r=n(0),a=function(){function e(){this.guidMap={}}return e.prototype.add=function(e,t){this.guidMap[e]=t},e.prototype.map=function(e){return Array.isArray(e)?e.map(this.mapGuid.bind(this)):this.mapGuid(e)},e.prototype.mapChange=function(e,t){var n=this,a={};return Object.keys(e).forEach((function(u){var i=e[u],o=t.isObjectReference(u)&&null!=i.value?n.map(i.value):i.value;a[u]=Object(r.a)(Object(r.a)({},i),{value:o})})),a},e.prototype.mapMxObjectJSON=function(e){var t=this,n=mx.meta.getEntity(e.objectType),a={};return Object.keys(e.attributes).forEach((function(u){var i=e.attributes[u];n.isReference(u)?a[u]=Object(r.a)(Object(r.a)({},i),{value:t.map(i.value)}):a[u]=i})),Object(r.a)(Object(r.a)({},e),{guid:this.map(e.guid),attributes:a})},e.prototype.reverse=function(){var t=this,n=new e;return Object.keys(this.guidMap).forEach((function(e){return n.add(t.map(e),e)})),n},e.prototype.import=function(e){var t=this;Object.keys(e.guidMap).forEach((function(n){return t.add(n,e.guidMap[n])}))},e.prototype.mapGuid=function(e){return e in this.guidMap?this.guidMap[e]:e},e}()},676:function(e,t,n){var r=n(14);Object.defineProperty(t,"__esModule",{value:!0}),t.OfflineDataBackend=void 0;var a=r(n(143)),u=r(n(89)),i=r(n(94)),o=r(n(26)),c=r(n(27)),s=r(n(37)),l=r(n(33)),f=r(n(38)),d=n(670),p=n(15),h=n(72),m=n(18),b=n(325),v=n(53),y={String:null,Integer:"0",Long:"0",Decimal:"0",Enum:null,HashString:null,ObjectReference:null,DateTime:null,Boolean:!1,AutoNumber:"0",Binary:null},g=function(e){function t(e,n,r,a,u){var i;return(0,o.default)(this,t),(i=(0,s.default)(this,(0,l.default)(t).call(this)))._store=n,i._getDocumentUrl=u||_,i._objectCache=e,i._fileBackend=r,i._synchronizer=a,i._dirtyGuids=[],i}return(0,f.default)(t,e),(0,c.default)(t,[{key:"initialize",value:function(){var e;return i.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,i.default.awrap(this._store.fetchDirty());case 2:e=t.sent,this._dirtyGuids=e.map((function(e){return e.guid}));case 4:case"end":return t.stop()}}),null,this)}},{key:"getByGuid",value:function(e,t){var n,r,a=this;return i.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,i.default.awrap(Promise.all(e.map((function(e){return a._getByGuid(e)}))));case 2:return n=t.sent,r=n.filter((function(e){return null!=e})).map((function(e){return(0,d.objectToJson)(e)})),this._objectCache.setMxObjects(r),t.abrupt("return",{mxobjs:r.map((function(e){var t=e.guid;return a._objectCache.getObject(t)})),count:r.length});case 6:case"end":return t.stop()}}),null,this)}},{key:"getByPath",value:function(e,t,n,r){var a,o,c,s,l,f,d,p,h,m,b,v,y,g,w,j=this;return i.default.async((function(_){for(;;)switch(_.prev=_.next){case 0:if("reverse"!==r){_.next=17;break}if(a=this._objectCache.getAllObjects().filter((function(n){return n.getReferences(t).includes(e)})),!window.mx.meta.getEntity(n).isPersistable()){_.next=8;break}return _.next=5,i.default.awrap(this.getSlice(n,[{attribute:t,operator:"equals",value:e}]));case 5:_.t0=_.sent.mxobjs,_.next=9;break;case 8:_.t0=[];case 9:return o=_.t0,c=o.filter((function(n){return n.getReferences(t).includes(e)})),s=c.filter((function(e){return!a.some((function(t){return t.getGuid()===e.getGuid()}))})),this._objectCache.setMxObjects(s.map((function(e){return e.jsonData}))),l=a.concat(s),_.abrupt("return",{mxobjs:l,count:l.length});case 17:if(f=this._objectCache.getObject(e)){_.next=25;break}return _.next=21,i.default.awrap(this.getByGuid([e]));case 21:d=_.sent,p=(0,u.default)(d.mxobjs,1),(h=p[0])&&(f=h);case 25:if(f){_.next=27;break}return _.abrupt("return",{mxobjs:[],count:0});case 27:return m=f.getReferences(t),b=m.map((function(e){return j._objectCache.getObject(e)})).filter((function(e){return null!==e})),v=m.filter((function(e){return!j._objectCache.has(e)})),_.next=32,i.default.awrap(this.getByGuid(v));case 32:return y=_.sent,g=y.mxobjs,w=g.concat(b),this._objectCache.setMxObjects(g.map((function(e){return e.jsonData}))),_.abrupt("return",{mxobjs:w,count:w.length});case 37:case"end":return _.stop()}}),null,this)}},{key:"getSlice",value:function(e,t,n,r){var a,o,c,s,l,f,p,h,b=this;return i.default.async((function(v){for(;;)switch(v.prev=v.next){case 0:return a=window.mx.meta.getEntity(e),o=(t||[]).map((function(e){return e.attribute&&a.isReference(e.attribute)&&(e.value=b._synchronizer.getInternalGuid(e.value)),e})),v.next=4,i.default.awrap(this._store.getSlice(e,o,n));case 4:return c=v.sent,s=(0,u.default)(c,2),l=s[0],f=s[1],p=l.map(this._synchronizer.makeObjectExternal,this._synchronizer).map(d.objectToJson),h=[],r?(this._objectCache.setMxObjects(p),h=p.map((function(e){return b._objectCache.getObject(e.guid)}))):h=p.map(m.MxObject.fromJson),v.abrupt("return",{mxobjs:h,count:f});case 12:case"end":return v.stop()}}),null,this)}},{key:"create",value:function(e){var t=(0,d.createUnsyncedGuid)();return this._objectCache.onCreate([t]),this._objectCache.setMxObjects([j(t,e)]),Promise.resolve(this._objectCache.getObject(t))}},{key:"commit",value:function(e,t){var n,r,o,c,s,l,f,h,m,b,v,y,g,j,_,O,T,x=this;return i.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:return T=function(e){var t={};return Object.keys(e).forEach((function(n){t[n]=Object.keys(e[n])})),t},O=function(e){return Object.assign({},e,(0,p.mapObject)(n[e.guid],(function(e){return e.value})))},n=(0,p.objectFromArray)(e.map((function(e){return[e,x._objectCache.getChanges(e)]}))),r=(0,p.partition)((function(e){return x._objectCache.has(e)}),e),o=(0,u.default)(r,2),c=o[0],s=o[1],l=c.map((function(e){return x._objectCache.getObject(e)})),f=(0,p.partition)((function(e){return e.isPersistable()}),l),h=(0,u.default)(f,2),m=h[0],b=h[1],v=m.map(w),t.next=9,i.default.awrap(Promise.all(s.map((function(e){return x._getByGuid(e)}))));case 9:if(y=t.sent,!((g=y.concat(v).map(O)).length>0)){t.next=16;break}return t.next=14,i.default.awrap(this._store.insertOrReplace(g.map(this._synchronizer.makeObjectInternal,this._synchronizer)));case 14:(j=this._dirtyGuids).push.apply(j,(0,a.default)(g.map((function(e){return e.guid})))),this._objectCache.setMxObjects(g.map((function(e){return(0,d.objectToJson)(e)})));case 16:return _=b.map(w).map(O),this._objectCache.setMxObjects(_.map((function(e){return(0,d.objectToJson)(e)}))),this._objectCache.onCommit(e),this._objectCache.removeChanges(T(n)),t.abrupt("return",{});case 21:case"end":return t.stop()}}),null,this)}},{key:"rollback",value:function(e){var t=this;this._objectCache.removeAllChanges(e);var n=e.filter((function(e){return t._objectCache.isNew(e)}));return this._objectCache.removeObjects(n),Promise.resolve({})}},{key:"validate",value:function(e){return Promise.resolve({})}},{key:"saveDocument",value:function(e,t,n,r){var a,u;return i.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(r.size/1048576>n.maxFileSize)){t.next=2;break}throw new h.DescribedError("File too large");case 2:return t.next=4,i.default.awrap(this._getByGuid(e));case 4:return a=t.sent,u=(0,d.getFsFileName)(this._synchronizer.getInternalGuid(e),a?a.changedDate:void 0),t.next=8,i.default.awrap(this._fileBackend.storeFile(r,this._fileBackend.toAbsolutePath(d.DOCUMENT_DIR+"/"+u)));case 8:return this._objectCache.makeChange(e,"HasContents",!0),t.next=11,i.default.awrap(this.commit([e],null));case 11:case"end":return t.stop()}}),null,this)}},{key:"getDocumentUrl",value:function(e,t,n){return this._getDocumentUrl((0,d.getFsFileName)(this._synchronizer.getInternalGuid(e),t),t,n)}},{key:"getImageUrl",value:function(e){return Promise.resolve(e)}},{key:"upload",value:function(){return this._synchronizer.upload()}},{key:"download",value:function(e){var t;return i.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,i.default.awrap(this._synchronizer.download(e));case 2:return t=n.sent,this._dirtyGuids=[],n.next=6,i.default.awrap(v.publish.apply(void 0,(0,a.default)(t)));case 6:case"end":return n.stop()}}),null,this)}},{key:"cleanupDirtyObjects",value:function(){return this._store.cleanupDirtyObjects()}},{key:"isDirty",value:function(e){return this._dirtyGuids.includes(e)}},{key:"cleanup",value:function(){return i.default.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.default.awrap(this._store.cleanDatabase());case 2:return e.next=4,i.default.awrap(this._fileBackend.removeDir(this._fileBackend.toAbsolutePath(d.DOCUMENT_DIR)));case 4:return e.next=6,i.default.awrap(this._fileBackend.removeDir(this._fileBackend.toAbsolutePath(d.THUMBNAIL_DIR)));case 6:this._dirtyGuids=[];case 7:case"end":return e.stop()}}),null,this)}},{key:"_getByGuid",value:function(e){var t=this;return this._store.getByGuid(this._synchronizer.getInternalGuid(e)).then((function(e){return t._synchronizer.makeObjectExternal(e)}))}}]),t}(b._DataBackend);function w(e){return(0,d.jsonToObject)(e.jsonData)}function j(e,t){var n={guid:e,objectType:t,attributes:{}},r=window.mx.meta.getEntity(t);return r.getAttributes().forEach((function(e){n.attributes[e]={value:y[r.getAttributeType(e)],readonly:r.isAttributeReadonly(e)}})),n}function _(e,t,n){var r=d.DEFAULT_FILES_DIRECTORY+"/"+(n?"thumbnails":"documents");return"filesystem:".concat(window.mx.appUrl,"temporary/").concat(r,"/").concat(e,"?").concat(Date.now())}t.OfflineDataBackend=g},677:function(e,t,n){var r=n(128),a=n(14);Object.defineProperty(t,"__esModule",{value:!0}),t.SqlStore=void 0;var u=a(n(94)),i=a(n(26)),o=a(n(27)),c=r(n(678)),s=n(684),l=n(685),f=function(){function e(t,n){(0,i.default)(this,e),this._tableNames=t;var r=c.createCreateTransaction(this._tableNames);this._databasePromise=(0,l.promiseFromTask)((0,s.runWriteTransaction)(n,r)).then((function(){return n}))}return(0,o.default)(e,[{key:"getByGuid",value:function(e){var t,n;return u.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,u.default.awrap(this._databasePromise);case 2:return t=r.sent,n=c.createFetchByGuidTransaction(e),r.abrupt("return",(0,l.promiseFromTask)((0,s.runReadTransaction)(t,n)));case 5:case"end":return r.stop()}}),null,this)}},{key:"getSlice",value:function(e,t){var n,r,a,i=arguments;return u.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return n=i.length>2&&void 0!==i[2]?i[2]:{},o.next=3,u.default.awrap(this._databasePromise);case 3:return r=o.sent,a=c.createFetchSliceTransaction(e,t,n.offset,n.limit,n.sort),o.abrupt("return",(0,l.promiseFromTask)((0,s.runReadTransaction)(r,a)));case 6:case"end":return o.stop()}}),null,this)}},{key:"rebuildDatabase",value:function(e){var t,n;return u.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,u.default.awrap(this._databasePromise);case 2:return t=r.sent,n=c.createRebuildTransaction(this._tableNames,e),r.abrupt("return",(0,l.promiseFromTask)((0,s.runWriteTransaction)(t,n)));case 5:case"end":return r.stop()}}),null,this)}},{key:"insertOrReplace",value:function(e){var t,n;return u.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,u.default.awrap(this._databasePromise);case 2:return t=r.sent,n=c.createInsertOrReplaceTransaction(e),r.abrupt("return",(0,l.promiseFromTask)((0,s.runWriteTransaction)(t,n)));case 5:case"end":return r.stop()}}),null,this)}},{key:"cleanDatabase",value:function(){var e,t;return u.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,u.default.awrap(this._databasePromise);case 2:return e=n.sent,t=c.createCleanTransaction(this._tableNames),n.abrupt("return",(0,l.promiseFromTask)((0,s.runWriteTransaction)(e,t)));case 5:case"end":return n.stop()}}),null,this)}},{key:"fetchDirty",value:function(){var e,t;return u.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,u.default.awrap(this._databasePromise);case 2:return e=n.sent,t=c.createFetchDirtyObjectsTransaction(),n.abrupt("return",(0,l.promiseFromTask)((0,s.runReadTransaction)(e,t)));case 5:case"end":return n.stop()}}),null,this)}},{key:"makeClean",value:function(e){var t,n;return u.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,u.default.awrap(this._databasePromise);case 2:return t=r.sent,n=c.createMakeCleanTransaction(e),r.abrupt("return",(0,l.promiseFromTask)((0,s.runWriteTransaction)(t,n)));case 5:case"end":return r.stop()}}),null,this)}},{key:"cleanupDirtyObjects",value:function(){var e,t;return u.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,u.default.awrap(this._databasePromise);case 2:return e=n.sent,t=c.createDirtyCleanupTransaction(),n.abrupt("return",(0,l.promiseFromTask)((0,s.runWriteTransaction)(e,t)));case 5:case"end":return n.stop()}}),null,this)}}]),e}();t.SqlStore=f},678:function(e,t,n){var r=n(14);Object.defineProperty(t,"__esModule",{value:!0}),t.createCleanTransaction=function(e){var t=[f].concat(e).map(x).map((function(e){return"DELETE FROM '".concat(e,"'")})).map((function(e){return S(e,[])}));return l.TaskReader.parallel(t).map((function(e){}))},t.createFetchByGuidTransaction=function(e){return S((new a.SqlSelectBuilder).from(f).where(a.constraintBuilder.equals("guid")).select(),[e]).chain((function(t){if(0===t.rows.length)return l.TaskReader.of(null);if(1!==t.rows.length)return l.TaskReader.rejected(new Error("db consistency error"));var n=t.rows.item(0),r=n.tableName,u=Boolean(n.dirty),i=n.readonlyAttrs;return S((new a.SqlSelectBuilder).from(x(r)).where(a.constraintBuilder.equals("guid")).select(),[e]).chain((function(e){return 0===e.rows.length?l.TaskReader.rejected(new Error("entity not found")):1!==e.rows.length?l.TaskReader.rejected(new Error("db consistency error")):l.TaskReader.of(E(window.mx.meta.getEntity(r),u,i,e.rows.item(0)))}))}))},t.createFetchSliceTransaction=function(e,t,n,r,u){t=t||[],u=u||[];var i=window.mx.meta.getEntity(e),o=function(e,t){var n=[];return{builder:(new a.SqlSelectBuilder).where(t.map((function t(r){if(r.constraints)return a.constraintBuilder[r.operator](r.constraints.map(t).filter((function(e){return null!==e})));if(null==r.value)switch(r.operator){case"contains":return null;case"equals":return a.constraintBuilder.isNull(x(r.attribute),r.negate)}var u=e.getAttributeType(r.attribute),i=m[u],o=(0,p[u])(i(r.value));return n.push("contains"===r.operator?T(o):o),a.constraintBuilder[r.operator](x(r.attribute),r.negate)})).filter((function(e){return null!==e}))),args:n}}(i,t),c=o.builder.from(x(e)),s=o.args,d=c.offset(n).limit(r).join(f,"guid",["dirty","readonlyAttrs"]),h=S((d=u.reduce((function(e,t){return e.order(t[0],t[1])}),d)).select(),s).map((function(e){for(var t=[],n=0;n<e.rows.length;++n){var r=e.rows.item(n),a=Boolean(r["".concat(f,".dirty")]),u=R(r,"readonlyAttrs");t.push(E(i,a,u,r))}return t})),b=S(c.selectCount("cnt"),s).map((function(e){return e.rows.item(0).cnt}));return l.TaskReader.parallel([h,b])},t.createInsertOrReplaceTransaction=function(e){return l.TaskReader.parallel(e.map((function(e){var t=e.$objectType,n=y(),r=g(t,e);return[S(n.insertOrReplace(),[e.guid,t,1,JSON.stringify(e.$readonlyAttrs)]),S(r.builder.insertOrReplace(),r.values)]})).reduce((function(e,t){return e.concat(t)}),[])).map((function(e){}))},t.createFetchDirtyObjectsTransaction=function(){return v().chain((function(e){var t=O(e.rows).map((function(e){var t=e.tableName,n=(new a.SqlSelectBuilder).from(x(t)).join(f,"guid",["dirty","readonlyAttrs"]).where(a.constraintBuilder.equals("".concat(f,".dirty"))).select(),r=window.mx.meta.getEntity(t);return S(n,[1]).map((function(e){return O(e.rows).map((function(e){return E(r,!0,R(e,"readonlyAttrs"),e)}))}))}));return l.TaskReader.parallel(t)})).map((function(e){return e.reduce((function(e,t){return e.concat(t)}),[])}))},t.createMakeCleanTransaction=function(e){var t=e.map((function(e){return S("UPDATE ".concat(f," set dirty = 0 where guid = ?"),[e.guid])}));return l.TaskReader.parallel(t).map((function(e){}))},t.createDirtyCleanupTransaction=function(){return v().chain((function(e){var t=O(e.rows).map((function(e){var t=e.tableName;return S("DELETE FROM ".concat(x(t)," WHERE guid IN (\n                            SELECT guid FROM ").concat(f," WHERE tableName = ? AND dirty = 1)"),[t])}));return l.TaskReader.sequence([l.TaskReader.parallel(t),S("DELETE FROM ".concat(f," WHERE dirty = 1"))]).map((function(e){}))}))},t.createRebuildTransaction=function(e,t){var n=function(e){var t=[f].concat(e).map(x).map((function(e){return"DROP TABLE IF EXISTS '"+e+"'"})).map((function(e){return S(e,[])}));return l.TaskReader.sequence([l.TaskReader.parallel(t),b(e)])}(e),r=e.map((function(e){var n=t.filter((function(t){return t.$objectType===e}));return function(e,t){var n=t.reduce((function(t,n){var r=y(),a=g(e,n);return t.concat([S(r.insert(),[n.guid,e,0,JSON.stringify(n.$readonlyAttrs)]),S(a.builder.insert(),a.values)])}),[]);return l.TaskReader.parallel(n).map((function(e){}))}(e,n)}));return l.TaskReader.sequence([n,l.TaskReader.parallel(r)]).map((function(e){}))},t.createCreateTransaction=b;var a=n(679),u=r(n(6)),i=n(671),o=n(680),c=n(681),s=n(672),l=n(682),f="_guidToTable",d={String:"text",Integer:"text",Long:"text",Decimal:"text",Enum:"text",HashString:"text",ObjectReference:"text",DateTime:"integer",Boolean:"integer",AutoNumber:"integer",Binary:"blob"},p={String:j,Integer:w,Long:w,Decimal:w,Enum:j,HashString:j,ObjectReference:j,DateTime:function(e){return null!=e?Number(e):null},Boolean:Number,AutoNumber:j,Binary:j},h={String:j,Integer:j,Long:j,Decimal:j,Enum:j,HashString:j,ObjectReference:j,DateTime:_,Boolean:Boolean,AutoNumber:j,Binary:j},m={String:_,Integer:_,Long:_,Decimal:_,Enum:_,HashString:_,ObjectReference:_,DateTime:function(e){return e?Number(e):null},Boolean:function(e){return"false"!==e},AutoNumber:_,Binary:_};function b(e){var t,n=[(t=(new o.SqlCreateBuilder).table(f).primaryKeyColumn("guid","text").column("tableName","text").column("dirty","boolean").column("readonlyAttrs","text").createIfNotExists(),S(t,[]))].concat(e.map((function(e){return S(function(e){var t=window.mx.meta.getEntity(e);return t.getAttributes().map((function(e){var n=t.getAttributeType(e);return{attr:e,type:d[n]}}))}(e).reduce((function(e,t){return e.column(x(t.attr),t.type)}),(new o.SqlCreateBuilder).table(x(e)).primaryKeyColumn("guid","text")).createIfNotExists(),[])})));return l.TaskReader.parallel(n).map((function(e){}))}function v(){return S((new a.SqlSelectBuilder).from(f).where(a.constraintBuilder.equals("dirty")).selectDistinct("tableName"),[1])}function y(){return(new c.SqlInsertBuilder).into(f).column("guid").column("tableName").column("dirty").column("readonlyAttrs")}function g(e,t){var n=window.mx.meta.getEntity(e),r=n.getAttributes().reduce((function(e,r){var a=n.getAttributeType(r),u=p[a];if(!u)return e;var i=u(t[r]);return{attrs:e.attrs.concat([r]),values:e.values.concat([i])}}),{attrs:["guid"],values:[t.guid]});return{builder:r.attrs.reduce((function(e,t){return e.column(x(t))}),(new c.SqlInsertBuilder).into(x(e))),values:r.values}}function w(e){if(null==e)return null;var t=new u.default(e),n=20-Math.max(0,t.e)-1;return(t.s<0?"-":"")+new Array(n+1).join("0")+t.abs().toFixed()}function j(e){return null!=e?String(e):null}function _(e){return e}function O(e){for(var t=[],n=0;n<e.length;++n)t.push(e.item(n));return t}function T(e){var t=i.LIKE_ESCAPE_CHAR;return e.replace(new RegExp(t,"g"),t+t).replace(/%/g,t+"%").replace(/_/g,t+"_")}function x(e){return e.replace(".","$")}function k(e){return e.replace("$",".")}function E(e,t,n,r){var a,u={guid:r.guid,$objectType:e.getEntity(),$dirty:t,$readonlyAttrs:JSON.parse(n)};for(var i in r)if(!("guid"===(a=i)||a.indexOf(".")>-1)){var o=k(i),c=e.getAttributeType(o),s=h[c];s&&(u[o]=s(r[i]))}return u}function R(e,t){return e["".concat(f,".").concat(t)]}function S(e,t){return t=t||[],new l.TaskReader((function(n){return new s.Task((function(r,a){n.executeSql(e,t,(function(e,t){return a(t)}),(function(e,t){return r(t)}))}))}))}},679:function(e,t,n){var r=n(14);Object.defineProperty(t,"__esModule",{value:!0}),t.constraintBuilder=t.SqlSelectBuilder=void 0;var a=r(n(26)),u=r(n(27)),i=n(671),o=function(){function e(t,n){(0,a.default)(this,e),this._select=n&&n.select||t&&t._select||null,this._from=n&&n.from||t&&t._from||null,this._join=n&&n.join||t&&t._join||null,this._constraints=n&&n.constraints||t&&t._constraints||[],this._orderBy=n&&n.orderBy||t&&t._orderBy||[],this._limit=n&&n.limit||t&&t._limit||null,this._offset=n&&n.offset||t&&t._offset||null}return(0,u.default)(e,[{key:"from",value:function(t){return new e(this,{from:t})}},{key:"join",value:function(t,n,r){return new e(this,{join:{tableName:t,joinOnColumn:n,selectedColumns:r}})}},{key:"where",value:function(t){return new e(this,{constraints:this._constraints.concat(t)})}},{key:"order",value:function(t,n){return new e(this,{orderBy:this._orderBy.concat([[t,n]])})}},{key:"limit",value:function(t){return new e(this,{limit:t})}},{key:"offset",value:function(t){return new e(this,{offset:t})}},{key:"selectDistinct",value:function(e){return Array.isArray(e)&&(e=e.join(", ")),"SELECT DISTINCT ".concat(e," ").concat(this._buildSql())}},{key:"selectCount",value:function(e){return"SELECT COUNT(*) AS ".concat(e)+this._buildSql()}},{key:"select",value:function(){var e=this,t="SELECT ".concat(this._from,".*");return this._join&&this._join.selectedColumns.forEach((function(n){t+=", ".concat(e._join.tableName,".[").concat(n,'] as "').concat(e._join.tableName,".").concat(n,'"')})),t+this._buildSql()}},{key:"_buildSql",value:function(){var e=this,t=" FROM ".concat(this._from," AS ").concat(this._from);return this._join&&(t+=" JOIN ".concat(this._join.tableName," AS ").concat(this._join.tableName," USING (").concat(this._join.joinOnColumn,")")),this._constraints.length>0&&(t+=" WHERE "+this._constraints.map((function(t){return t.build(e._from)})).join(" AND ")),this._orderBy.length>0&&(t+=" ORDER BY "+this._orderBy.map((function(t){return"".concat(e._from,".[").concat(t[0],"] ").concat(t[1])})).join(", ")),this._limit&&(t+=" LIMIT "+this._limit),this._offset&&(t+=" OFFSET "+this._offset),t}}]),e}();t.SqlSelectBuilder=o;var c={equals:p("="),lessThan:p("<"),lessThanOrEquals:p("<="),greaterThan:p(">"),greaterThanOrEquals:p(">="),contains:function(e){var t="";return t+=e,t+=" LIKE '%' || ? || '%'",t+=" ESCAPE '"+i.LIKE_ESCAPE_CHAR+"'"}},s=function(){function e(t,n,r){(0,a.default)(this,e),this._column=t,this._operator=n,this._negate=!!r}return(0,u.default)(e,[{key:"build",value:function(e){var t=c[this._operator],n=this._column.indexOf(".")>-1?this._column:"".concat(e,".[").concat(this._column,"]");return(this._negate?"NOT ":"")+t(n)}}]),e}(),l=function(){function e(t,n){(0,a.default)(this,e),this._column=t,this._negate=!!n}return(0,u.default)(e,[{key:"build",value:function(e){return(this._column.indexOf(".")>-1?this._column:"".concat(e,".[").concat(this._column,"]"))+" IS "+(this._negate?"NOT ":"")+"NULL"}}]),e}(),f=function(){function e(t,n){(0,a.default)(this,e),this.group=t,this.constraints=n||[]}return(0,u.default)(e,[{key:"add",value:function(e){this.constraints.push(e)}},{key:"build",value:function(e){return"("+this.constraints.map((function(t){return t.build(e)})).join(" ".concat(this.group," "))+")"}}]),e}(),d={and:function(e){return new f("and",e)},or:function(e){return new f("or",e)},equals:function(e,t){return new s(e,"equals",t)},isNull:function(e,t){return new l(e,t)},lessThan:function(e,t){return new s(e,"lessThan",t)},lessThanOrEquals:function(e,t){return new s(e,"lessThanOrEquals",t)},greaterThan:function(e,t){return new s(e,"greaterThan",t)},greaterThanOrEquals:function(e,t){return new s(e,"greaterThanOrEquals",t)},contains:function(e,t){return new s(e,"contains",t)}};function p(e){return function(t){return t+" "+e+" ?"}}t.constraintBuilder=d},680:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.SqlCreateBuilder=a;var r=n(671);function a(e,t){this._tableName=t&&t.tableName||e&&e._tableName||null,this._columns=t&&t.columns||e&&e._columns||[]}function u(e){var t=r.QUOTE_CHAR;return t+e+t}a.prototype.table=function(e){return new a(this,{tableName:e})},a.prototype.column=function(e,t){return new a(this,{columns:this._columns.concat({columnName:e,columnType:t,isPrimary:!1})})},a.prototype.primaryKeyColumn=function(e,t){return new a(this,{columns:this._columns.concat({columnName:e,columnType:t,isPrimary:!0})})},a.prototype.createIfNotExists=function(){var e="";return e+="CREATE TABLE IF NOT EXISTS "+u(this._tableName),e+=this._buildSql()},a.prototype._buildSql=function(){var e="";return this._columns.length>0&&(e+=" (",e+=this._columns.map((function(e){return[u(e.columnName),e.columnType,"text"===e.columnType?" COLLATE NOCASE ":"",e.isPrimary?"PRIMARY KEY ":""].join(" ").slice(0,-1)}),this).join(", "),e+=")"),e}},681:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.SqlInsertBuilder=a;var r=n(671);function a(e,t){if(!(this instanceof a))return new a;this._tableName=t&&t.tableName||e&&e._tableName||null,this._columnNames=t&&t.columnNames||e&&e._columnNames||[]}function u(e){var t=r.QUOTE_CHAR;return t+e+t}a.prototype.into=function(e){return new a(this,{tableName:e})},a.prototype.column=function(e){return new a(this,{columnNames:this._columnNames.concat(e)})},a.prototype.insert=function(){var e="";return e+="INSERT INTO "+u(this._tableName),e+=this._buildSql()},a.prototype.insertOrReplace=function(){var e="";return e+="INSERT OR REPLACE INTO "+u(this._tableName),e+=this._buildSql()},a.prototype._buildSql=function(){var e="";return this._columnNames.length>0&&(e+=" (",e+=this._columnNames.map(u).join(", "),e+=")"),e+=" VALUES (",e+="?"+new Array(this._columnNames.length).join(", ?"),e+=")"}},682:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.TaskReader=void 0;var r=n(683),a=n(672),u=new r.ReaderT(a.Task);t.TaskReader=u,u.rejected=function(e){return new u((function(t){return a.Task.rejected(e)}))},u.parallel=function(e){return new u((function(t){return new a.Task((function(n,r){if(0!==e.length){var a=new Array(e.length),u=e.length,i=!1;e.forEach((function(e,o){e.run(t).fork((function(e){i||(i=!0,n(e))}),(function(e){a[o]=e,i||0!=--u||r(a)}))}))}else r([])}))}))},u.sequence=function(e){return e.reduce((function(e,t){return e.chain((function(e){return t.map((function(t){return e.concat([t])}))}))}),u.of([]))}},683:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.ReaderT=function(e){function t(e){this.run=e}return t.prototype.chain=function(e){return new t(function(t){return this.run(t).chain((function(n){return e(n).run(t)}))}.bind(this))},t.prototype.ap=function(e){return new t(function(t){return this.run(t).ap(e.run(t))}.bind(this))},t.prototype.map=function(e){return this.chain((function(n){return t.of(e(n))}))},t.of=function(n){return new t((function(t){return e.of(n)}))},t.ask=function(){return new t(e.of)},t}},684:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.runWriteTransaction=t.runReadTransaction=void 0;var r=n(672),a=i("readTransaction");t.runReadTransaction=a;var u=i("transaction");function i(e){return function(t,n){return new r.Task((function(r,a){var u,i=2;t[e]((function(e){n.run(e).fork(r,(function(e){u=e,0==--i&&a(u)}))}),r,(function(){0==--i&&a(u)}))}))}}t.runWriteTransaction=u},685:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.promiseFromTask=function(e){return new Promise((function(t,n){e.fork(n,t)}))}},686:function(e,t,n){var r=n(14);Object.defineProperty(t,"__esModule",{value:!0}),t.Synchronizer=void 0;var a=r(n(143)),u=r(n(89)),i=r(n(94)),o=r(n(26)),c=r(n(27)),s=n(670),l=n(15),f=n(673),d=n(39),p=n(304),h=n(674),m=n(309),b=n(58),v=n(77),y=function(){function e(t,n,r){(0,o.default)(this,e),this._store=t,this._fileBackend=n,this._objectCache=r,this._internalToExternal=new h.GuidMapping}return(0,c.default)(e,[{key:"upload",value:function(){return i.default.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,i.default.awrap(this._upload());case 3:e.next=13;break;case 5:if(e.prev=5,e.t0=e.catch(0),window.mx.logger.warn(e.t0),e.t0 instanceof p.DanglingError){e.next=12;break}throw new m.SynchronizationError;case 12:throw e.t0;case 13:case"end":return e.stop()}}),null,this,[[0,5]])}},{key:"download",value:function(e){return i.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,i.default.awrap(this._download(e));case 3:return t.abrupt("return",t.sent);case 6:throw t.prev=6,t.t0=t.catch(0),window.mx.logger.warn(t.t0),new m.SynchronizationError;case 10:case"end":return t.stop()}}),null,this,[[0,6]])}},{key:"_upload",value:function(){var e,t,n,r,a,o,c,h,m,b,v,y,g,w,j,_,O,T,x,k=this;return i.default.async((function(E){for(;;)switch(E.prev=E.next){case 0:return x=function(e){return window.mx.meta.getEntity(e.$objectType).isA("System.FileDocument")&&e.HasContents},T=function(e){var t=window.mx.meta.getEntity(e.$objectType);return(0,l.arrayFromObject)(e).filter((function(e){var n=(0,u.default)(e,2),r=n[0];n[1];return"guid"===r||!(0,s.isSpecialAttributeName)(r)&&t.isReference(r)}))},O=function(e){var t=e.map((function(e){return e.guid})),n=(0,l.unique)(e.map((function(e){return T(e).map((function(e){var t=(0,u.default)(e,2);t[0];return t[1]}))})).reduce((function(e,t){return e.concat(t)}),[])).filter((function(e){return!(0,s.wasGuidSynced)(e)})).filter((function(e){return!t.includes(e)}));if(n.length>0){var r=(0,l.unique)(e.map((function(e){return T(e).filter((function(e){var t=(0,u.default)(e,2),r=(t[0],t[1]);return n.includes(r)})).map((function(t){var n=(0,u.default)(t,2),r=n[0];n[1];return"object of type ".concat(e.$objectType," (reference ").concat(r,")")}))})).reduce((function(e,t){return e.concat(t)}),[])).join(", "),a="Sync has failed due to a modeling error. Your database contains objects that reference uncommitted objects:\n".concat(r,".");throw new p.DanglingError(a)}},E.next=5,i.default.awrap(this._store.fetchDirty());case 5:if(0!==(e=E.sent).length){E.next=8;break}return E.abrupt("return",{});case 8:return O(e),t=(0,l.partition)((function(e){return(0,s.wasGuidSynced)(e.guid)}),e),n=(0,u.default)(t,2),r=n[0],a=n[1],o=e.filter(x),E.next=13,i.default.awrap(Promise.all([Promise.all(o.map((function(e){return k._tempUploadFile(e)}))),(0,f.instantiateObjects)(a.map(s.objectToJson))]));case 13:return c=E.sent,h=(0,u.default)(c,2),m=h[0],b=(0,u.default)(h[1],2),v=b[0],y=b[1],g=(0,l.objectFromArray)(m.map((function(e){var t=e.tempGuid,n=e.fileObjGuid;return(0,s.wasGuidSynced)(n)?[t,n]:[t,y.map(n)]}))),w=r.map((function(e){return e.guid})).concat(v.map((function(e){return e.guid}))),j={},e.forEach((function(e){var t=(0,s.objectToJson)(e),n=(0,f.createChange)(t),r=window.mx.meta.getEntity(t.objectType),a=y.mapChange(n,r),u=y.map(t.guid);j[u]=a})),E.next=25,i.default.awrap((0,d.synchronize)(w,g,j,v));case 25:return _=E.sent,E.next=28,i.default.awrap(this._store.makeClean(e));case 28:return E.next=30,i.default.awrap(Promise.all(o.map((function(e){var t,n,r,a,u;return i.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return t=y.map(e.guid),n=_.fileChangedDates[t],r=k._fileBackend.toAbsolutePath(s.DOCUMENT_DIR+"/"),a=r+(0,s.getFsFileName)(e.guid,e.changedDate),u=r+(0,s.getFsFileName)(t,n),o.next=7,i.default.awrap(k._fileBackend.moveFile(a,u));case 7:case"end":return o.stop()}}))}))));case 30:return this._internalToExternal.import(y.reverse()),E.abrupt("return",{});case 32:case"end":return E.stop()}}),null,this)}},{key:"_download",value:function(e){var t,n,r,o,c,f,p,h,m,b,v,y,g,w,j,_,O=this;return i.default.async((function(T){for(;;)switch(T.prev=T.next){case 0:return _=function(e,t,n){var r;return i.default.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.default.awrap((0,d.retrieveByXPath)(n));case 2:return r=e.sent,e.abrupt("return",r.resultGuids.map((function(e){return r.objects.find((function(t){return t.guid===e}))})).map(s.jsonToObject).map((function(e){return Object.assign({},e,{$objectType:t})})));case 4:case"end":return e.stop()}}))},T.t0=l.flatten,T.next=4,i.default.awrap(Promise.all(e.map((function(e){var t=e.store,n=e.xpath;return _(O._objectCache,t,n)}))));case 4:return T.t1=T.sent,t=(0,T.t0)(T.t1),T.next=8,i.default.awrap(this._computeFilesToDownloadAndDelete(t,!1));case 8:return n=T.sent,r=(0,u.default)(n,2),o=r[0],c=r[1],T.next=14,i.default.awrap(this._computeFilesToDownloadAndDelete(t,!0));case 14:return f=T.sent,p=(0,u.default)(f,2),h=p[0],m=p[1],T.next=20,i.default.awrap(Promise.all(o.concat(h).map((function(e){var t=e.source,n=e.destination;return O._fileBackend.downloadFile(t,n)}))));case 20:return T.next=22,i.default.awrap(this._store.rebuildDatabase(t));case 22:return Promise.all(c.concat(m).map((function(e){return O._fileBackend.removeFile(e)}))).catch(window.mx.onError),b=t.map(this.makeObjectExternal,this),v=this._objectCache.getAllObjects().filter((function(e){return e.isPersistable()&&!O._objectCache.isNew(e.getGuid())})).map((function(e){return[b.find((function(t){return t.guid===e.getGuid()})),e]})),y=(0,l.partition)((function(e){return void 0!==(0,u.default)(e,1)[0]}),v),g=(0,u.default)(y,2),w=g[0],j=g[1],this._objectCache.setMxObjects(w.map((function(e){var t=(0,u.default)(e,1)[0];return(0,s.objectToJson)(t)}))),this._objectCache.onDelete(j.map((function(e){var t=(0,u.default)(e,2);t[0];return t[1].getGuid()}))),T.abrupt("return",[].concat((0,a.default)(e.map((function(e){return{entity:e.store}}))),(0,a.default)(w.map((function(e){return{guid:(0,u.default)(e,1)[0].guid}}))),(0,a.default)(j.map((function(e){var t=(0,u.default)(e,2);t[0];return{guid:t[1].getGuid()}})))));case 29:case"end":return T.stop()}}),null,this)}},{key:"getInternalGuid",value:function(e){return this._internalToExternal.reverse().map(e)}},{key:"makeObjectExternal",value:function(e){var t=this;return g(e,(function(e){return t._internalToExternal.map(e)}))}},{key:"makeObjectInternal",value:function(e){var t=this;return g(e,(function(e){return t.getInternalGuid(e)}))}},{key:"_tempUploadFile",value:function(e){var t,n,r;return i.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return t=s.DOCUMENT_DIR+"/"+(0,s.getFsFileName)(e.guid,e.changedDate),a.next=3,i.default.awrap(this._fileBackend.readFile(this._fileBackend.toAbsolutePath(t)));case 3:return n=a.sent,a.next=6,i.default.awrap((0,v.uploadWithRetries)("__sync__","",n,2));case 6:return r=a.sent,a.abrupt("return",{tempGuid:r.commits[0],fileObjGuid:e.guid});case 8:case"end":return a.stop()}}),null,this)}},{key:"_computeFilesToDownloadAndDelete",value:function(e,t){var n,r,a,u,o;return i.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:return n=this._fileBackend.toAbsolutePath(t?s.THUMBNAIL_DIR:s.DOCUMENT_DIR)+"/",r=e.filter((function(e){return window.mx.meta.getEntity(e.$objectType).isA(t?"System.Image":"System.FileDocument")})).filter((function(e){return e.HasContents})).map((function(e){return{source:(0,b.getRemoteDynamicResourceUrl)(e.guid,e.changedDate,t),destination:n+(0,s.getFsFileName)(e.guid,e.changedDate)}})),c.next=4,i.default.awrap(this._fileBackend.listDir(n));case 4:return c.t0=function(e){return n+e},a=c.sent.map(c.t0),u=r.filter((function(e){return!a.includes(e.destination)})),o=a.filter((function(e){return!r.find((function(t){return t.destination===e}))})),c.abrupt("return",[u,o]);case 9:case"end":return c.stop()}}),null,this)}}]),e}();function g(e,t){if(null===e)return null;var n=window.mx.meta.getEntity(e.$objectType);return(0,l.mapObject)(e,(function(e,r){return("guid"===r||!(0,s.isSpecialAttributeName)(r)&&n.isReference(r))&&null!=e?t(e):e}))}t.Synchronizer=y},697:function(e,t,n){n.r(t);var r=n(0),a=n(2),u=n(8),i=20,o="_guidToTable",c="guid",s="readonlyAttrs",l=[c,s],f="%",d="_",p=n(6);function h(e){return e.replace(".","$")}function m(e){if(void 0===e)return null;if(e instanceof p.Big)return t=e,n=i-Math.max(0,t.e)-1,r=t.s<0?"-":"",a=new Array(n+1).join("0"),o=t.abs().toFixed(),r+a+o;if(e instanceof Date)return function(e){return Number(e)}(e);if("boolean"==typeof e)return function(e){return e?1:0}(e);if(Array.isArray(e))throw new u.AssertionError;return e;var t,n,r,a,o}function b(e,t){if(null===e)return null;switch(t){case"DateTime":return e;case"Boolean":return Boolean(e);case"Decimal":case"Integer":case"Long":return r=(n=e).startsWith("-")?"-":"",a=n.replace(/^-?0*/,""),r+(""!==a?a:"0");default:return String(e)}var n,r,a}var v=function(){function e(e){this.tableName=h(e),this.fromClause="FROM "+this.tableName+" AS "+this.tableName}return e.prototype.filtered=function(e){var t=function e(t,n){switch(t.type){case"attribute":return{type:"Boolean"===t.attributeType||"DateTime"===t.attributeType?"int":"string",expr:n+".["+("id"!==t.attribute?h(t.attribute):"guid")+"]",params:[]};case"value":var r=m(t.value);return null===r?{type:"null",expr:"NULL",params:[]}:{type:"number"==typeof r?"int":"string",expr:"?",params:[r]};case"function":var a=t.parameters.map((function(t){return e(t,n)}));switch(t.name){case"true":return y;case"false":return g;case"not":return{type:"int",expr:"(not "+(c=w(a[0])).expr+")",params:c.params};case"or":case"and":var i=a.map(w);return{type:"int",expr:"("+i.map((function(e){return e.expr})).join(" "+t.name+" ")+")",params:_.apply(void 0,i)};case"=":case"!=":case">":case">=":case"<":case"<=":var o=a.some((function(e){return"int"===e.type}))?a.map(j):a,c=o[0],s=o[1],l="="===t.name?"is":"!="===t.name?"is not":t.name;return{type:"int",expr:"("+c.expr+" "+l+" "+s.expr+")",params:_(c,s)};case"contains":case"starts-with":case"ends-with":if("null"===a[1].type)return y;if("null"===a[0].type)return g;var p="replace(replace(replace("+a[1].expr+', "'+(v="~")+'", "'+(v+v)+'"), "'+f+'", "'+(v+f)+'"), "'+d+'", "'+(v+d)+'")',b="starts-with"===t.name?p+" || '"+f+"'":"ends-with"===t.name?"'"+f+"' || "+p:"'"+f+"' || "+p+" || '"+f+"'";return{type:"int",expr:"("+a[0].expr+" like "+b+" escape '~')",params:a[0].params.concat(a[1].params)};case"length":case"string-length":return"null"===a[0].type?g:{type:"int",expr:"length("+a[0].expr+")",params:a[0].params};default:throw new u.AssertionError("Operator "+t.name+" is not yet supported")}}var v}(e,this.tableName),n=t.type,r=t.expr,a=t.params;"null"!==n&&(this.whereClause="WHERE "+r,this.bindParameters=a)},e.prototype.sorted=function(e){var t=this,n=e.map((function(e){var n=e[0],r=e[1];return t.tableName+".["+h(n)+"] "+r})).join(", ");this.orderClause=n?"ORDER BY "+n:""},e.prototype.paged=function(e,t){this.limitClause="LIMIT "+(void 0!==t?t:-1)+" OFFSET "+(e||0)},e.prototype.selectWithMeta=function(e){var t=this;return[["SELECT",e.map((function(e){return t.tableName+".["+h(e)+'] as "'+h(e)+'"'})).concat(l.map((function(e){return o+".["+e+'] as "'+o+"."+e+'"'}))).join(", "),this.fromClause,"JOIN "+o+" AS "+o+" USING ("+c+")",this.whereClause,this.orderClause,this.limitClause].filter((function(e){return e})).join(" "),this.bindParameters||[]]},e.prototype.totalCount=function(){return[["SELECT count(*) AS count",this.fromClause,this.whereClause].filter((function(e){return e})).join(" "),this.bindParameters||[]]},e}(),y={type:"int",expr:"1",params:[]},g={type:"int",expr:"0",params:[]};function w(e){return"null"===e.type?{type:"int",expr:"0",params:[]}:e}function j(e){return"string"===e.type?{type:"int",expr:"cast("+e.expr+" as integer)",params:e.params}:e}function _(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return(e=[]).concat.apply(e,t.map((function(e){return e.params})))}function O(e,t){return T.inside((function(n,r,a){return n.executeSql(e,t,(function(e,t){return r(t.rows)}),(function(e,t){return a(t),!0}))})).chain((function(e){for(var t=[],n=0;n<e.length;++n)t.push(e.item(n));return t}))}var T=function(){function e(){this.work=[]}return e.prototype.chain=function(t){var n,a=new e;return(n=a.work).push.apply(n,Object(r.e)(this.work,[{action:!1,item:t}])),a},e.prototype.read=function(e){return Object(r.b)(this,void 0,void 0,(function(){return Object(r.d)(this,(function(t){return[2,this.execute((function(t,n){return e.readTransaction(t,n)}))]}))}))},e.prototype.execute=function(t){return Object(r.b)(this,void 0,void 0,(function(){var n=this;return Object(r.d)(this,(function(r){return[2,new Promise((function(r,a){return t((function(t){var u=Array.from(n.work);!function n(i){i instanceof e&&(u.unshift.apply(u,i.work),i=void 0);var o=u.shift();if(!o)return void r(i);if(o.action)o.item(t,n,a);else try{var c=o.item(i);n(c)}catch(e){a(e)}}(t)}),a)}))]}))}))},e.inside=function(t){var n=new e;return n.work.push({action:!0,item:t}),n},e}(),x=n(670),k=n(39),E=n(42),R=n(56),S=n(25),D=n(72),C=n(673);function A(e,t,n){return Object(r.b)(this,void 0,void 0,(function(){var i,o,c,s,l,f,d,p,h,m,b,v,y,g;return Object(r.d)(this,(function(w){switch(w.label){case 0:if((i=Object(E.getGuidsFromMicroflowParameters)(t)).findIndex((function(e){return!n.has(e)}))>-1)throw new u.AssertionError("Microflow parameter is not available in the client state");if(i.findIndex((function(e){var t=n.getObject(e);return!mx.meta.getEntity(t.getEntity()).isPersistable()&&Object(x.wasGuidSynced)(t.getGuid())}))>-1)throw new D.DescribedError("Non-persistable objects created in a microflow can't be passed to another microflow as parameter");return o=i.filter((function(e){return!Object(x.wasGuidSynced)(e)})).map((function(e){return n.getObject(e).jsonData})),[4,Object(C.instantiateObjects)(o)];case 1:return c=w.sent(),s=c[0],l=c[1],f=function(e,t,n,r){var a={};return e.forEach((function(e){var n=t.getObject(e).jsonData,u=mx.meta.getEntity(n.objectType),i=Object(C.createChange)(n),o=r.map(n.guid);a[o]=N(r.mapChange(i,u),u);var c=N(r.mapChange(t.getChanges(e),u),u);Object.keys(c).filter((function(e){return u.isSyncable(e)})).forEach((function(e){a[o][e]=c[e]}))})),[a,n]}(i,n,s,l),d=f[0],p=f[1],h=function(e,t){var n={};return Object.keys(e).forEach((function(r){var a=e[r];n[r]="guid"in a?{guid:t.map(a.guid)}:"guids"in a?{guids:t.map(a.guids)}:a})),n}(t,l),[4,Object(k.executeMicroflow)(e,h,[],d,p)];case 2:return m=w.sent(),b=function(e,t,n){var u=e.actionResult,i=e.objects,o=void 0===i?[]:i,c=e.changes,s=void 0===c?{}:c,l=e.commits,f=void 0===l?[]:l,d=e.committedObjectsOmitted,p=void 0!==d&&d,h=e.resets,m=void 0===h?{}:h,b=e.deletes,v=void 0===b?[]:b,y=e.newpersistable,g=void 0===y?[]:y,w={commits:t.map(f),committedObjectsOmitted:p,deletes:t.map(v),newpersistable:t.map(g),objects:o.map((function(e){return t.mapMxObjectJSON(e)})),changes:(_=s,O=o,T=n,Object.assign.apply(Object,Object(r.e)([{}],Object.keys(_).map((function(e){var n,r=(O.find((function(t){return t.guid===e}))||Object(a.ensure)(T.getObject(t.map(e))).jsonData).objectType,u=mx.meta.getEntity(r);return(n={})[t.map(e)]=t.mapChange(_[e],u),n}))))),resets:(j=m,Object.assign.apply(Object,Object(r.e)([{}],Object.keys(j).map((function(e){var n;return(n={})[t.map(e)]=j[e],n})))))};var j;var _,O,T;u&&(w.actionResult=function(e){if(null===e.value)return e;switch(e.type){case"ObjectReference":case"ObjectReferenceSet":return{type:e.type,value:t.map(e.value)};default:return e}}(u));return w}(function(e){var t=e.actionResult,n=e.objects,a=void 0===n?[]:n,u=e.changes,i=void 0===u?{}:u,o=e.commits,c=void 0===o?[]:o,s=e.resets,l=void 0===s?{}:s,f=e.deletes,d=void 0===f?[]:f,p=e.newpersistable,h=void 0===p?[]:p;if(null==t||null==t.value||!["ObjectReference","ObjectReferenceSet"].includes(t.type))return{actionResult:t};var m=(b=t,v=a,("ObjectReference"===b.type?[b.value]:b.value).map((function(e){return v.find((function(t){return t.guid===e}))})).filter((function(e){return e&&!mx.meta.getEntity(e.objectType).isPersistable()})).map((function(e){return e.guid})));var b,v;if(0===m.length)return{actionResult:Object(r.a)(Object(r.a)({},t),{value:null})};return{actionResult:Object(r.a)(Object(r.a)({},t),{value:"ObjectReference"===t.type?m[0]:m}),objects:a.filter((function(e){return m.includes(e.guid)})),changes:g(i,m),newpersistable:y(h,m),commits:y(c,m),committedObjectsOmitted:!1,deletes:y(d,m),resets:g(l,m)};function y(e,t){return e.filter((function(e){return t.includes(e)}))}function g(e,t){return Object.assign.apply(Object,Object(r.e)([{}],Object.keys(e).filter((function(e){return t.includes(e)})).map((function(t){var n;return(n={})[t]=e[t],n}))))}}(m),l.reverse(),n),[4,Object(R.handleRuntimeSuccess)(n,b)];case 3:return w.sent(),null==(v=b.actionResult)?[2,void 0]:(y=v.value,g=v.type,[2,Object(S.runtimeValueToExpressionVariable)(y,g,(function(e){return Object(a.ensure)(n.getObject(e))}))])}}))}))}function N(e,t){return Object.assign.apply(Object,Object(r.e)([{}],Object.keys(e).filter((function(n){return!t.isObjectReference(n)||null==e[n].value||Object(x.wasGuidSynced)(e[n].value)})).map((function(t){var n;return(n={})[t]=e[t],n}))))}n.d(t,"OfflineData",(function(){return B}));var B=function(){function e(e,t){this.objectCache=e,this.database=t}return e.prototype.retrieve=function(e,t,n){return Object(r.b)(this,void 0,void 0,(function(){var u,i,l,f,d,p,h=this;return Object(r.d)(this,(function(m){switch(m.label){case 0:return u=mx.meta.getEntity(e),i=new v(e),void 0!==t&&i.filtered(t),void 0===n.offset&&void 0===n.amount||i.paged(n.offset,n.amount),void 0!==n.sort&&i.sorted(n.sort),[4,O.apply(void 0,i.selectWithMeta(u.getAttributes())).chain((function(e){return O.apply(void 0,i.totalCount()).chain((function(t){return{rows:e,count:t[0].count}}))})).read(this.database)];case 1:return l=m.sent(),f=l.rows,d=l.count,p=f.map((function(e){return function(e,t){var n={guid:t[o+"."+c],objectType:e.getEntity(),attributes:{}},a=JSON.parse(t[o+"."+s]);return Object.keys(t).filter((function(e){return!e.startsWith(o)})).forEach((function(u){var i=u.replace("$","."),o=e.getAttributeType(i);n.attributes[i]=Object(r.a)({value:b(t[u],o)},a.includes(i)?{readonly:!0}:{})})),n}(u,e)})),this.objectCache.setMxObjects(p),[2,{mxobjs:p.map((function(e){return Object(a.ensure)(h.objectCache.getObject(e.guid))})),count:d}]}}))}))},e.prototype.executeMicroflow=function(e,t){return Object(r.b)(this,void 0,void 0,(function(){return Object(r.d)(this,(function(n){return[2,A(e,t,this.objectCache)]}))}))},e}()}}]);