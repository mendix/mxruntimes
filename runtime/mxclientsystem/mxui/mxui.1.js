/* @preserve
    Copyright (c) 2005-2016, Mendix bv. All rights reserved.
    See mxclientsystem/licenses.txt for third party licenses that apply.
*/
(window.mxJsonp=window.mxJsonp||[]).push([[1],{588:function(t,e,n){var r=n(20);Object.defineProperty(e,"__esModule",{value:!0}),e.buildOfflineDataBackend=function(t,e,n){var r,c,s,l,f,d,h,p;return i.default.async(function(m){for(;;)switch(m.prev=m.next){case 0:return r=n.createStoreFn,c=n.getStorageDirFn,s=n.downloadFileFn,l=n.getDocumentUrlFn,f=new o(window.mx.session.getConfig("sync_config.schema"),r),d=new e({downloadFileFn:s,getStorageDirFn:c}),h=new u.Synchronizer(f,d,t),p=new a.OfflineDataBackend({getDocumentUrlFn:l},t,f,d,h),m.next=7,i.default.awrap(p.initialize());case 7:return m.abrupt("return",p);case 8:case"end":return m.stop()}},null,this)};var i=r(n(114)),a=n(602),u=n(603),o=n(604)},589:function(t,e,n){var r=n(20);Object.defineProperty(e,"__esModule",{value:!0}),e.FileBackend=void 0;var i=r(n(114)),a=r(n(102)),u=r(n(33)),o=r(n(34)),c=n(262),s=n(25),l=function(){function t(e){(0,u.default)(this,t),this._config=e,this._storageDirPromise=null}return(0,o.default)(t,[{key:"readFile",value:function(t){return this._openFile(t).then(function(t){return function(t){return(0,c.callbackToPromise)(t.file.bind(t)).then(m).then(function(t){return new Blob([t])})}(t)})}},{key:"storeFile",value:function(t,e){return this._openFile(e,!0).then(function(e){return n=e,r=t,(0,c.callbackToPromise)(n.createWriter.bind(n)).then(function(t){return function(t,e){return new Promise(function(n,r){e.onwrite=n,e.onerror=r,e.write(t)})}(r,t)});var n,r})}},{key:"moveFile",value:function(t,e){var n,r,u,o,c,s;return i.default.async(function(l){for(;;)switch(l.prev=l.next){case 0:return l.next=2,i.default.awrap(this._openFile(t));case 2:return n=l.sent,r=f(e),u=(0,a.default)(r,2),o=u[0],c=u[1],l.next=6,i.default.awrap(this._openDir(o));case 6:return s=l.sent,l.next=9,i.default.awrap(y(n,s,c));case 9:case"end":return l.stop()}},null,this)}},{key:"downloadFile",value:function(t,e){var n=this;return this._config.downloadFileFn?(0,c.callbackToPromise)(this._config.downloadFileFn,t,e):(0,s.get)(t,"blob").then(function(t){return n.storeFile(t,e)})}},{key:"removeDir",value:function(t){var e;return i.default.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,i.default.awrap(this._openDir(t));case 3:return e=n.sent,n.next=6,i.default.awrap(p(e));case 6:n.next=12;break;case 8:if(n.prev=8,n.t0=n.catch(0),1===n.t0.code){n.next=12;break}throw n.t0;case 12:case"end":return n.stop()}},null,this,[[0,8]])}},{key:"_openFile",value:function(t){var e,n,r,u,o,c,s=arguments;return i.default.async(function(l){for(;;)switch(l.prev=l.next){case 0:return e=s.length>1&&void 0!==s[1]&&s[1],n=f(t),r=(0,a.default)(n,2),u=r[0],o=r[1],l.next=4,i.default.awrap(this._openDir(u,e));case 4:return c=l.sent,l.abrupt("return",h(c,o,e));case 6:case"end":return l.stop()}},null,this)}},{key:"_openDir",value:function(t){var e,n,r,a,u=arguments;return i.default.async(function(o){for(;;)switch(o.prev=o.next){case 0:return e=u.length>1&&void 0!==u[1]&&u[1],n=t.split("/").filter(function(t){return""!==t}),o.next=4,i.default.awrap(this._getStorageDir());case 4:r=o.sent,a=0;case 6:if(!(a<n.length)){o.next=13;break}return o.next=9,i.default.awrap(d(r,n[a],e));case 9:r=o.sent;case 10:++a,o.next=6;break;case 13:return o.abrupt("return",r);case 14:case"end":return o.stop()}},null,this)}},{key:"_getStorageDir",value:function(){return this._config.getStorageDirFn?(0,c.callbackToPromise)(this._config.getStorageDirFn):(null===this._storageDirPromise&&(this._storageDirPromise=(0,c.callbackToPromise)(window.webkitRequestFileSystem,window.TEMPORARY,1048576).then(function(t){return t.root})),this._storageDirPromise)}}]),t}();function f(t){return t.split(/\/([^\/]+)$/)}function d(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return(0,c.callbackToPromise)(t.getDirectory.bind(t),e,{create:n})}function h(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return(0,c.callbackToPromise)(t.getFile.bind(t),e,{create:n})}function p(t){return(0,c.callbackToPromise)(t.removeRecursively.bind(t))}function m(t){return new Promise(function(e,n){var r=new FileReader;r.onload=function(t){return e(t.target.result)},r.onerror=function(t){return n(t.target.error)},r.readAsArrayBuffer(t)})}function y(t,e,n){return new Promise(function(r,i){t.moveTo(e,n,r,i)})}e.FileBackend=l},594:function(t,e,n){t.exports={LIKE_ESCAPE_CHAR:"~",QUOTE_CHAR:'"'}},595:function(t,e,n){function r(t){this.fork=t}r.of=function(t){return new r(function(e,n){n(t)})},r.prototype.chain=function(t){var e=this;return new r(function(n,r){e.fork(n,function(e){t(e).fork(n,r)})})},r.prototype.orElse=function(t){var e=this;return new r(function(n,r){e.fork(function(e){t(e).fork(n,r)},r)})},r.prototype.ap=function(t){var e,n,i,a=this,u=2;return new r(function(r,o){function c(){0==--u&&o(e(n))}function s(t){void 0===i&&r(i=t)}a.fork(s,function(t){e=t,c()}),t.fork(s,function(t){n=t,c()})})},r.prototype.map=function(t){return this.chain(function(e){return r.of(t(e))})},r.rejected=r.prototype.rejected=function(t){return new r(function(e,n){e(t)})},r.parallel=function(t){return new r(function(e,n){var r,i=t.length,a=new Array(t.length);0!==t.length?t.forEach(function(t,u){t.fork(function(t){void 0===r&&(r=t,e(t))},function(t){return function(e){a[t]=e,void 0===r&&0==--i&&n(a)}}(u))}):n(a)})},r.sequence=function(t){return t.reduce(function(t,e){return t.chain(function(t){return e})},r.of(null))},t.exports=r},596:function(t,e,n){var r=n(609),i=n(595),a=new r(i);a.rejected=function(t){return new a(function(e){return i.rejected(t)})},a.parallel=function(t){return new a(function(e){return new i(function(n,r){if(0!==t.length){var i=new Array(t.length),a=t.length,u=!1;t.forEach(function(t,o){t.run(e).fork(function(t){u||(u=!0,n(t))},function(t){i[o]=t,u||0!=--a||r(i)})})}else r([])})})},a.sequence=function(t){return t.reduce(function(t,e){return t.chain(function(t){return e.map(function(e){return t.concat([e])})})},a.of([]))},t.exports=a},597:function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.makeGuidFsFriendly=function(t){return t.replace(/:/g,"_")},e.createUnsyncedGuid=function(){return i+r.getUniqueId()},e.wasGuidSynced=function(t){return!a.test(t)},e.isSpecialAttributeName=u,e.isReadonlyAttr=o,e.objectToJson=function(t){var e=Object.keys(t).filter(function(t){return!u(t)}).reduce(function(e,n){return e[n]={value:t[n]},o(t,n)&&(e[n].readonly=!0),e},{});return{guid:t.guid,objectType:t.$objectType,attributes:e}},e.jsonToObject=function(t){var e={guid:t.guid,$objectType:t.objectType,$readonlyAttrs:[]};for(var n in t.attributes)e[n]=t.attributes[n].value,t.attributes[n].readonly&&e.$readonlyAttrs.push(n);return e},e.THUMBNAIL_DIR_PATH=e.DOCUMENT_DIR_PATH=void 0;var r=n(12);e.DOCUMENT_DIR_PATH="files/documents/";e.THUMBNAIL_DIR_PATH="files/thumbnails/";var i="GUID:",a=new RegExp("^"+i);function u(t){return"guid"===t||"$"===t[0]}function o(t,e){return t.$readonlyAttrs.includes(e)}},598:function(t,e,n){var r=n(595),i={promiseFromTask:function(t){return new Promise(function(e,n){t.fork(n,e)})},callbackFromTask:function(t,e,n){t.fork(function(t){n&&n(t)},function(t){e&&e(t)})},taskFromPromise:function(t){return new r(function(e,n){t.then(n,e)})}};t.exports=i},602:function(t,e,n){var r=n(20);Object.defineProperty(e,"__esModule",{value:!0}),e.OfflineDataBackend=void 0;var i=r(n(212)),a=r(n(102)),u=r(n(114)),o=r(n(33)),c=r(n(34)),s=r(n(59)),l=r(n(53)),f=r(n(60)),d=n(597),h=n(107),p=n(24),m=n(347),y=n(12),b={String:null,Integer:"0",Long:"0",Decimal:"0",Float:"0",Currency:"0",Enum:null,HashString:null,ObjectReference:null,DateTime:null,Boolean:!1,AutoNumber:"0",Binary:null},v=function(t){function e(t,n,r,i,a){var u;return(0,o.default)(this,e),t=t||{},(u=(0,s.default)(this,(0,l.default)(e).call(this)))._store=r,u._getDocumentUrl=t.getDocumentUrlFn||w,u._objectCache=n,u._fileBackend=i,u._synchronizer=a,u._dirtyGuids=[],u}return(0,f.default)(e,t),(0,c.default)(e,[{key:"initialize",value:function(){var t;return u.default.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u.default.awrap(this._store.fetchDirty());case 2:t=e.sent,this._dirtyGuids=t.map(function(t){return t.guid});case 4:case"end":return e.stop()}},null,this)}},{key:"getByGuid",value:function(t,e){return Promise.all(t.map(this._getByGuid,this)).then(function(t){return{mxobjects:t.filter(function(t){return null!=t}).map(d.objectToJson)}})}},{key:"getByPath",value:function(t,e,n,r){var i,o,c,s,l,f,d,h,m,y,b,v,_,g,w=this;return u.default.async(function(j){for(;;)switch(j.prev=j.next){case 0:if("reverse"!==r){j.next=11;break}return i=this._objectCache.getAllObjects().filter(function(n){return n.getReferences(e).includes(t)}).map(function(t){return t.jsonData}),j.next=4,u.default.awrap(this.getSlice(n,[{attribute:e,operator:"equals",value:t}]));case 4:return o=j.sent,c=o.mxobjects,s=c.map(function(t){return p.MxObject.fromJson(t)}).filter(function(n){return n.getReferences(e).includes(t)}),l=s.filter(function(t){return!i.some(function(e){return e.guid===t.getGuid()})}).map(function(t){return t.jsonData}),j.abrupt("return",{mxobjects:i.concat(l)});case 11:if(f=this._objectCache.getObject(t)){j.next=19;break}return j.next=15,u.default.awrap(this.getByGuid([t]));case 15:d=j.sent,h=(0,a.default)(d.mxobjects,1),(m=h[0])&&(f=p.MxObject.fromJson(m));case 19:if(f){j.next=21;break}return j.abrupt("return",{mxobjects:[]});case 21:return y=f.getReferences(e),b=y.map(function(t){return w._objectCache.getObject(t)}).filter(function(t){return null!==t}).map(function(t){return t.jsonData}),v=y.filter(function(t){return!w._objectCache.has(t)}),j.next=26,u.default.awrap(this.getByGuid(v));case 26:return _=j.sent,g=_.mxobjects,j.abrupt("return",{mxobjects:g.concat(b)});case 29:case"end":return j.stop()}},null,this)}},{key:"getSlice",value:function(t,e,n){var r=this,i=window.mx.meta.getEntity(t),u=(e||[]).map(function(t){return t.attribute&&i.isReference(t.attribute)&&(t.value=r._synchronizer.getInternalGuid(t.value)),t});return this._store.getSlice(t,u,n).then(function(t){var e=(0,a.default)(t,2),n=e[0],i=e[1];return{mxobjects:n.map(r._synchronizer.makeObjectExternal,r._synchronizer).map(d.objectToJson),count:i}})}},{key:"create",value:function(t){var e=(0,d.createUnsyncedGuid)();return this._objectCache.onCreate([e]),this._objectCache.setMxObjects([g(e,t)]),Promise.resolve({actionResult:e})}},{key:"commit",value:function(t,e){var n,r,o,c,s,l,f,h,p,m,b,v,g,w,j,T,x,k=this;return u.default.async(function(e){for(;;)switch(e.prev=e.next){case 0:return x=function(t){var e={};return Object.keys(t).forEach(function(n){e[n]=Object.keys(t[n])}),e},T=function(t){return Object.assign({},t,y.mapObject(n[t.guid],function(t){return t.value}))},n=y.objectFromArray(t.map(function(t){return[t,k._objectCache.getChanges(t)]})),r=y.partition(function(t){return k._objectCache.has(t)},t),o=(0,a.default)(r,2),c=o[0],s=o[1],l=c.map(function(t){return k._objectCache.getObject(t)}),f=y.partition(function(t){return t.isPersistable()},l),h=(0,a.default)(f,2),p=h[0],m=h[1],b=p.map(_),e.next=9,u.default.awrap(Promise.all(s.map(this._getByGuid,this)));case 9:if(v=e.sent,!((g=v.concat(b).map(T)).length>0)){e.next=16;break}return e.next=14,u.default.awrap(this._store.insertOrReplace(g.map(this._synchronizer.makeObjectInternal,this._synchronizer)));case 14:(w=this._dirtyGuids).push.apply(w,(0,i.default)(g.map(function(t){return t.guid}))),this._objectCache.setMxObjects(g.map(function(t){return(0,d.objectToJson)(t)}));case 16:return j=m.map(_).map(T),this._objectCache.setMxObjects(j.map(function(t){return(0,d.objectToJson)(t)})),this._objectCache.onCommit(t),this._objectCache.removeChanges(x(n)),e.abrupt("return",{});case 21:case"end":return e.stop()}},null,this)}},{key:"rollback",value:function(t){var e=this;this._objectCache.removeAllChanges(t);var n=t.filter(function(t){return e._objectCache.isNew(t)});return this._objectCache.removeObjects(n),Promise.resolve({})}},{key:"validate",value:function(t){return Promise.resolve({})}},{key:"saveDocument",value:function(t,e,n,r){var i=this;if(r.size/1048576>n.maxFileSize)return Promise.reject(new h.DescribedError("File too large"));var a=(0,d.makeGuidFsFriendly)(this._synchronizer.getInternalGuid(t));return this._fileBackend.storeFile(r,d.DOCUMENT_DIR_PATH+a).then(function(){return i._objectCache.makeChange(t,"HasContents",!0),i.commit([t],null)})}},{key:"getDocumentUrl",value:function(t,e,n){return this._getDocumentUrl((0,d.makeGuidFsFriendly)(this._synchronizer.getInternalGuid(t)),e,n)}},{key:"getImageUrl",value:function(t){return Promise.resolve(t)}},{key:"upload",value:function(){return this._synchronizer.upload()}},{key:"downloadObjects",value:function(t){return u.default.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u.default.awrap(this._synchronizer.downloadObjects(t));case 2:this._dirtyGuids=[];case 3:case"end":return e.stop()}},null,this)}},{key:"downloadFiles",value:function(t){return this._synchronizer.downloadFiles(t)}},{key:"cleanupDirtyObjects",value:function(){return this._store.cleanupDirtyObjects()}},{key:"isDirty",value:function(t){return this._dirtyGuids.includes(t)}},{key:"cleanup",value:function(){return u.default.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,u.default.awrap(this._store.cleanDatabase());case 2:return t.next=4,u.default.awrap(this._fileBackend.removeDir(d.DOCUMENT_DIR_PATH));case 4:return t.next=6,u.default.awrap(this._fileBackend.removeDir(d.THUMBNAIL_DIR_PATH));case 6:this._dirtyGuids=[];case 7:case"end":return t.stop()}},null,this)}},{key:"_getByGuid",value:function(t){var e=this;return this._store.getByGuid(this._synchronizer.getInternalGuid(t)).then(function(t){return e._synchronizer.makeObjectExternal(t)})}}]),e}(m._DataBackend);function _(t){return(0,d.jsonToObject)(t.jsonData)}function g(t,e){var n={guid:t,objectType:e,attributes:{}},r=window.mx.meta.getEntity(e);return r.getAttributes().forEach(function(t){n.attributes[t]={value:b[r.getAttributeType(t)]}}),n}function w(t,e,n){var r=n?"thumbnails":"documents";return"filesystem:"+window.mx.appUrl+"temporary/files/"+r+"/"+t+"?"+ +new Date}e.OfflineDataBackend=v},603:function(t,e,n){var r=n(20);Object.defineProperty(e,"__esModule",{value:!0}),e.Synchronizer=void 0;var i=r(n(212)),a=r(n(102)),u=r(n(114)),o=r(n(33)),c=r(n(34)),s=n(597),l=n(48),f=n(85),d=n(323),h=n(261),p=n(348),m=n(56),y=r(n(12)),b=n(64),v=n(83),_=function(){function t(e,n,r){(0,o.default)(this,t),this._store=e,this._fileBackend=n,this._objectCache=r,this._internalToExternal={}}return(0,c.default)(t,[{key:"upload",value:function(){return u.default.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,u.default.awrap(this._upload());case 3:t.next=16;break;case 5:if(t.prev=5,t.t0=t.catch(0),!(t.t0 instanceof f.ConnectionError)){t.next=11;break}throw new p.TemporarySynchronizationError;case 11:if(t.t0 instanceof d.DanglingError){t.next=15;break}throw new h.SynchronizationError;case 15:throw t.t0;case 16:case"end":return t.stop()}},null,this,[[0,5]])}},{key:"downloadObjects",value:function(t){return u.default.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,u.default.awrap(this._downloadObjects(t));case 3:e.next=12;break;case 5:if(e.prev=5,e.t0=e.catch(0),!(e.t0 instanceof f.ConnectionError)){e.next=11;break}throw new p.TemporarySynchronizationError;case 11:throw new h.SynchronizationError;case 12:case"end":return e.stop()}},null,this,[[0,5]])}},{key:"downloadFiles",value:function(t){return u.default.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,u.default.awrap(this._downloadFiles(t));case 3:e.next=12;break;case 5:if(e.prev=5,e.t0=e.catch(0),!(e.t0 instanceof f.ConnectionError)){e.next=11;break}throw new p.TemporarySynchronizationError;case 11:throw new h.SynchronizationError;case 12:case"end":return e.stop()}},null,this,[[0,5]])}},{key:"_upload",value:function(){var t,e,n,r,i,o,c,f,h,p,m,b,_,g,w,j,T,x,k,E,D,O,F,S=this;return u.default.async(function(A){for(;;)switch(A.prev=A.next){case 0:return F=function(t,e){var n=window.mx.meta.getEntity(t.$objectType),r=Object.keys(t).filter(function(e){return!(0,s.isSpecialAttributeName)(e)&&n.isSyncable(e)&&!(0,s.isReadonlyAttr)(t,e)}).map(function(r){var i=t[r];return[r,{value:n.isObjectReference(r)&&null!=i&&!(0,s.wasGuidSynced)(i)?e[i]:i}]});return[(0,s.wasGuidSynced)(t.guid)?t.guid:e[t.guid],y.default.objectFromArray(r)]},O=function(t){return(0,l.instantiate)(t.$objectType).then(function(e){var n=e.objects.find(function(t){return t.guid===e.actionResult});return{internalObj:t,remoteJson:n}})},D=function(e){var n,r,i;return u.default.async(function(a){for(;;)switch(a.prev=a.next){case 0:return n=s.DOCUMENT_DIR_PATH+(0,s.makeGuidFsFriendly)(e.guid),a.next=3,u.default.awrap(t.readFile(n));case 3:return r=a.sent,a.next=6,u.default.awrap((0,v.uploadWithRetries)("__sync__","",r,2));case 6:return i=a.sent,a.abrupt("return",{tempGuid:i.commits[0],fileObjGuid:e.guid});case 8:case"end":return a.stop()}},null,this)},E=function(t){return window.mx.meta.getEntity(t.$objectType).isA("System.FileDocument")&&t.HasContents},k=function(t){var e=window.mx.meta.getEntity(t.$objectType);return y.default.arrayFromObject(t).filter(function(t){var n=(0,a.default)(t,2),r=n[0];n[1];return"guid"===r||!(0,s.isSpecialAttributeName)(r)&&e.isReference(r)})},x=function(t){var e=t.map(function(t){return t.guid}),n=y.default.unique(t.map(function(t){return k(t).map(function(t){var e=(0,a.default)(t,2);e[0];return e[1]})}).reduce(function(t,e){return t.concat(e)},[])).filter(function(t){return!(0,s.wasGuidSynced)(t)}).filter(function(t){return!e.includes(t)});if(n.length>0){var r=y.default.unique(t.map(function(t){return k(t).filter(function(t){var e=(0,a.default)(t,2),r=(e[0],e[1]);return n.includes(r)}).map(function(e){var n=(0,a.default)(e,2),r=n[0];n[1];return"object of type ".concat(t.$objectType," (reference ").concat(r,")")})}).reduce(function(t,e){return t.concat(e)},[])).join(", "),i="Sync has failed due to a modeling error. Your database contains objects that reference uncommitted objects:\n".concat(r,".");throw new d.DanglingError(i)}},t=this._fileBackend,A.next=9,u.default.awrap(this._store.fetchDirty());case 9:if(0!==(e=A.sent).length){A.next=12;break}return A.abrupt("return",{});case 12:return x(e),n=y.default.partition(function(t){return(0,s.wasGuidSynced)(t.guid)},e),r=(0,a.default)(n,2),i=r[0],o=r[1],c=o.filter(E),f=i.filter(E),A.next=18,u.default.awrap(Promise.all([Promise.all(c.concat(f).map(D)),Promise.all(o.map(O))]));case 18:return h=A.sent,p=(0,a.default)(h,2),m=p[0],b=p[1],_=y.default.objectFromArray(b.map(function(t){var e=t.internalObj,n=t.remoteJson;return[e.guid,n.guid]})),g=y.default.objectFromArray(m.map(function(t){var e=t.tempGuid,n=t.fileObjGuid;return(0,s.wasGuidSynced)(n)?[e,n]:[e,_[n]]})),w=i.map(function(t){return t.guid}).concat(b.map(function(t){return t.remoteJson.guid})),j=b.map(function(t){return t.remoteJson}),T=y.default.objectFromArray(e.map(function(t){return F(t,_)})),A.next=29,u.default.awrap((0,l.synchronize)(w,g,T,j));case 29:return A.next=31,u.default.awrap(this._store.makeClean(e));case 31:return A.next=33,u.default.awrap(Promise.all(c.map(function(e){var n,r;return u.default.async(function(i){for(;;)switch(i.prev=i.next){case 0:return n=s.DOCUMENT_DIR_PATH+(0,s.makeGuidFsFriendly)(e.guid),r=s.DOCUMENT_DIR_PATH+(0,s.makeGuidFsFriendly)(_[e.guid]),i.next=4,u.default.awrap(t.moveFile(n,r));case 4:case"end":return i.stop()}},null,this)})));case 33:return y.default.arrayFromObject(_).forEach(function(t){var e=(0,a.default)(t,2),n=e[0],r=e[1];return S._mapInternalGuid(n,r)}),A.abrupt("return",{});case 35:case"end":return A.stop()}},null,this)}},{key:"_downloadObjects",value:function(t){var e,n,r,o,c,f,d,h;return u.default.async(function(p){for(;;)switch(p.prev=p.next){case 0:return h=function(t,e){return(0,l.retrieveByXPath)(e).then(function(e){return e.mxobjects.map(s.jsonToObject).map(function(e){return Object.assign({},e,{$objectType:t})})})},p.t0=y.default,p.next=4,u.default.awrap(Promise.all(t.map(function(t){var e=t.store,n=t.xpath;return h(e,n)})));case 4:return p.t1=p.sent,e=p.t0.flatten.call(p.t0,p.t1),p.next=8,u.default.awrap(this._store.rebuildDatabase(e));case 8:return n=e.map(this.makeObjectExternal,this),r=this._objectCache.getAllObjects().filter(function(t){return t.isPersistable()}).map(function(t){return[n.find(function(e){return e.guid===t.getGuid()}),t]}),o=y.default.partition(function(t){return void 0!==(0,a.default)(t,1)[0]},r),c=(0,a.default)(o,2),f=c[0],d=c[1],this._objectCache.setMxObjects(f.map(function(t){var e=(0,a.default)(t,1)[0];return(0,s.objectToJson)(e)})),this._objectCache.onDelete(d.map(function(t){var e=(0,a.default)(t,2);e[0];return e[1].getGuid()})),p.next=15,u.default.awrap(b.publish.apply(void 0,(0,i.default)(t.map(function(t){return{entity:t.store}})).concat((0,i.default)(f.map(function(t){return{guid:(0,a.default)(t,1)[0].guid}})),(0,i.default)(d.map(function(t){var e=(0,a.default)(t,2);e[0];return{guid:e[1].getGuid()}})))));case 15:return p.abrupt("return",{});case 16:case"end":return p.stop()}},null,this)}},{key:"_downloadFiles",value:function(t){var e,n,r,i,o,c,l;return u.default.async(function(f){for(;;)switch(f.prev=f.next){case 0:return l=function(t,e){var r=(0,m.getRemoteDynamicResourceUrl)(t.guid,t.changedDate,e),i=(e?s.THUMBNAIL_DIR_PATH:s.DOCUMENT_DIR_PATH)+(0,s.makeGuidFsFriendly)(t.guid);return n.downloadFile(r,i)},c=function(t){return e.getSlice(t,[{attribute:"HasContents",operator:"equals",value:"true"}]).then(function(t){var e=(0,a.default)(t,2),n=e[0];e[1];return n})},e=this._store,n=this._fileBackend,f.t0=y.default,f.next=7,u.default.awrap(Promise.all(t.map(function(t){return c(t)})));case 7:return f.t1=f.sent,r=f.t0.flatten.call(f.t0,f.t1),i=r.map(function(t){return l(t,!1)}),o=r.filter(function(t){return window.mx.meta.getEntity(t.$objectType).isA("System.Image")}).map(function(t){return l(t,!0)}),f.next=13,u.default.awrap(Promise.all(i.concat(o)));case 13:return f.abrupt("return",{});case 14:case"end":return f.stop()}},null,this)}},{key:"getExternalGuid",value:function(t){return this._internalToExternal[t]||t}},{key:"getInternalGuid",value:function(t){for(var e in this._internalToExternal)if(this._internalToExternal[e]===t)return e;return t}},{key:"makeObjectExternal",value:function(t){return g(t,this.getExternalGuid.bind(this))}},{key:"makeObjectInternal",value:function(t){return g(t,this.getInternalGuid.bind(this))}},{key:"_mapInternalGuid",value:function(t,e){this._internalToExternal[e]=t}}]),t}();function g(t,e){if(null===t)return null;var n=window.mx.meta.getEntity(t.$objectType);return y.default.mapObject(t,function(t,r){return("guid"===r||!(0,s.isSpecialAttributeName)(r)&&n.isReference(r))&&null!=t?e(t):t})}e.Synchronizer=_},604:function(t,e,n){var r=n(605),i=n(610),a=n(611),u=n(596),o=n(598);function c(){return window.openDatabase("MendixDatabase","1","Mendix Database",10485760)}function s(t,e){a.call(this),e=e||c,this._tableNames=t;var n=e();this._databasePromise=this._initialize(n)}s.prototype=Object.create(a.prototype),s.prototype._getDatabase=function(){return this._databasePromise},s.prototype._initialize=function(t){var e=r.createCreateTransaction(this._tableNames);return o.promiseFromTask(i.runWriteTransaction(t,e)).then(function(){return t})},s.prototype._fetch=function(t){return function(e){var n=r.createFetchByGuidTransaction(t);return o.promiseFromTask(i.runReadTransaction(e,n))}},s.prototype._fetchSlice=function(t,e,n){return function(a){var u=r.createFetchSliceTransaction(t,e,n.offset,n.limit,n.sort);return o.promiseFromTask(i.runReadTransaction(a,u))}},s.prototype._rebuildDb=function(t){return u.ask().chain(function(e){var n=r.createRebuildTransaction(this._tableNames,t);return new u(function(t){return i.runWriteTransaction(e,n)})}.bind(this))},s.prototype._insertOrReplace=function(t){return function(e){var n=r.createInsertOrReplaceTransaction(t);return o.promiseFromTask(i.runWriteTransaction(e,n))}},s.prototype._cleanDatabase=function(){var t=this;return function(e){var n=r.createCleanTransaction(t._tableNames);return o.promiseFromTask(i.runWriteTransaction(e,n))}},s.prototype._fetchDirty=function(){return u.ask().chain(function(t){var e=r.createFetchDirtyObjectsTransaction();return new u(function(n){return i.runWriteTransaction(t,e)})})},s.prototype._makeClean=function(t){return u.ask().chain(function(e){var n=r.createMakeCleanTransaction(t);return new u(function(t){return i.runWriteTransaction(e,n)})})},s.prototype._cleanupDirtyObjects=function(){return function(t){var e=r.createDirtyCleanupTransaction();return o.promiseFromTask(i.runWriteTransaction(t,e))}},t.exports=s},605:function(t,e,n){var r=n(594),i=n(606),a=i.SqlSelectBuilder,u=i.constraintBuilder,o=n(607),c=n(608),s=n(596),l=n(595),f=n(11),d="_guidToTable",h={String:"text",Integer:"text",Long:"text",Decimal:"text",Float:"text",Currency:"text",Enum:"text",HashString:"text",ObjectReference:"text",DateTime:"integer",Boolean:"integer",AutoNumber:"integer",Binary:"blob"},p={String:T,Integer:j,Long:j,Decimal:j,Float:j,Currency:j,Enum:T,HashString:T,ObjectReference:T,DateTime:function(t){return null!=t?Number(t):null},Boolean:Number,AutoNumber:T,Binary:T},m={String:T,Integer:T,Long:T,Decimal:T,Float:T,Currency:T,Enum:T,HashString:T,ObjectReference:T,DateTime:x,Boolean:Boolean,AutoNumber:T,Binary:T},y={String:x,Integer:x,Long:x,Decimal:x,Float:x,Currency:x,Enum:x,HashString:x,ObjectReference:x,DateTime:function(t){return t?Number(t):null},Boolean:function(t){return"false"!==t},AutoNumber:x,Binary:x},b={createCreateTransaction:v,createCleanTransaction:function(t){var e=[d].concat(t).map(E).map(function(t){return"DELETE FROM '".concat(t,"'")}).map(function(t){return S(t,[])});return s.parallel(e).map(function(t){})},createFetchByGuidTransaction:function(t){return S((new a).from(d).where(u.equals("guid")).select(),[t]).chain(function(e){if(0===e.rows.length)return s.of(null);if(1!==e.rows.length)return s.rejected(new Error("db consistency error"));var n=e.rows.item(0),r=n.tableName,i=Boolean(n.dirty),o=n.readonlyAttrs;return S((new a).from(E(r)).where(u.equals("guid")).select(),[t]).chain(function(t){return 0===t.rows.length?s.rejected(new Error("entity not found")):1!==t.rows.length?s.rejected(new Error("db consistency error")):s.of(O(window.mx.meta.getEntity(r),i,o,t.rows.item(0)))})})},createFetchSliceTransaction:function(t,e,n,i,o){e=e||[],o=o||[];var c=window.mx.meta.getEntity(t),l=function(t,e){var n=[];return{builder:(new a).where(e.map(function e(i){if(i.constraints)return u[i.operator](i.constraints.map(e).filter(function(t){return null!==t}));if(null==i.value)switch(i.operator){case"contains":return null;case"equals":return u.isNull(E(i.attribute),i.negate)}var a=t.getAttributeType(i.attribute);var o=y[a];var c=p[a];var s=c(o(i.value));n.push("contains"===i.operator?(l=s,f=r.LIKE_ESCAPE_CHAR,l.replace(new RegExp(f,"g"),f+f).replace(/%/g,f+"%").replace(/_/g,f+"_")):s);var l,f;return u[i.operator](E(i.attribute),i.negate)}).filter(function(t){return null!==t})),args:n}}(c,e),f=l.builder.from(E(t)),h=l.args,m=f.offset(n).limit(i).join(d,"guid",["dirty","readonlyAttrs"]),b=S((m=o.reduce(function(t,e){return t.order(e[0],e[1])},m)).select(),h).map(function(t){for(var e=[],n=0;n<t.rows.length;++n){var r=t.rows.item(n),i=Boolean(r["".concat(d,".dirty")]),a=F(r,"readonlyAttrs");e.push(O(c,i,a,r))}return e}),v=S(f.selectCount("cnt"),h).map(function(t){return t.rows.item(0).cnt});return s.parallel([b,v])},createInsertOrReplaceTransaction:function(t){return s.parallel(t.map(function(t){var e=t.$objectType,n=g(),r=w(e,t);return[S(n.insertOrReplace(),[t.guid,e,1,JSON.stringify(t.$readonlyAttrs)]),S(r.builder.insertOrReplace(),r.values)]}).reduce(function(t,e){return t.concat(e)},[])).map(function(t){})},createFetchDirtyObjectsTransaction:function(){return _().chain(function(t){var e=k(t.rows).map(function(t){var e=t.tableName,n=(new a).from(E(e)).join(d,"guid",["dirty","readonlyAttrs"]).where(u.equals("".concat(d,".dirty"))).select(),r=window.mx.meta.getEntity(e);return S(n,[1]).map(function(t){return k(t.rows).map(function(t){return O(r,!0,F(t,"readonlyAttrs"),t)})})});return s.parallel(e)}).map(function(t){return t.reduce(function(t,e){return t.concat(e)},[])})},createMakeCleanTransaction:function(t){var e=t.map(function(t){return S("UPDATE ".concat(d," set dirty = 0 where guid = ?"),[t.guid])});return s.parallel(e).map(function(t){})},createDirtyCleanupTransaction:function(){return _().chain(function(t){var e=k(t.rows).map(function(t){var e=t.tableName;return S("DELETE FROM ".concat(E(e)," WHERE guid IN (\n                            SELECT guid FROM ").concat(d," WHERE tableName = ? AND dirty = 1)"),[e])});return s.sequence([s.parallel(e),S("DELETE FROM ".concat(d," WHERE dirty = 1"))]).map(function(t){})})},createRebuildTransaction:function(t,e){var n=function(t){var e=[d].concat(t).map(E).map(function(t){return"DROP TABLE IF EXISTS '"+t+"'"}).map(function(t){return S(t,[])});return s.sequence([s.parallel(e),v(t)])}(t),r=t.map(function(t){var n=e.filter(function(e){return e.$objectType===t});return function(t,e){var n=e.reduce(function(e,n){var r=g(),i=w(t,n);return e.concat([S(r.insert(),[n.guid,t,0,JSON.stringify(n.$readonlyAttrs)]),S(i.builder.insert(),i.values)])},[]);return s.parallel(n).map(function(t){})}(t,n)});return s.sequence([n,s.parallel(r)]).map(function(t){})}};function v(t){var e,n=[(e=(new o).table(d).primaryKeyColumn("guid","text").column("tableName","text").column("dirty","boolean").column("readonlyAttrs","text").createIfNotExists(),S(e,[]))].concat(t.map(function(t){return S(function(t){var e=window.mx.meta.getEntity(t);return e.getAttributes().map(function(t){var n=e.getAttributeType(t);return{attr:t,type:h[n]}})}(t).reduce(function(t,e){return t.column(E(e.attr),e.type)},(new o).table(E(t)).primaryKeyColumn("guid","text")).createIfNotExists(),[])}));return s.parallel(n).map(function(t){})}function _(){return S((new a).from(d).where(u.equals("dirty")).selectDistinct("tableName"),[1])}function g(){return(new c).into(d).column("guid").column("tableName").column("dirty").column("readonlyAttrs")}function w(t,e){var n=window.mx.meta.getEntity(t),r=n.getAttributes().reduce(function(t,r){var i=n.getAttributeType(r),a=p[i];if(!a)return t;var u=a(e[r]);return{attrs:t.attrs.concat([r]),values:t.values.concat([u])}},{attrs:["guid"],values:[e.guid]});return{builder:r.attrs.reduce(function(t,e){return t.column(E(e))},(new c).into(E(t))),values:r.values}}function j(t){if(null==t)return null;var e=new f(t),n=20-Math.max(0,e.e)-1;return(e.s<0?"-":"")+new Array(n+1).join("0")+e.abs().toFixed()}function T(t){return null!=t?String(t):null}function x(t){return t}function k(t){for(var e=[],n=0;n<t.length;++n)e.push(t.item(n));return e}function E(t){return t.replace(".","$")}function D(t){return t.replace("$",".")}function O(t,e,n,r){var i,a={guid:r.guid,$objectType:t.getEntity(),$dirty:e,$readonlyAttrs:JSON.parse(n)};for(var u in r)if(!("guid"===(i=u)||i.indexOf(".")>-1)){var o=D(u),c=t.getAttributeType(o),s=m[c];s&&(a[o]=s(r[u]))}return a}function F(t,e){return t["".concat(d,".").concat(e)]}function S(t,e){return e=e||[],new s(function(n){return new l(function(r,i){n.executeSql(t,e,function(t,e){return i(e)},function(t,e){return r(e)})})})}t.exports=b},606:function(t,e,n){var r=n(20);Object.defineProperty(e,"__esModule",{value:!0}),e.constraintBuilder=e.SqlSelectBuilder=void 0;var i=r(n(33)),a=r(n(34)),u=n(594),o=function(){function t(e,n){(0,i.default)(this,t),this._select=n&&n.select||e&&e._select||null,this._from=n&&n.from||e&&e._from||null,this._join=n&&n.join||e&&e._join||null,this._constraints=n&&n.constraints||e&&e._constraints||[],this._orderBy=n&&n.orderBy||e&&e._orderBy||[],this._limit=n&&n.limit||e&&e._limit||null,this._offset=n&&n.offset||e&&e._offset||null}return(0,a.default)(t,[{key:"from",value:function(e){return new t(this,{from:e})}},{key:"join",value:function(e,n,r){return new t(this,{join:{tableName:e,joinOnColumn:n,selectedColumns:r}})}},{key:"where",value:function(e){return new t(this,{constraints:this._constraints.concat(e)})}},{key:"order",value:function(e,n){return new t(this,{orderBy:this._orderBy.concat([[e,n]])})}},{key:"limit",value:function(e){return new t(this,{limit:e})}},{key:"offset",value:function(e){return new t(this,{offset:e})}},{key:"selectDistinct",value:function(t){return Array.isArray(t)&&(t=t.join(", ")),"SELECT DISTINCT ".concat(t," ").concat(this._buildSql())}},{key:"selectCount",value:function(t){return"SELECT COUNT(*) AS ".concat(t)+this._buildSql()}},{key:"select",value:function(){var t=this,e="SELECT ".concat(this._from,".*");return this._join&&this._join.selectedColumns.forEach(function(n){e+=", ".concat(t._join.tableName,".[").concat(n,'] as "').concat(t._join.tableName,".").concat(n,'"')}),e+this._buildSql()}},{key:"_buildSql",value:function(){var t=this,e=" FROM ".concat(this._from," AS ").concat(this._from);return this._join&&(e+=" JOIN ".concat(this._join.tableName," AS ").concat(this._join.tableName," USING (").concat(this._join.joinOnColumn,")")),this._constraints.length>0&&(e+=" WHERE "+this._constraints.map(function(e){return e.build(t._from)}).join(" AND ")),this._orderBy.length>0&&(e+=" ORDER BY "+this._orderBy.map(function(e){return"".concat(t._from,".[").concat(e[0],"] ").concat(e[1])}).join(", ")),this._limit&&(e+=" LIMIT "+this._limit),this._offset&&(e+=" OFFSET "+this._offset),e}}]),t}();e.SqlSelectBuilder=o;var c={equals:h("="),lessThan:h("<"),lessThanOrEquals:h("<="),greaterThan:h(">"),greaterThanOrEquals:h(">="),contains:function(t){var e="";return e+=t,e+=" LIKE '%' || ? || '%'",e+=" ESCAPE '"+u.LIKE_ESCAPE_CHAR+"'"}},s=function(){function t(e,n,r){(0,i.default)(this,t),this._column=e,this._operator=n,this._negate=!!r}return(0,a.default)(t,[{key:"build",value:function(t){var e=c[this._operator],n=this._column.indexOf(".")>-1?this._column:"".concat(t,".[").concat(this._column,"]");return(this._negate?"NOT ":"")+e(n)}}]),t}(),l=function(){function t(e,n){(0,i.default)(this,t),this._column=e,this._negate=!!n}return(0,a.default)(t,[{key:"build",value:function(t){return(this._column.indexOf(".")>-1?this._column:"".concat(t,".[").concat(this._column,"]"))+" IS "+(this._negate?"NOT ":"")+"NULL"}}]),t}(),f=function(){function t(e,n){(0,i.default)(this,t),this.group=e,this.constraints=n||[]}return(0,a.default)(t,[{key:"add",value:function(t){this.constraints.push(t)}},{key:"build",value:function(t){return"("+this.constraints.map(function(e){return e.build(t)}).join(" ".concat(this.group," "))+")"}}]),t}(),d={and:function(t){return new f("and",t)},or:function(t){return new f("or",t)},equals:function(t,e){return new s(t,"equals",e)},isNull:function(t,e){return new l(t,e)},lessThan:function(t,e){return new s(t,"lessThan",e)},lessThanOrEquals:function(t,e){return new s(t,"lessThanOrEquals",e)},greaterThan:function(t,e){return new s(t,"greaterThan",e)},greaterThanOrEquals:function(t,e){return new s(t,"greaterThanOrEquals",e)},contains:function(t,e){return new s(t,"contains",e)}};function h(t){return function(e){return e+" "+t+" ?"}}e.constraintBuilder=d},607:function(t,e,n){var r=n(594);function i(t,e){this._tableName=e&&e.tableName||t&&t._tableName||null,this._columns=e&&e.columns||t&&t._columns||[]}function a(t){var e=r.QUOTE_CHAR;return e+t+e}i.prototype.table=function(t){return new i(this,{tableName:t})},i.prototype.column=function(t,e){return new i(this,{columns:this._columns.concat({columnName:t,columnType:e,isPrimary:!1})})},i.prototype.primaryKeyColumn=function(t,e){return new i(this,{columns:this._columns.concat({columnName:t,columnType:e,isPrimary:!0})})},i.prototype.createIfNotExists=function(){var t="";return t+="CREATE TABLE IF NOT EXISTS "+a(this._tableName),t+=this._buildSql()},i.prototype._buildSql=function(){var t="";return this._columns.length>0&&(t+=" (",t+=this._columns.map(function(t){return[a(t.columnName),t.columnType,"text"===t.columnType?" COLLATE NOCASE ":"",t.isPrimary?"PRIMARY KEY ":""].join(" ").slice(0,-1)},this).join(", "),t+=")"),t},t.exports=i},608:function(t,e,n){var r=n(594);function i(t,e){if(!(this instanceof i))return new i;this._tableName=e&&e.tableName||t&&t._tableName||null,this._columnNames=e&&e.columnNames||t&&t._columnNames||[]}function a(t){var e=r.QUOTE_CHAR;return e+t+e}i.prototype.into=function(t){return new i(this,{tableName:t})},i.prototype.column=function(t){return new i(this,{columnNames:this._columnNames.concat(t)})},i.prototype.insert=function(){var t="";return t+="INSERT INTO "+a(this._tableName),t+=this._buildSql()},i.prototype.insertOrReplace=function(){var t="";return t+="INSERT OR REPLACE INTO "+a(this._tableName),t+=this._buildSql()},i.prototype._buildSql=function(){var t="";return this._columnNames.length>0&&(t+=" (",t+=this._columnNames.map(a).join(", "),t+=")"),t+=" VALUES (",t+="?"+new Array(this._columnNames.length).join(", ?"),t+=")"},t.exports=i},609:function(t,e,n){t.exports=function(t){function e(t){this.run=t}return e.prototype.chain=function(t){return new e(function(e){return this.run(e).chain(function(n){return t(n).run(e)})}.bind(this))},e.prototype.ap=function(t){return new e(function(e){return this.run(e).ap(t.run(e))}.bind(this))},e.prototype.map=function(t){return this.chain(function(n){return e.of(t(n))})},e.of=function(n){return new e(function(e){return t.of(n)})},e.ask=function(){return new e(t.of)},e}},610:function(t,e,n){var r=n(595);function i(t){return function(e,n){return new r(function(r,i){var a,u=2;e[t](function(t){n.run(t).fork(r,function(t){a=t,0==--u&&i(a)})},r,function(){0==--u&&i(a)})})}}t.exports={runReadTransaction:i("readTransaction"),runWriteTransaction:i("transaction")}},611:function(t,e,n){var r=n(598),i=n(596);function a(){}a.prototype.getSlice=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this._getDatabase().then(this._fetchSlice(t,e,n))},a.prototype.getByGuid=function(t){return this._getDatabase().then(this._fetch(t))},a.prototype.insertOrReplace=function(t){return this._getDatabase().then(this._insertOrReplace(t))},a.prototype.cleanDatabase=function(){return this._getDatabase().then(this._cleanDatabase())},a.prototype.rebuildDatabase=function(t){var e=this;return this._getDatabase().then(function(n){return r.promiseFromTask(e._rebuildDb(t).run(n))})},a.prototype.fetchDirty=function(){var t=this;return this._getDatabase().then(function(e){return r.promiseFromTask(t._fetchDirty().run(e))})},a.prototype.makeClean=function(t){var e=this;return this._getDatabase().then(function(n){return r.promiseFromTask(e._makeClean(t).run(n))})},a.prototype.cleanupDirtyObjects=function(){return this._getDatabase().then(this._cleanupDirtyObjects())},a.prototype._getDatabase=function(){return Promise.reject(new Error("not implemented"))},a.prototype._initialize=function(){return Promise.reject(new Error("not implemented"))},a.prototype._fetch=function(t){return function(t){return Promise.reject(new Error("not implemented"))}},a.prototype._fetchSlice=function(t,e,n){return function(t){return Promise.reject(new Error("not implemented"))}},a.prototype._insertOrReplace=function(t){return function(t){return Promise.reject(new Error("not implemented"))}},a.prototype._cleanDatabase=function(){return function(t){return Promise.reject(new Error("not implemented"))}},a.prototype._rebuildDb=function(t){return i.rejected(new Error("not implemented"))},a.prototype._fetchDirty=function(){return i.rejected(new Error("not implemented"))},a.prototype._makeClean=function(){return i.rejected(new Error("not implemented"))},a.prototype._cleanupDirtyObjects=function(){return function(t){return Promise.reject(new Error("not implemented"))}},t.exports=a}}]);