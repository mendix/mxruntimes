/* @preserve
    Copyright (c) 2005-2016, Mendix bv. All rights reserved.
    See mxclientsystem/licenses.txt for third party licenses that apply.
*/
(window.mxJsonp=window.mxJsonp||[]).push([[2],{519:function(t,e){t.exports={LIKE_ESCAPE_CHAR:"~",QUOTE_CHAR:'"'}},520:function(t,e){function n(t){this.fork=t}n.of=function(t){return new n(function(e,n){n(t)})},n.prototype.chain=function(t){var e=this;return new n(function(n,r){e.fork(n,function(e){t(e).fork(n,r)})})},n.prototype.orElse=function(t){var e=this;return new n(function(n,r){e.fork(function(e){t(e).fork(n,r)},r)})},n.prototype.ap=function(t){var e,r,i,u=this,o=2;return new n(function(n,a){function c(){0==--o&&a(e(r))}function s(t){void 0===i&&n(i=t)}u.fork(s,function(t){e=t,c()}),t.fork(s,function(t){r=t,c()})})},n.prototype.map=function(t){return this.chain(function(e){return n.of(t(e))})},n.rejected=n.prototype.rejected=function(t){return new n(function(e,n){e(t)})},n.parallel=function(t){return new n(function(e,n){var r,i=t.length,u=new Array(t.length);0!==t.length?t.forEach(function(t,o){t.fork(function(t){void 0===r&&(r=t,e(t))},function(t){return function(e){u[t]=e,void 0===r&&0==--i&&n(u)}}(o))}):n(u)})},n.sequence=function(t){return t.reduce(function(t,e){return t.chain(function(t){return e})},n.of(null))},t.exports=n},521:function(t,e,n){var r=n(531),i=n(520),u=new r(i);u.rejected=function(t){return new u(function(e){return i.rejected(t)})},u.parallel=function(t){return new u(function(e){return new i(function(n,r){if(0!==t.length){var i=new Array(t.length),u=t.length,o=!1;t.forEach(function(t,a){t.run(e).fork(function(t){o||(o=!0,n(t))},function(t){i[a]=t,o||0!=--u||r(i)})})}else r([])})})},u.sequence=function(t){return t.reduce(function(t,e){return t.chain(function(t){return e.map(function(e){return t.concat([e])})})},u.of([]))},t.exports=u},522:function(t,e,n){var r=n(520),i={promiseFromTask:function(t){return new Promise(function(e,n){t.fork(n,e)})},callbackFromTask:function(t,e,n){t.fork(function(t){n&&n(t)},function(t){e&&e(t)})},taskFromPromise:function(t){return new r(function(e,n){t.then(n,e)})}};t.exports=i},526:function(t,e,n){var r=n(527),i=n(532),u=n(533),o=n(521),a=n(522);function c(){return window.openDatabase("MendixDatabase","1","Mendix Database",10485760)}function s(t,e){u.call(this),e=e||c,this._tableNames=t;var n=e();this._databasePromise=this._initialize(n)}s.prototype=Object.create(u.prototype),s.prototype._getDatabase=function(){return this._databasePromise},s.prototype._initialize=function(t){var e=r.createCreateTransaction(this._tableNames);return a.promiseFromTask(i.runWriteTransaction(t,e)).then(function(){return t})},s.prototype._fetch=function(t){return function(e){var n=r.createFetchByGuidTransaction(t);return a.promiseFromTask(i.runReadTransaction(e,n))}},s.prototype._fetchSlice=function(t,e,n){return function(u){var o=r.createFetchSliceTransaction(t,e,n.offset,n.limit,n.sort);return a.promiseFromTask(i.runReadTransaction(u,o))}},s.prototype._rebuildDb=function(t){return o.ask().chain(function(e){var n=r.createRebuildTransaction(this._tableNames,t);return new o(function(t){return i.runWriteTransaction(e,n)})}.bind(this))},s.prototype._insertOrReplace=function(t){return function(e){var n=r.createInsertOrReplaceTransaction(t);return a.promiseFromTask(i.runWriteTransaction(e,n))}},s.prototype._cleanDatabase=function(){var t=this;return function(e){var n=r.createCleanTransaction(t._tableNames);return a.promiseFromTask(i.runWriteTransaction(e,n))}},s.prototype._fetchDirty=function(){return o.ask().chain(function(t){var e=r.createFetchDirtyObjectsTransaction();return new o(function(n){return i.runWriteTransaction(t,e)})})},s.prototype._makeClean=function(t){return o.ask().chain(function(e){var n=r.createMakeCleanTransaction(t);return new o(function(t){return i.runWriteTransaction(e,n)})})},s.prototype._cleanupDirtyObjects=function(){return function(t){var e=r.createDirtyCleanupTransaction();return a.promiseFromTask(i.runWriteTransaction(t,e))}},t.exports=s},527:function(t,e,n){var r=n(519),i=n(528),u=i.SqlSelectBuilder,o=i.constraintBuilder,a=n(529),c=n(530),s=n(521),l=n(520),f=n(10),m="_guidToTable",p={String:"text",Integer:"text",Long:"text",Decimal:"text",Float:"text",Currency:"text",Enum:"text",HashString:"text",ObjectReference:"text",DateTime:"integer",Boolean:"integer",AutoNumber:"integer",Binary:"blob"},h={String:E,Integer:j,Long:j,Decimal:j,Float:j,Currency:j,Enum:E,HashString:E,ObjectReference:E,DateTime:function(t){return null!=t?Number(t):null},Boolean:Number,AutoNumber:E,Binary:E},y={String:E,Integer:E,Long:E,Decimal:E,Float:E,Currency:E,Enum:E,HashString:E,ObjectReference:E,DateTime:T,Boolean:Boolean,AutoNumber:E,Binary:E},d={String:T,Integer:T,Long:T,Decimal:T,Float:T,Currency:T,Enum:T,HashString:T,ObjectReference:T,DateTime:function(t){return t?Number(t):null},Boolean:function(t){return"false"!==t},AutoNumber:T,Binary:T},b={createCreateTransaction:g,createCleanTransaction:function(t){var e=[m].concat(t).map(O).map(function(t){return"DELETE FROM '"+t+"'"}).map(function(t){return C(t,[])});return s.parallel(e).map(function(t){})},createFetchByGuidTransaction:function(t){return C((new u).from(m).where(o.equals("guid")).select(),[t]).chain(function(e){if(0===e.rows.length)return s.of(null);if(1!==e.rows.length)return s.rejected(new Error("db consistency error"));var n=e.rows.item(0),r=n.tableName,i=Boolean(n.dirty),a=n.readonlyAttrs;return C((new u).from(O(r)).where(o.equals("guid")).select(),[t]).chain(function(t){return 0===t.rows.length?s.rejected(new Error("entity not found")):1!==t.rows.length?s.rejected(new Error("db consistency error")):s.of(R(window.mx.meta.getEntity(r),i,a,t.rows.item(0)))})})},createFetchSliceTransaction:function(t,e,n,i,a){e=e||[],a=a||[];var c=window.mx.meta.getEntity(t),l=function(t,e){var n=[];return{builder:(new u).where(e.map(function e(i){if(i.constraints)return o[i.operator](i.constraints.map(e).filter(function(t){return null!==t}));if(null==i.value)switch(i.operator){case"contains":return null;case"equals":return o.isNull(O(i.attribute),i.negate)}var u=t.getAttributeType(i.attribute);var a=d[u];var c=h[u];var s=c(a(i.value));n.push("contains"===i.operator?function(t){var e=r.LIKE_ESCAPE_CHAR;return t.replace(new RegExp(e,"g"),e+e).replace(/%/g,e+"%").replace(/_/g,e+"_")}(s):s);return o[i.operator](O(i.attribute),i.negate)}).filter(function(t){return null!==t})),args:n}}(c,e),f=l.builder.from(O(t)),p=l.args,y=f.offset(n).limit(i).join(m,"guid",["dirty","readonlyAttrs"]),b=C((y=a.reduce(function(t,e){return t.order(e[0],e[1])},y)).select(),p).map(function(t){for(var e=[],n=0;n<t.rows.length;++n){var r=t.rows.item(n),i=Boolean(r[m+".dirty"]),u=D(r,"readonlyAttrs");e.push(R(c,i,u,r))}return e}),g=C(f.selectCount("cnt"),p).map(function(t){return t.rows.item(0).cnt});return s.parallel([b,g])},createInsertOrReplaceTransaction:function(t){return s.parallel(t.map(function(t){var e=t.$objectType,n=_(),r=w(e,t);return[C(n.insertOrReplace(),[t.guid,e,1,JSON.stringify(t.$readonlyAttrs)]),C(r.builder.insertOrReplace(),r.values)]}).reduce(function(t,e){return t.concat(e)},[])).map(function(t){})},createFetchDirtyObjectsTransaction:function(){return v().chain(function(t){var e=x(t.rows).map(function(t){var e=t.tableName,n=(new u).from(O(e)).join(m,"guid",["dirty","readonlyAttrs"]).where(o.equals(m+".dirty")).select(),r=window.mx.meta.getEntity(e);return C(n,[1]).map(function(t){return x(t.rows).map(function(t){return R(r,!0,D(t,"readonlyAttrs"),t)})})});return s.parallel(e)}).map(function(t){return t.reduce(function(t,e){return t.concat(e)},[])})},createMakeCleanTransaction:function(t){var e=t.map(function(t){return C("UPDATE "+m+" set dirty = 0 where guid = ?",[t.guid])});return s.parallel(e).map(function(t){})},createDirtyCleanupTransaction:function(){return v().chain(function(t){var e=x(t.rows).map(function(t){var e=t.tableName;return C("DELETE FROM "+O(e)+" WHERE guid IN (\n                            SELECT guid FROM "+m+" WHERE tableName = ? AND dirty = 1)",[e])});return s.sequence([s.parallel(e),C("DELETE FROM "+m+" WHERE dirty = 1")]).map(function(t){})})},createRebuildTransaction:function(t,e){var n=function(t){var e=[m].concat(t).map(O).map(function(t){return"DROP TABLE IF EXISTS '"+t+"'"}).map(function(t){return C(t,[])});return s.sequence([s.parallel(e),g(t)])}(t),r=t.map(function(t){var n=e.filter(function(e){return e.$objectType===t});return function(t,e){var n=e.reduce(function(e,n){var r=_(),i=w(t,n);return e.concat([C(r.insert(),[n.guid,t,0,JSON.stringify(n.$readonlyAttrs)]),C(i.builder.insert(),i.values)])},[]);return s.parallel(n).map(function(t){})}(t,n)});return s.sequence([n,s.parallel(r)]).map(function(t){})}};function g(t){var e=[C((new a).table(m).primaryKeyColumn("guid","text").column("tableName","text").column("dirty","boolean").column("readonlyAttrs","text").createIfNotExists(),[])].concat(t.map(function(t){return C(function(t){var e=window.mx.meta.getEntity(t);return e.getAttributes().map(function(t){var n=e.getAttributeType(t);return{attr:t,type:p[n]}})}(t).reduce(function(t,e){return t.column(O(e.attr),e.type)},(new a).table(O(t)).primaryKeyColumn("guid","text")).createIfNotExists(),[])}));return s.parallel(e).map(function(t){})}function v(){return C((new u).from(m).where(o.equals("dirty")).selectDistinct("tableName"),[1])}function _(){return(new c).into(m).column("guid").column("tableName").column("dirty").column("readonlyAttrs")}function w(t,e){var n=window.mx.meta.getEntity(t),r=n.getAttributes().reduce(function(t,r){var i=n.getAttributeType(r),u=h[i];if(!u)return t;var o=u(e[r]);return{attrs:t.attrs.concat([r]),values:t.values.concat([o])}},{attrs:["guid"],values:[e.guid]});return{builder:r.attrs.reduce(function(t,e){return t.column(O(e))},(new c).into(O(t))),values:r.values}}function j(t){if(null==t)return null;var e=new f(t),n=20-Math.max(0,e.e)-1;return(e.s<0?"-":"")+new Array(n+1).join("0")+e.abs().toFixed()}function E(t){return null!=t?String(t):null}function T(t){return t}function x(t){for(var e=[],n=0;n<t.length;++n)e.push(t.item(n));return e}function O(t){return t.replace(".","$")}function k(t){return t.replace("$",".")}function R(t,e,n,r){var i={guid:r.guid,$objectType:t.getEntity(),$dirty:e,$readonlyAttrs:JSON.parse(n)};for(var u in r)if(!s(u)){var o=k(u),a=t.getAttributeType(o),c=y[a];c&&(i[o]=c(r[u]))}return i;function s(t){return"guid"===t||t.indexOf(".")>-1}}function D(t,e){return t[m+"."+e]}function C(t,e){return e=e||[],new s(function(n){return new l(function(r,i){n.executeSql(t,e,function(t,e){return i(e)},function(t,e){return r(e)})})})}t.exports=b},528:function(t,e,n){"use strict";n.r(e),n.d(e,"SqlSelectBuilder",function(){return o}),n.d(e,"constraintBuilder",function(){return f});var r=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var u=n(519),o=function(){function t(e,n){i(this,t),this._select=n&&n.select||e&&e._select||null,this._from=n&&n.from||e&&e._from||null,this._join=n&&n.join||e&&e._join||null,this._constraints=n&&n.constraints||e&&e._constraints||[],this._orderBy=n&&n.orderBy||e&&e._orderBy||[],this._limit=n&&n.limit||e&&e._limit||null,this._offset=n&&n.offset||e&&e._offset||null}return r(t,[{key:"from",value:function(e){return new t(this,{from:e})}},{key:"join",value:function(e,n,r){return new t(this,{join:{tableName:e,joinOnColumn:n,selectedColumns:r}})}},{key:"where",value:function(e){return new t(this,{constraints:this._constraints.concat(e)})}},{key:"order",value:function(e,n){return new t(this,{orderBy:this._orderBy.concat([[e,n]])})}},{key:"limit",value:function(e){return new t(this,{limit:e})}},{key:"offset",value:function(e){return new t(this,{offset:e})}},{key:"selectDistinct",value:function(t){return Array.isArray(t)&&(t=t.join(", ")),"SELECT DISTINCT "+t+" "+this._buildSql()}},{key:"selectCount",value:function(t){return"SELECT COUNT(*) AS "+t+this._buildSql()}},{key:"select",value:function(){var t=this,e="SELECT "+this._from+".*";return this._join&&this._join.selectedColumns.forEach(function(n){e+=", "+t._join.tableName+".["+n+'] as "'+t._join.tableName+"."+n+'"'}),e+this._buildSql()}},{key:"_buildSql",value:function(){var t=this,e=" FROM "+this._from+" AS "+this._from;return this._join&&(e+=" JOIN "+this._join.tableName+" AS "+this._join.tableName+" USING ("+this._join.joinOnColumn+")"),this._constraints.length>0&&(e+=" WHERE "+this._constraints.map(function(e){return e.build(t._from)}).join(" AND ")),this._orderBy.length>0&&(e+=" ORDER BY "+this._orderBy.map(function(e){return t._from+".["+e[0]+"] "+e[1]}).join(", ")),this._limit&&(e+=" LIMIT "+this._limit),this._offset&&(e+=" OFFSET "+this._offset),e}}]),t}(),a={equals:m("="),lessThan:m("<"),lessThanOrEquals:m("<="),greaterThan:m(">"),greaterThanOrEquals:m(">="),contains:function(t){var e="";return e+=t,e+=" LIKE '%' || ? || '%'",e+=" ESCAPE '"+u.LIKE_ESCAPE_CHAR+"'"}},c=function(){function t(e,n,r){i(this,t),this._column=e,this._operator=n,this._negate=!!r}return r(t,[{key:"build",value:function(t){var e=a[this._operator],n=this._column.indexOf(".")>-1?this._column:t+".["+this._column+"]";return(this._negate?"NOT ":"")+e(n)}}]),t}(),s=function(){function t(e,n){i(this,t),this._column=e,this._negate=!!n}return r(t,[{key:"build",value:function(t){return(this._column.indexOf(".")>-1?this._column:t+".["+this._column+"]")+" IS "+(this._negate?"NOT ":"")+"NULL"}}]),t}(),l=function(){function t(e,n){i(this,t),this.group=e,this.constraints=n||[]}return r(t,[{key:"add",value:function(t){this.constraints.push(t)}},{key:"build",value:function(t){return"("+this.constraints.map(function(e){return e.build(t)}).join(" "+this.group+" ")+")"}}]),t}(),f={and:function(t){return new l("and",t)},or:function(t){return new l("or",t)},equals:function(t,e){return new c(t,"equals",e)},isNull:function(t,e){return new s(t,e)},lessThan:function(t,e){return new c(t,"lessThan",e)},lessThanOrEquals:function(t,e){return new c(t,"lessThanOrEquals",e)},greaterThan:function(t,e){return new c(t,"greaterThan",e)},greaterThanOrEquals:function(t,e){return new c(t,"greaterThanOrEquals",e)},contains:function(t,e){return new c(t,"contains",e)}};function m(t){return function(e){return e+" "+t+" ?"}}},529:function(t,e,n){var r=n(519);function i(t,e){this._tableName=e&&e.tableName||t&&t._tableName||null,this._columns=e&&e.columns||t&&t._columns||[]}function u(t){var e=r.QUOTE_CHAR;return e+t+e}i.prototype.table=function(t){return new i(this,{tableName:t})},i.prototype.column=function(t,e){return new i(this,{columns:this._columns.concat({columnName:t,columnType:e,isPrimary:!1})})},i.prototype.primaryKeyColumn=function(t,e){return new i(this,{columns:this._columns.concat({columnName:t,columnType:e,isPrimary:!0})})},i.prototype.createIfNotExists=function(){var t="";return t+="CREATE TABLE IF NOT EXISTS "+u(this._tableName),t+=this._buildSql()},i.prototype._buildSql=function(){var t="";return this._columns.length>0&&(t+=" (",t+=this._columns.map(function(t){return[u(t.columnName),t.columnType,"text"===t.columnType?" COLLATE NOCASE ":"",t.isPrimary?"PRIMARY KEY ":""].join(" ").slice(0,-1)},this).join(", "),t+=")"),t},t.exports=i},530:function(t,e,n){var r=n(519);function i(t,e){if(!(this instanceof i))return new i;this._tableName=e&&e.tableName||t&&t._tableName||null,this._columnNames=e&&e.columnNames||t&&t._columnNames||[]}function u(t){var e=r.QUOTE_CHAR;return e+t+e}i.prototype.into=function(t){return new i(this,{tableName:t})},i.prototype.column=function(t){return new i(this,{columnNames:this._columnNames.concat(t)})},i.prototype.insert=function(){var t="";return t+="INSERT INTO "+u(this._tableName),t+=this._buildSql()},i.prototype.insertOrReplace=function(){var t="";return t+="INSERT OR REPLACE INTO "+u(this._tableName),t+=this._buildSql()},i.prototype._buildSql=function(){var t="";return this._columnNames.length>0&&(t+=" (",t+=this._columnNames.map(u).join(", "),t+=")"),t+=" VALUES (",t+="?"+new Array(this._columnNames.length).join(", ?"),t+=")"},t.exports=i},531:function(t,e){t.exports=function(t){function e(t){this.run=t}return e.prototype.chain=function(t){return new e(function(e){return this.run(e).chain(function(n){return t(n).run(e)})}.bind(this))},e.prototype.ap=function(t){return new e(function(e){return this.run(e).ap(t.run(e))}.bind(this))},e.prototype.map=function(t){return this.chain(function(n){return e.of(t(n))})},e.of=function(n){return new e(function(e){return t.of(n)})},e.ask=function(){return new e(t.of)},e}},532:function(t,e,n){var r=n(520);function i(t){return function(e,n){return new r(function(r,i){var u,o=2;e[t](function(t){n.run(t).fork(r,function(t){u=t,0==--o&&i(u)})},r,function(){0==--o&&i(u)})})}}t.exports={runReadTransaction:i("readTransaction"),runWriteTransaction:i("transaction")}},533:function(t,e,n){var r=n(522),i=n(521);function u(){}u.prototype.getSlice=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this._getDatabase().then(this._fetchSlice(t,e,n))},u.prototype.getByGuid=function(t){return this._getDatabase().then(this._fetch(t))},u.prototype.insertOrReplace=function(t){return this._getDatabase().then(this._insertOrReplace(t))},u.prototype.cleanDatabase=function(){return this._getDatabase().then(this._cleanDatabase())},u.prototype.rebuildDatabase=function(t){var e=this;return this._getDatabase().then(function(n){return r.promiseFromTask(e._rebuildDb(t).run(n))})},u.prototype.fetchDirty=function(){var t=this;return this._getDatabase().then(function(e){return r.promiseFromTask(t._fetchDirty().run(e))})},u.prototype.makeClean=function(t){var e=this;return this._getDatabase().then(function(n){return r.promiseFromTask(e._makeClean(t).run(n))})},u.prototype.cleanupDirtyObjects=function(){return this._getDatabase().then(this._cleanupDirtyObjects())},u.prototype._getDatabase=function(){return Promise.reject(new Error("not implemented"))},u.prototype._initialize=function(){return Promise.reject(new Error("not implemented"))},u.prototype._fetch=function(t){return function(t){return Promise.reject(new Error("not implemented"))}},u.prototype._fetchSlice=function(t,e,n){return function(t){return Promise.reject(new Error("not implemented"))}},u.prototype._insertOrReplace=function(t){return function(t){return Promise.reject(new Error("not implemented"))}},u.prototype._cleanDatabase=function(){return function(t){return Promise.reject(new Error("not implemented"))}},u.prototype._rebuildDb=function(t){return i.rejected(new Error("not implemented"))},u.prototype._fetchDirty=function(){return i.rejected(new Error("not implemented"))},u.prototype._makeClean=function(){return i.rejected(new Error("not implemented"))},u.prototype._cleanupDirtyObjects=function(){return function(t){return Promise.reject(new Error("not implemented"))}},t.exports=u},551:function(t,e,n){"use strict";n.r(e);var r=n(526),i=n(9);function u(t){return t.replace(/:/g,"_")}var o="GUID:",a=new RegExp("^"+o);function c(t){return!a.test(t)}function s(t){return"guid"===t||"$"===t[0]}function l(t,e){return t.$readonlyAttrs.includes(e)}function f(t){var e=Object.keys(t).filter(function(t){return!s(t)}).reduce(function(e,n){return e[n]={value:t[n]},l(t,n)&&(e[n].readonly=!0),e},{});return{guid:t.guid,objectType:t.$objectType,attributes:e}}function m(t){var e={guid:t.guid,$objectType:t.objectType,$readonlyAttrs:[]};for(var n in t.attributes)e[n]=t.attributes[n].value,t.attributes[n].readonly&&e.$readonlyAttrs.push(n);return e}var p=n(83),h=n(24),y=n(290),d=function(){return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],r=!0,i=!1,u=void 0;try{for(var o,a=t[Symbol.iterator]();!(r=(o=a.next()).done)&&(n.push(o.value),!e||n.length!==e);r=!0);}catch(t){i=!0,u=t}finally{try{!r&&a.return&&a.return()}finally{if(i)throw u}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),b=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();function g(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}var v=n(9),_={String:null,Integer:"0",Long:"0",Decimal:"0",Float:"0",Currency:"0",Enum:null,HashString:null,ObjectReference:null,DateTime:null,Boolean:!1,AutoNumber:"0",Binary:null},w=function(t){function e(t,n,r,i,u){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);var o=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t=t||{},o._store=r,o._getDocumentUrl=t.getDocumentUrlFn||E,o._objectCache=n,o._fileBackend=i,o._synchronizer=u,o._dirtyGuids=[],o}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,y["a"]),b(e,[{key:"initialize",value:function(){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(this._store.fetchDirty());case 2:t=e.sent,this._dirtyGuids=t.map(function(t){return t.guid});case 4:case"end":return e.stop()}},null,this)}},{key:"getByGuid",value:function(t,e){return Promise.all(t.map(this._getByGuid,this)).then(function(t){return{mxobjects:t.filter(function(t){return null!=t}).map(f)}})}},{key:"getByPath",value:function(t,e,n,r){var i,u,o,a,c,s,l,f,m,p,y,b,g,v,_=this;return regeneratorRuntime.async(function(w){for(;;)switch(w.prev=w.next){case 0:if("reverse"!==r){w.next=11;break}return i=this._objectCache.getAllObjects().filter(function(n){return n.getReferences(e).includes(t)}).map(function(t){return t.jsonData}),w.next=4,regeneratorRuntime.awrap(this.getSlice(n,[{attribute:e,operator:"equals",value:t}]));case 4:return u=w.sent,o=u.mxobjects,a=o.map(function(t){return h.MxObject.fromJson(t)}).filter(function(n){return n.getReferences(e).includes(t)}),c=a.filter(function(t){return!i.some(function(e){return e.guid===t.getGuid()})}).map(function(t){return t.jsonData}),w.abrupt("return",{mxobjects:i.concat(c)});case 11:if(s=this._objectCache.getObject(t)){w.next=19;break}return w.next=15,regeneratorRuntime.awrap(this.getByGuid([t]));case 15:l=w.sent,f=d(l.mxobjects,1),(m=f[0])&&(s=h.MxObject.fromJson(m));case 19:if(s){w.next=21;break}return w.abrupt("return",{mxobjects:[]});case 21:return p=s.getReferences(e),y=p.map(function(t){return _._objectCache.getObject(t)}).filter(function(t){return null!==t}).map(function(t){return t.jsonData}),b=p.filter(function(t){return!_._objectCache.has(t)}),w.next=26,regeneratorRuntime.awrap(this.getByGuid(b));case 26:return g=w.sent,v=g.mxobjects,w.abrupt("return",{mxobjects:v.concat(y)});case 29:case"end":return w.stop()}},null,this)}},{key:"getSlice",value:function(t,e,n){var r=this,i=window.mx.meta.getEntity(t),u=(e||[]).map(function(t){return t.attribute&&i.isReference(t.attribute)&&(t.value=r._synchronizer.getInternalGuid(t.value)),t});return this._store.getSlice(t,u,n).then(function(t){var e=d(t,2),n=e[0],i=e[1];return{mxobjects:n.map(r._synchronizer.makeObjectExternal,r._synchronizer).map(f),count:i}})}},{key:"create",value:function(t){var e=o+i.getUniqueId();return this._objectCache.onCreate([e]),this._objectCache.setMxObjects([function(t,e){var n={guid:t,objectType:e,attributes:{}},r=window.mx.meta.getEntity(e);return r.getAttributes().forEach(function(t){n.attributes[t]={value:_[r.getAttributeType(t)]}}),n}(e,t)]),Promise.resolve({actionResult:e})}},{key:"commit",value:function(t,e){var n,r,i,u,o,a,c,s,l,m,p,h=this;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return p=function(t){var e={};return Object.keys(t).forEach(function(n){e[n]=Object.keys(t[n])}),e},m=function(t){return Object.assign({},t,v.mapObject(r[t.guid],function(t){return t.value}))},r=v.objectFromArray(t.map(function(t){return[t,v.clone(h._objectCache.getChanges(t))]})),i=v.partition(function(t){return h._objectCache.has(t)},t),u=d(i,2),o=u[0],a=u[1],c=o.map(function(t){return h._objectCache.getObject(t)}).map(j),e.next=7,regeneratorRuntime.awrap(Promise.all(a.map(this._getByGuid,this)));case 7:return s=e.sent,l=s.concat(c).map(m),e.next=11,regeneratorRuntime.awrap(this._store.insertOrReplace(l.map(this._synchronizer.makeObjectInternal,this._synchronizer)));case 11:return(n=this._dirtyGuids).push.apply(n,g(t)),this._objectCache.onCommit(t),this._objectCache.setMxObjects(l.map(function(t){return f(Object.assign(t,{$dirty:!0}))})),this._objectCache.removeChanges(p(r)),e.abrupt("return",{});case 16:case"end":return e.stop()}},null,this)}},{key:"rollback",value:function(t){var e=this;this._objectCache.removeAllChanges(t);var n=t.filter(function(t){return e._objectCache.isNew(t)});return this._objectCache.removeObjects(n),Promise.resolve({})}},{key:"validate",value:function(t){return Promise.resolve({})}},{key:"saveDocument",value:function(t,e,n,r){var i=this;if(r.size/1048576>n.maxFileSize)return Promise.reject(new p.DescribedError("File too large"));var o=u(this._synchronizer.getInternalGuid(t));return this._fileBackend.storeFile(r,"files/documents/"+o).then(function(){return i._objectCache.makeChange(t,"HasContents",!0),i.commit([t],null)})}},{key:"getDocumentUrl",value:function(t,e,n){return this._getDocumentUrl(u(this._synchronizer.getInternalGuid(t)),e,n)}},{key:"getImageUrl",value:function(t){return Promise.resolve(t)}},{key:"upload",value:function(){return this._synchronizer.upload()}},{key:"downloadObjects",value:function(t){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(this._synchronizer.downloadObjects(t));case 2:this._dirtyGuids=[];case 3:case"end":return e.stop()}},null,this)}},{key:"downloadFiles",value:function(t){return this._synchronizer.downloadFiles(t)}},{key:"cleanupDirtyObjects",value:function(){return this._store.cleanupDirtyObjects()}},{key:"isDirty",value:function(t){return this._dirtyGuids.includes(t)}},{key:"cleanup",value:function(){return regeneratorRuntime.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(this._store.cleanDatabase());case 2:return t.next=4,regeneratorRuntime.awrap(this._fileBackend.removeDir("files/documents/"));case 4:return t.next=6,regeneratorRuntime.awrap(this._fileBackend.removeDir("files/thumbnails/"));case 6:this._dirtyGuids=[];case 7:case"end":return t.stop()}},null,this)}},{key:"_getByGuid",value:function(t){var e=this;return this._store.getByGuid(this._synchronizer.getInternalGuid(t)).then(function(t){return e._synchronizer.makeObjectExternal(t)})}}]),e}();function j(t){return m(t.jsonData)}function E(t,e,n){var r=n?"thumbnails":"documents";return"filesystem:"+window.mx.appUrl+"temporary/files/"+r+"/"+t+"?"+ +new Date}var T=n(23),x=n(172),O=n(44),k=n(9),R=n.n(k),D=n(13),C=function(){return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],r=!0,i=!1,u=void 0;try{for(var o,a=t[Symbol.iterator]();!(r=(o=a.next()).done)&&(n.push(o.value),!e||n.length!==e);r=!0);}catch(t){i=!0,u=t}finally{try{!r&&a.return&&a.return()}finally{if(i)throw u}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),S=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();var A=function(){function t(e,n,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._store=e,this._fileBackend=n,this._objectCache=r,this._internalToExternal={}}return S(t,[{key:"upload",value:function(){var t,e,n,r,i,o,a,f,m,p,h,y,d,b,g,v,_,w,j,E,O,k,S,A=this;return regeneratorRuntime.async(function(N){for(;;)switch(N.prev=N.next){case 0:return S=function(t,e){var n=window.mx.meta.getEntity(t.$objectType),r=Object.keys(t).filter(function(e){return!s(e)&&n.isSyncable(e)&&!l(t,e)}).map(function(r){var i=t[r];return[r,{value:n.isObjectReference(r)&&null!=i&&!c(i)?e[i]:i}]});return[c(t.guid)?t.guid:e[t.guid],R.a.objectFromArray(r)]},k=function(t){return Object(T.h)(t.$objectType).then(function(e){var n=e.objects.find(function(t){return t.guid===e.actionResult});return{internalObj:t,remoteJson:n}})},O=function(e){var n,r,i;return regeneratorRuntime.async(function(o){for(;;)switch(o.prev=o.next){case 0:return n="files/documents/"+u(e.guid),o.next=3,regeneratorRuntime.awrap(t.readFile(n));case 3:return r=o.sent,o.next=6,regeneratorRuntime.awrap(Object(D.uploadWithRetries)("__sync__","",r,2));case 6:return i=o.sent,o.abrupt("return",{tempGuid:i.commits[0],fileObjGuid:e.guid});case 8:case"end":return o.stop()}},null,this)},E=function(t){return window.mx.meta.getEntity(t.$objectType).isA("System.FileDocument")&&t.HasContents},j=function(t){var e=window.mx.meta.getEntity(t.$objectType);return R.a.arrayFromObject(t).filter(function(t){var n=C(t,2),r=n[0];n[1];return"guid"===r||!s(r)&&e.isReference(r)})},w=function(t){var e=t.map(function(t){return t.guid}),n=R.a.unique(t.map(function(t){return j(t).map(function(t){var e=C(t,2);e[0];return e[1]})}).reduce(function(t,e){return t.concat(e)},[])).filter(function(t){return!c(t)}).filter(function(t){return!e.includes(t)});if(n.length>0){var r="Sync has failed due to a modeling error. Your database contains objects that reference uncommitted objects:\n"+R.a.unique(t.map(function(t){return j(t).filter(function(t){var e=C(t,2),r=(e[0],e[1]);return n.includes(r)}).map(function(e){var n=C(e,2),r=n[0];n[1];return"object of type "+t.$objectType+" (reference "+r+")"})}).reduce(function(t,e){return t.concat(e)},[])).join(", ")+".";throw new x.a(r)}},t=this._fileBackend,N.next=9,regeneratorRuntime.awrap(this._store.fetchDirty());case 9:if(0!==(e=N.sent).length){N.next=12;break}return N.abrupt("return",{});case 12:return w(e),n=R.a.partition(function(t){return c(t.guid)},e),r=C(n,2),i=r[0],o=r[1],a=o.filter(E),f=i.filter(E),N.next=18,regeneratorRuntime.awrap(Promise.all([Promise.all(a.concat(f).map(O)),Promise.all(o.map(k))]));case 18:return m=N.sent,p=C(m,2),h=p[0],y=p[1],d=R.a.objectFromArray(y.map(function(t){var e=t.internalObj,n=t.remoteJson;return[e.guid,n.guid]})),b=R.a.objectFromArray(h.map(function(t){var e=t.tempGuid,n=t.fileObjGuid;return c(n)?[e,n]:[e,d[n]]})),g=i.map(function(t){return t.guid}).concat(y.map(function(t){return t.remoteJson.guid})),v=y.map(function(t){return t.remoteJson}),_=R.a.objectFromArray(e.map(function(t){return S(t,d)})),N.next=29,regeneratorRuntime.awrap(Object(T.v)(g,b,_,v));case 29:return N.next=31,regeneratorRuntime.awrap(this._store.makeClean(e));case 31:return N.next=33,regeneratorRuntime.awrap(Promise.all(a.map(function(e){var n,r;return regeneratorRuntime.async(function(i){for(;;)switch(i.prev=i.next){case 0:return n="files/documents/"+u(e.guid),r="files/documents/"+u(d[e.guid]),i.next=4,regeneratorRuntime.awrap(t.moveFile(n,r));case 4:case"end":return i.stop()}},null,A)})));case 33:return R.a.arrayFromObject(d).forEach(function(t){var e=C(t,2),n=e[0],r=e[1];return A._mapInternalGuid(n,r)}),N.abrupt("return",{});case 35:case"end":return N.stop()}},null,this)}},{key:"downloadObjects",value:function(t){var e,n,r,i=this;return regeneratorRuntime.async(function(u){for(;;)switch(u.prev=u.next){case 0:return r=function(t,e){return Object(T.t)(e).then(function(e){return e.mxobjects.map(m).map(function(e){return Object.assign({},e,{$objectType:t})})})},u.t0=R.a,u.next=4,regeneratorRuntime.awrap(Promise.all(t.map(function(t){return r(t.store,t.xpath)})));case 4:return u.t1=u.sent,e=u.t0.flatten.call(u.t0,u.t1),u.next=8,regeneratorRuntime.awrap(this._store.rebuildDatabase(e));case 8:return n=e.map(this.makeObjectExternal,this).filter(function(t){return i._objectCache.has(t.guid)}),this._objectCache.setMxObjects(n.map(f)),u.abrupt("return",{});case 11:case"end":return u.stop()}},null,this)}},{key:"downloadFiles",value:function(t){var e,n,r,i,o,a,c;return regeneratorRuntime.async(function(s){for(;;)switch(s.prev=s.next){case 0:return c=function(t,e){var r=Object(O.getRemoteDynamicResourceUrl)(t.guid,t.changedDate,e),i=(e?"files/thumbnails/":"files/documents/")+u(t.guid);return n.downloadFile(r,i)},a=function(t){return e.getSlice(t,[{attribute:"HasContents",operator:"equals",value:"true"}]).then(function(t){var e=C(t,2),n=e[0];e[1];return n})},e=this._store,n=this._fileBackend,s.t0=R.a,s.next=7,regeneratorRuntime.awrap(Promise.all(t.map(function(t){return a(t)})));case 7:return s.t1=s.sent,r=s.t0.flatten.call(s.t0,s.t1),i=r.map(function(t){return c(t,!1)}),o=r.filter(function(t){return window.mx.meta.getEntity(t.$objectType).isA("System.Image")}).map(function(t){return c(t,!0)}),s.next=13,regeneratorRuntime.awrap(Promise.all(i.concat(o)));case 13:return s.abrupt("return",{});case 14:case"end":return s.stop()}},null,this)}},{key:"getExternalGuid",value:function(t){return this._internalToExternal[t]||t}},{key:"getInternalGuid",value:function(t){for(var e in this._internalToExternal)if(this._internalToExternal[e]===t)return e;return t}},{key:"makeObjectExternal",value:function(t){return N(t,this.getExternalGuid.bind(this))}},{key:"makeObjectInternal",value:function(t){return N(t,this.getInternalGuid.bind(this))}},{key:"_mapInternalGuid",value:function(t,e){this._internalToExternal[e]=t}}]),t}();function N(t,e){if(null===t)return null;var n=window.mx.meta.getEntity(t.$objectType);return R.a.mapObject(t,function(t,r){return("guid"===r||!s(r)&&n.isReference(r))&&null!=t?e(t):t})}function F(t,e,n){var i,u,o,a,c=n.createStoreFn,s=n.getStorageDirFn,l=n.downloadFileFn,f=n.getDocumentUrlFn;return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:return i=new r(window.mx.session.getConfig("sync_config.schema"),c),u=new e({downloadFileFn:l,getStorageDirFn:s}),o=new A(i,u,t),a=new w({getDocumentUrlFn:f},t,i,u,o),n.next=6,regeneratorRuntime.awrap(a.initialize());case 6:return n.abrupt("return",a);case 7:case"end":return n.stop()}},null,this)}n.d(e,"buildOfflineDataBackend",function(){return F})}}]);