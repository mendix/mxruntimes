import{Platform,Animated,Keyboard,TextInput,UIManager,Alert,SafeAreaView,View,NativeModules,YellowBox,NativeEventEmitter,unstable_batchedUpdates}from"react-native";import{r as reaction,a as action,c as configure}from"./ef69c932.js";import{Component,createElement,isValidElement}from"react";import{A as AssertionError}from"./53bf75a6.js";import{f as friendlyName,i as isJson,e as ensure,u as unique,c as concat,a as uniqueBy}from"./567083d6.js";import{w as withStore,a as withStableProp,S as StoreProvider}from"./96179378.js";import{i as isComputation,t as toEvaluation}from"./e3b801f3.js";import{B as Big$1}from"./2bc24ff8.js";export{B as Big}from"./2bc24ff8.js";import{p as pageScope,S as Store}from"./ceec5c0e.js";import{Navigation}from"react-native-navigation";import{w as wait,r as registerNanoflows,O as ObjectValidation,g as getNanoflowArguments,n as nanoflowEngine,a as never}from"./d354f192.js";import AsyncStorage from"@react-native-community/async-storage";import"./36940eec.js";import{t as translate,f as formatNumber,a as formatDate,p as parseNumber,b as parseDate,s as startupLocalization}from"./7ff5ebd0.js";import"react-native-vector-icons";import{p as preloadIcons}from"./f8be298b.js";import{n as newId}from"./fdd4c4ff.js";import{M as MxObject,c as clone$1,p as publish,a as curry,s as subscribe,u as unique$1,g as getSubscribedGuids,b as groupBy,d as arrayFromObject,e as getTags,f as curryN,o as objectFromArray,h as partition,m as mapObject,D as DescribedError,i as flatten}from"./84420dbd.js";import{V as ValidationError}from"./b92dd682.js";import{openDatabase}from"react-native-sqlite-storage";import"./573c00fc.js";import"./fa8bd0aa.js";import"./4cb96a65.js";import{p as post,U as UnauthorizedError,C as ConnectionError,r as registerMiddleware,g as get$1,o as objectToJson,a as getFsFileName,D as DOCUMENT_DIR,T as THUMBNAIL_DIR,j as jsonToObject,c as createUnsyncedGuid,b as DEFAULT_FILES_DIRECTORY,w as wasGuidSynced,i as isSpecialAttributeName,d as isReadonlyAttr,N as NativeFileBackend}from"./1b5b95a6.js";import"./5bff919c.js";import{D as DanglingError}from"./170cb5ff.js";var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function createCommonjsModule(fn,module){return fn(module={exports:{}},module.exports),module.exports}var set,get,has$1,key,O="object",check=function(it){return it&&it.Math==Math&&it},global_1=check(typeof globalThis==O&&globalThis)||check(typeof window==O&&window)||check(typeof self==O&&self)||check(typeof commonjsGlobal==O&&commonjsGlobal)||Function("return this")(),fails=function(exec){try{return!!exec()}catch(error){return!0}},descriptors=!fails(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}),nativePropertyIsEnumerable={}.propertyIsEnumerable,getOwnPropertyDescriptor=Object.getOwnPropertyDescriptor,objectPropertyIsEnumerable={f:getOwnPropertyDescriptor&&!nativePropertyIsEnumerable.call({1:2},1)?function(V){var descriptor=getOwnPropertyDescriptor(this,V);return!!descriptor&&descriptor.enumerable}:nativePropertyIsEnumerable},createPropertyDescriptor=function(bitmap,value){return{enumerable:!(1&bitmap),configurable:!(2&bitmap),writable:!(4&bitmap),value:value}},toString={}.toString,split="".split,indexedObject=fails(function(){return!Object("z").propertyIsEnumerable(0)})?function(it){return"String"==function(it){return toString.call(it).slice(8,-1)}(it)?split.call(it,""):Object(it)}:Object,requireObjectCoercible=function(it){if(null==it)throw TypeError("Can't call method on "+it);return it},toIndexedObject=function(it){return indexedObject(requireObjectCoercible(it))},isObject=function(it){return"object"==typeof it?null!==it:"function"==typeof it},toPrimitive=function(input,PREFERRED_STRING){if(!isObject(input))return input;var fn,val;if(PREFERRED_STRING&&"function"==typeof(fn=input.toString)&&!isObject(val=fn.call(input)))return val;if("function"==typeof(fn=input.valueOf)&&!isObject(val=fn.call(input)))return val;if(!PREFERRED_STRING&&"function"==typeof(fn=input.toString)&&!isObject(val=fn.call(input)))return val;throw TypeError("Can't convert object to primitive value")},hasOwnProperty={}.hasOwnProperty,has=function(it,key){return hasOwnProperty.call(it,key)},document=global_1.document,EXISTS=isObject(document)&&isObject(document.createElement),ie8DomDefine=!descriptors&&!fails(function(){return 7!=Object.defineProperty((it="div",EXISTS?document.createElement(it):{}),"a",{get:function(){return 7}}).a;var it}),nativeGetOwnPropertyDescriptor=Object.getOwnPropertyDescriptor,objectGetOwnPropertyDescriptor={f:descriptors?nativeGetOwnPropertyDescriptor:function(O,P){if(O=toIndexedObject(O),P=toPrimitive(P,!0),ie8DomDefine)try{return nativeGetOwnPropertyDescriptor(O,P)}catch(error){}if(has(O,P))return createPropertyDescriptor(!objectPropertyIsEnumerable.f.call(O,P),O[P])}},anObject=function(it){if(!isObject(it))throw TypeError(String(it)+" is not an object");return it},nativeDefineProperty=Object.defineProperty,objectDefineProperty={f:descriptors?nativeDefineProperty:function(O,P,Attributes){if(anObject(O),P=toPrimitive(P,!0),anObject(Attributes),ie8DomDefine)try{return nativeDefineProperty(O,P,Attributes)}catch(error){}if("get"in Attributes||"set"in Attributes)throw TypeError("Accessors not supported");return"value"in Attributes&&(O[P]=Attributes.value),O}},hide=descriptors?function(object,key,value){return objectDefineProperty.f(object,key,createPropertyDescriptor(1,value))}:function(object,key,value){return object[key]=value,object},setGlobal=function(key,value){try{hide(global_1,key,value)}catch(error){global_1[key]=value}return value},shared=createCommonjsModule(function(module){var store=global_1["__core-js_shared__"]||setGlobal("__core-js_shared__",{});(module.exports=function(key,value){return store[key]||(store[key]=void 0!==value?value:{})})("versions",[]).push({version:"3.1.3",mode:"global",copyright:"Â© 2019 Denis Pushkarev (zloirock.ru)"})}),functionToString=shared("native-function-to-string",Function.toString),WeakMap=global_1.WeakMap,nativeWeakMap="function"==typeof WeakMap&&/native code/.test(functionToString.call(WeakMap)),id=0,postfix=Math.random(),keys=shared("keys"),hiddenKeys={},WeakMap$1=global_1.WeakMap;if(nativeWeakMap){var store=new WeakMap$1,wmget=store.get,wmhas=store.has,wmset=store.set;set=function(it,metadata){return wmset.call(store,it,metadata),metadata},get=function(it){return wmget.call(store,it)||{}},has$1=function(it){return wmhas.call(store,it)}}else{var STATE=keys[key="state"]||(keys[key]=function(key){return"Symbol("+String(void 0===key?"":key)+")_"+(++id+postfix).toString(36)}(key));hiddenKeys[STATE]=!0,set=function(it,metadata){return hide(it,STATE,metadata),metadata},get=function(it){return has(it,STATE)?it[STATE]:{}},has$1=function(it){return has(it,STATE)}}var internalState={set:set,get:get,has:has$1,enforce:function(it){return has$1(it)?get(it):set(it,{})},getterFor:function(TYPE){return function(it){var state;if(!isObject(it)||(state=get(it)).type!==TYPE)throw TypeError("Incompatible receiver, "+TYPE+" required");return state}}},redefine=createCommonjsModule(function(module){var getInternalState=internalState.get,enforceInternalState=internalState.enforce,TEMPLATE=String(functionToString).split("toString");shared("inspectSource",function(it){return functionToString.call(it)}),(module.exports=function(O,key,value,options){var unsafe=!!options&&!!options.unsafe,simple=!!options&&!!options.enumerable,noTargetGet=!!options&&!!options.noTargetGet;"function"==typeof value&&("string"!=typeof key||has(value,"name")||hide(value,"name",key),enforceInternalState(value).source=TEMPLATE.join("string"==typeof key?key:"")),O!==global_1?(unsafe?!noTargetGet&&O[key]&&(simple=!0):delete O[key],simple?O[key]=value:hide(O,key,value)):simple?O[key]=value:setGlobal(key,value)})(Function.prototype,"toString",function(){return"function"==typeof this&&getInternalState(this).source||functionToString.call(this)})}),path=global_1,aFunction=function(variable){return"function"==typeof variable?variable:void 0},getBuiltIn=function(namespace,method){return arguments.length<2?aFunction(path[namespace])||aFunction(global_1[namespace]):path[namespace]&&path[namespace][method]||global_1[namespace]&&global_1[namespace][method]},ceil=Math.ceil,floor=Math.floor,toInteger=function(argument){return isNaN(argument=+argument)?0:(argument>0?floor:ceil)(argument)},min=Math.min,toLength=function(argument){return argument>0?min(toInteger(argument),9007199254740991):0},max=Math.max,min$1=Math.min,createMethod=function(IS_INCLUDES){return function($this,el,fromIndex){var value,O=toIndexedObject($this),length=toLength(O.length),index=function(index,length){var integer=toInteger(index);return integer<0?max(integer+length,0):min$1(integer,length)}(fromIndex,length);if(IS_INCLUDES&&el!=el){for(;length>index;)if((value=O[index++])!=value)return!0}else for(;length>index;index++)if((IS_INCLUDES||index in O)&&O[index]===el)return IS_INCLUDES||index||0;return!IS_INCLUDES&&-1}},indexOf={includes:createMethod(!0),indexOf:createMethod(!1)}.indexOf,hiddenKeys$1=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"].concat("length","prototype"),objectGetOwnPropertyNames={f:Object.getOwnPropertyNames||function(O){return function(object,names){var key,O=toIndexedObject(object),i=0,result=[];for(key in O)!has(hiddenKeys,key)&&has(O,key)&&result.push(key);for(;names.length>i;)has(O,key=names[i++])&&(~indexOf(result,key)||result.push(key));return result}(O,hiddenKeys$1)}},objectGetOwnPropertySymbols={f:Object.getOwnPropertySymbols},ownKeys=getBuiltIn("Reflect","ownKeys")||function(it){var keys=objectGetOwnPropertyNames.f(anObject(it)),getOwnPropertySymbols=objectGetOwnPropertySymbols.f;return getOwnPropertySymbols?keys.concat(getOwnPropertySymbols(it)):keys},copyConstructorProperties=function(target,source){for(var keys=ownKeys(source),defineProperty=objectDefineProperty.f,getOwnPropertyDescriptor=objectGetOwnPropertyDescriptor.f,i=0;i<keys.length;i++){var key=keys[i];has(target,key)||defineProperty(target,key,getOwnPropertyDescriptor(source,key))}},replacement=/#|\.prototype\./,isForced=function(feature,detection){var value=data[normalize(feature)];return value==POLYFILL||value!=NATIVE&&("function"==typeof detection?fails(detection):!!detection)},normalize=isForced.normalize=function(string){return String(string).replace(replacement,".").toLowerCase()},data=isForced.data={},NATIVE=isForced.NATIVE="N",POLYFILL=isForced.POLYFILL="P",isForced_1=isForced,getOwnPropertyDescriptor$1=objectGetOwnPropertyDescriptor.f,_export=function(options,source){var target,key,targetProperty,sourceProperty,descriptor,TARGET=options.target,GLOBAL=options.global,STATIC=options.stat;if(target=GLOBAL?global_1:STATIC?global_1[TARGET]||setGlobal(TARGET,{}):(global_1[TARGET]||{}).prototype)for(key in source){if(sourceProperty=source[key],targetProperty=options.noTargetGet?(descriptor=getOwnPropertyDescriptor$1(target,key))&&descriptor.value:target[key],!isForced_1(GLOBAL?key:TARGET+(STATIC?".":"#")+key,options.forced)&&void 0!==targetProperty){if(typeof sourceProperty==typeof targetProperty)continue;copyConstructorProperties(sourceProperty,targetProperty)}(options.sham||targetProperty&&targetProperty.sham)&&hide(sourceProperty,"sham",!0),redefine(target,key,sourceProperty,options)}};_export({target:"Object",stat:!0},{setPrototypeOf:Object.setPrototypeOf||("__proto__"in{}?function(){var setter,CORRECT_SETTER=!1,test={};try{(setter=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set).call(test,[]),CORRECT_SETTER=test instanceof Array}catch(error){}return function(O,proto){return anObject(O),function(it){if(!isObject(it)&&null!==it)throw TypeError("Can't set "+String(it)+" as a prototype")}(proto),CORRECT_SETTER?setter.call(O,proto):O.__proto__=proto,O}}():void 0)});path.Object.setPrototypeOf;var stringRepeat="".repeat||function(count){var str=String(requireObjectCoercible(this)),result="",n=toInteger(count);if(n<0||n==1/0)throw RangeError("Wrong number of repetitions");for(;n>0;(n>>>=1)&&(str+=str))1&n&&(result+=str);return result},ceil$1=Math.ceil,createMethod$1=function(IS_END){return function($this,maxLength,fillString){var fillLen,stringFiller,S=String(requireObjectCoercible($this)),stringLength=S.length,fillStr=void 0===fillString?" ":String(fillString),intMaxLength=toLength(maxLength);return intMaxLength<=stringLength||""==fillStr?S:(fillLen=intMaxLength-stringLength,(stringFiller=stringRepeat.call(fillStr,ceil$1(fillLen/fillStr.length))).length>fillLen&&(stringFiller=stringFiller.slice(0,fillLen)),IS_END?S+stringFiller:stringFiller+S)}},stringPad={start:createMethod$1(!1),end:createMethod$1(!0)},userAgent=getBuiltIn("navigator","userAgent")||"",webkitStringPadBug=/Version\/10\.\d+(\.\d+)?( Mobile\/\w+)? Safari\//.test(userAgent),$padEnd=stringPad.end;_export({target:"String",proto:!0,forced:webkitStringPadBug},{padEnd:function(maxLength){return $padEnd(this,maxLength,arguments.length>1?arguments[1]:void 0)}});var METHOD,length,bindContext=function(fn,that,length){if(function(it){if("function"!=typeof it)throw TypeError(String(it)+" is not a function")}(fn),void 0===that)return fn;switch(length){case 0:return function(){return fn.call(that)};case 1:return function(a){return fn.call(that,a)};case 2:return function(a,b){return fn.call(that,a,b)};case 3:return function(a,b,c){return fn.call(that,a,b,c)}}return function(){return fn.apply(that,arguments)}},call=Function.call;METHOD="padEnd",bindContext(call,global_1["String"].prototype[METHOD],length);const typeCache=new Map;function asPluginWidget(WrappedComponent){const cachedResult=typeCache.get(WrappedComponent);if(void 0!==cachedResult)return cachedResult;const componentName=friendlyName(WrappedComponent),result=withStore(withStableProp("$widgetId",class extends Component{constructor(props){super(props),this.reactionDisposers=[],this.childProps={},this.resumeSub=void 0;const handleComputations=(parent,key)=>{const value=parent[key];if(isComputation(value)){let firstFire=!0;this.reactionDisposers.push(reaction(toEvaluation(value,props.$store,props.$widgetId),value=>{parent[key]=value;const form=props.$store.get$(pageScope,"form")[0];form.isSuspended()?void 0===this.resumeSub&&(this.resumeSub=form.listen("resume",callback=>{void 0!==this.resumeSub?(this.resumeSub(),this.resumeSub=void 0,this.forceUpdate(),callback()):callback()})):firstFire?firstFire=!1:this.forceUpdate()},{fireImmediately:!0})),firstFire=!1}else Array.isArray(value)?value.forEach((_,i)=>handleComputations(value,i)):!isValidElement(value)&&isJson(value)&&Object.keys(value).forEach(key=>handleComputations(value,key))};Object.keys(props).filter(name=>!name.startsWith("$")).forEach(name=>{this.childProps[name]=props[name],handleComputations(this.childProps,name)})}shouldComponentUpdate(nextProps){if(nextProps.$widgetId!==this.props.$widgetId)throw new AssertionError(`Parent of widget '${this.props.$widgetId}' (${componentName}) did not correctly assign keys.`);return!1}componentWillUnmount(){this.reactionDisposers.forEach(d=>d()),void 0!==this.resumeSub&&(this.resumeSub(),this.resumeSub=void 0)}render(){return createElement(WrappedComponent,this.childProps,this.childProps.children)}}));return result.displayName=`pluginWidget(${componentName})`,typeCache.set(WrappedComponent,result),result}function asPluginWidgets(componentMap){const result={};return Object.keys(componentMap).forEach(key=>{result["$"+key]=asPluginWidget(componentMap[key])}),result}const DEFAULT_ANIMATION_DURATION_IN_MS=100,KeyboardAvoidingView=props=>"ios"===Platform.OS?createElement(KeyboardAvoidingViewIOS,Object.assign({},props)):props.children;class KeyboardAvoidingViewIOS extends Component{constructor(props){super(props),this.frame={x:0,y:0,width:0,height:0},this.onKeyboardWillShowHandler=this.onKeyboardWillShow.bind(this),this.onKeyboardWillHideHandler=this.onKeyboardWillHide.bind(this),this.onLayoutHandler=this.onLayout.bind(this),this.state={y:new Animated.Value(0)},Keyboard.addListener("keyboardWillShow",this.onKeyboardWillShowHandler),Keyboard.addListener("keyboardWillHide",this.onKeyboardWillHideHandler)}onLayout(event){this.frame=event.nativeEvent.layout}componentWillUnmount(){Keyboard.removeListener("keyboardWillShow",this.onKeyboardWillShowHandler),Keyboard.removeListener("keyboardWillHide",this.onKeyboardWillHideHandler)}render(){return createElement(Animated.View,{onLayout:this.onLayoutHandler,style:{flex:1,bottom:this.state.y}},this.props.children)}async onKeyboardWillShow(event){const currentFocusedTarget=TextInput.State.currentlyFocusedField();if(!currentFocusedTarget)return;const keyboardCoordinates=event.endCoordinates,currentFieldBoundingBox=await this.measureTarget(currentFocusedTarget),fieldHeight=currentFieldBoundingBox.visible?currentFieldBoundingBox.height:currentFieldBoundingBox.height-(currentFieldBoundingBox.pageY+currentFieldBoundingBox.height-(this.frame.y+this.frame.height));keyboardCoordinates.screenY<=currentFieldBoundingBox.y+currentFieldBoundingBox.height&&Animated.timing(this.state.y,{toValue:currentFieldBoundingBox.y+fieldHeight-keyboardCoordinates.screenY,duration:event.duration||DEFAULT_ANIMATION_DURATION_IN_MS}).start()}onKeyboardWillHide(event){Animated.timing(this.state.y,{toValue:0,duration:event&&event.duration||DEFAULT_ANIMATION_DURATION_IN_MS}).start()}async measureTarget(field){return new Promise(resolve=>{UIManager.measure(field,(_x,_y,_width,_height,pageX,pageY)=>UIManager.measureInWindow(field,(x,y,width,height)=>resolve({x:x,y:y,pageX:pageX,pageY:pageY,width:width,height:height,visible:this.frame.y+this.frame.height>=pageY+height})))})}}class AsyncStore{constructor(key){this.key=key}async get(){const result=await AsyncStorage.getItem(this.key);return null!==result?result:void 0}async set(value){await AsyncStorage.setItem(this.key,value)}async remove(){await AsyncStorage.removeItem(this.key)}}class NotImplementedError extends Error{constructor(what=""){super("Not implemented"+(""!==what?": "+what:"")),Object.setPrototypeOf(this,NotImplementedError.prototype)}}class FormBase{constructor(place){this.place=place,this.listeners={},this.suspended=!1,this.title=""}getTitle(){return this.title}setSuspend(suspend){this.suspended!==suspend&&(this.suspended=suspend,this.suspended||this.publish("resume"))}isSuspended(){return this.suspended}publish(event,callback,error){const list=(this.listeners[event]||[]).slice();!function next(){list.length?list.pop()(next,error):void 0!==callback&&callback()}()}listen(event,handler){const list=this.listeners[event]||[];return this.listeners[event]=list,list.push(handler),()=>list.splice(list.indexOf(handler),1)}unlisten(handler){handler()}}class NativeForm extends FormBase{constructor(name,title,formParameterGuid){super("content"),this.name=name,this.formParameterGuid=formParameterGuid,this.store=new Store,this.title=title,this.store.set(pageScope,"form",[this,""]),this.store.set(pageScope,"applyContextCount",0),formParameterGuid&&mx.data.get({guid:formParameterGuid,callback:this.setFormParameter.bind(this),error:mx.onError})}setComponentId(componentId){this.componentId=componentId}setFormParameter(mxobj){this.store.set(pageScope,"object",mxobj)}getComponentId(){return ensure(this.componentId)}getName(){return this.name}getGuid(){return this.formParameterGuid}getSubmitObjects(){const objects=this.store.getAll$("object").filter(s=>s instanceof MxObject);return unique(objects)}close(callback){Navigation.pop(this.getComponentId(),{}).then(callback,mx.onError)}async triggerValidation(){if(this.store.set(pageScope,"validationRequest",newId("validation_request")),await wait(0),this.store.getAll$("isInvalid").some(isInvalid=>isInvalid))throw new ValidationError}}const pageStateStore=new AsyncStore("pageState"),homePages=[],pageMetadata={},javascriptActions={},defaultLayoutAnimationOptions={push:{waitForRender:!0}};let lastOpenedForm,selectedTabIndex,defaultNavigationOptions={};const formCache={};class NativeUI{async openForm2(pageName,formParameterGuid,customTitle,currentForm,_params){const layout=createNavigationLayout(pageName,customTitle,formParameterGuid);return await Navigation.push(currentForm.getComponentId(),layout),ensure(lastOpenedForm)}reload(){}confirmation(args){args.handler()}showLogin(){throw new NotImplementedError("showLogin")}showProgress(){return 0}hideProgress(){}downloadFile(){}showMessage(type,message,_isModal){const title=translate("mxui.widget.DialogMessage",type),buttonText=translate("mxui.widget.DialogMessage","ok");Alert.alert(title,message,[{text:buttonText}])}async getJavaScriptAction(actionName){return javascriptActions[actionName]()}static registerJavaScriptAction(actionName,action){javascriptActions[actionName]=action}static async savePageState(){if(!lastOpenedForm)return;const pageState={name:lastOpenedForm.getName(),title:lastOpenedForm.getTitle(),formParameterGuid:lastOpenedForm.getGuid(),cache:mx.data.dehydrateCache(),selectedTabIndex:selectedTabIndex};await pageStateStore.set(JSON.stringify(pageState))}static async loadPageState(){const state=await pageStateStore.get();let res=null;try{res=JSON.parse(state)}catch(e){}return res}static registerPage(pageName,page,navigation){pageMetadata[pageName]={title:page.$$title,navigation:navigation},navigation&&Navigation.registerComponent(`${pageName}:header`,()=>(function(renderBody){return class extends Component{render(){return createElement(StoreProvider,{store:formCache[this.props.pageUuid].store},renderBody())}}})(page[navigation.header]));const combinedStyle=page.$$style.reduce((old,current)=>Object.assign({},old,current),{});Navigation.registerComponent(pageName,()=>(function(renderBody,style){return class extends Component{constructor(props){super(props),Navigation.events().bindComponent(this),formCache[this.props.pageUuid].setComponentId(this.props.componentId)}componentWillUnmount(){delete formCache[this.props.pageUuid]}componentDidAppear(){lastOpenedForm=formCache[this.props.pageUuid]}render(){return createElement(SafeAreaView,{style:{flex:1,backgroundColor:"white"}},createElement(KeyboardAvoidingView,{},createElement(StoreProvider,{store:formCache[this.props.pageUuid].store},createElement(View,{onStartShouldSetResponderCapture:evt=>{const selectedTextInput=TextInput.State.currentlyFocusedField();return selectedTextInput!==evt.target&&Keyboard.dismiss(),!1},style:Object.assign({},style,{flex:1})},renderBody()))))}}})(page.$$page,combinedStyle))}static registerNanoflows(nanoflows){registerNanoflows(nanoflows)}static setDefaultStyling(navigationStyle={}){const topBar=navigationStyle.topBar?navigationStyle.topBar:{},bottomBar=navigationStyle.bottomBar?navigationStyle.bottomBar:{};defaultNavigationOptions=Object.assign({},defaultNavigationOptions,{bottomTab:{fontFamily:bottomBar.fontFamily,fontSize:bottomBar.fontSize,iconColor:bottomBar.iconColor,selectedIconColor:bottomBar.selectedIconColor,selectedTextColor:bottomBar.selectedTextColor,textColor:bottomBar.textColor},bottomTabs:{backgroundColor:bottomBar.backgroundColor},layout:{orientation:"portrait"},topBar:{backButton:{color:topBar.backButtonColor},background:{color:topBar.backgroundColor},title:{color:topBar.titleColor,fontFamily:topBar.titleFontFamily,fontSize:topBar.titleFontSize,component:{alignment:topBar.titleAlignment}}}})}static async startApp(tabs=[]){NativeUI.configureYellowBox(),Navigation.setDefaultOptions(defaultNavigationOptions),Navigation.events().registerBottomTabSelectedListener(event=>selectedTabIndex=event.selectedTabIndex);const openFormInstruction=mx.session.getConfig("instructions")[0];if("open_form"!==openFormInstruction.type)throw new AssertionError;let rootTemplate;const visibleTabs=tabs.filter(tab=>void 0===tab.visibleForRoles||mx.session.hasSomeRole(tab.visibleForRoles)).slice(0,5);if(visibleTabs.length>0){NativeUI.registerPage("Blank",{$$title:"",$$page:()=>()=>null,$$style:[]});const icons=await preloadIcons(visibleTabs.filter(tab=>tab.icon).map(tab=>tab.icon));rootTemplate={bottomTabs:{children:visibleTabs.map((tab,index)=>{return homePages.push(tab.pageName),{stack:{children:[createNavigationLayout(tab.pageName,tab.title)],options:{bottomTab:{text:tab.caption,icon:tab.icon?icons[tab.icon]:void 0,testID:`bottomTab$item${index}`}}}}})}}}else{const pageName=openFormInstruction.args.FormPath.replace("/",".").replace(".page.xml","");homePages.push(pageName),rootTemplate={stack:{children:[createNavigationLayout(pageName,openFormInstruction.args.FormTitle)]}}}const root=await NativeUI.restorePreviousPageState(rootTemplate);return Navigation.setRoot({root:root})}static configureYellowBox(){const filterLevel=NativeModules.MxConfiguration.WARNINGS_FILTER_LEVEL;console.disableYellowBox=filterLevel===WarningsFilter.none,filterLevel===WarningsFilter.partial&&YellowBox.ignoreWarnings(["RCTBridge","Attempted to invoke"])}static async restorePreviousPageState(root){const pageState=await this.loadPageState();if(pageState&&pageState.name){if(void 0!==pageMetadata[pageState.name]){mx.data.hydrateCache(pageState.cache);const layout=createNavigationLayout(pageState.name,pageState.title,pageState.formParameterGuid);if(root.bottomTabs){const tabIndex=pageState.selectedTabIndex<root.bottomTabs.children.length?pageState.selectedTabIndex:0;homePages[tabIndex]!==pageState.name&&root.bottomTabs.children[tabIndex].stack.children.push(layout),root.bottomTabs.currentTabIndex=tabIndex}else root.stack&&homePages[0]!==pageState.name&&root.stack.children.push(layout)}await pageStateStore.remove()}return root}}function createNavigationLayout(pageName,customTitle,formParameterGuid){const pageUuid=newId("page"),metadata=pageMetadata[pageName];formCache[pageUuid]=new NativeForm(pageName,customTitle||metadata.title,formParameterGuid);const options=function(pageName,pageMetadata,pageUuid,customTitle){if(pageMetadata.navigation&&pageMetadata.navigation.header){const componentName=`${pageName}:header`;return{topBar:{visible:!0,title:{text:customTitle||pageMetadata.title},rightButtons:[{id:componentName,component:{name:componentName,passProps:{pageUuid:pageUuid}}}]}}}return{topBar:{height:0,visible:!1}}}(pageName,metadata,pageUuid,customTitle);return{component:{name:pageName,passProps:{pageName:pageName,title:customTitle||metadata.title,formParameterGuid:formParameterGuid,pageUuid:pageUuid},options:Object.assign({},options,{animations:defaultLayoutAnimationOptions})}}}var WarningsFilter;!function(WarningsFilter){WarningsFilter[WarningsFilter.all=0]="all",WarningsFilter[WarningsFilter.partial=1]="partial",WarningsFilter[WarningsFilter.none=2]="none"}(WarningsFilter||(WarningsFilter={}));class LabeledGraph{constructor(){this.__labels=[],this.__labelMap={},this.__graph=[]}addEdge(fromLabel,toLabel){const fromIdx=this._getOrCreateLabelIndex(fromLabel),toIdx=this._getOrCreateLabelIndex(toLabel),destinationIndices=this.__graph[fromIdx];destinationIndices.includes(toIdx)||destinationIndices.push(toIdx)}neighborsOf(label){const idx=this._getOrCreateLabelIndex(label);return this.__graph[idx].map(this._indexToLabel,this)}reachableLabels(sourceLabels){const sourceIndices=sourceLabels.map(this._getOrCreateLabelIndex,this);var graph,start,visited;return(graph=this.__graph,start=sourceIndices,visited=new Array(graph.length),function visitEdges(edges){for(var i=0;i<edges.length;++i){var idx=edges[i];if(idx<0||idx>=visited.length)throw new Error("graph: index "+idx+" out of bounds in graph of size "+graph.length);visited[idx]||(visited[idx]=!0,visitEdges(graph[idx]))}}(start),function(){for(var result=[],i=0;i<visited.length;++i)visited[i]&&result.push(i);return result}()).map(this._indexToLabel,this)}_indexToLabel(idx){return this.__labels[idx]}_getOrCreateLabelIndex(label){let idx=label in this.__labelMap?this.__labelMap[label]:-1;return-1===idx&&(this.__labels.push(label),this.__graph.push([]),idx=this.__labels.length-1,this.__labelMap[label]=idx),idx}}function findReachableGuidsToRetain(mxobjs,rootGuids){return function(mxobjs,rootGuids){const objectMap=function(mxobjs){const objectMap={};return mxobjs.forEach(mxobj=>{objectMap[mxobj.getGuid()]=mxobj}),objectMap}(mxobjs=mxobjs.filter(mxobj=>!mxobj.isPersistable()||mxobj.hasChanges()||mxobj.isNew()));return function(associations){const labeledGraph=new LabeledGraph;return associations.forEach(({from:from,to:to})=>labeledGraph.addEdge(from,to)),labeledGraph}(function(mxobjs){const associations=[];return mxobjs.forEach(mxobj=>{mxobj.getReferenceAttributes().filter(association=>!function(attr){return"System.owner"===attr||"System.changedBy"===attr}(association)).forEach(association=>{(function(mxobj,attr){return mxobj.getReferences(attr).concat(mxobj.getOriginalReferences(attr))})(mxobj,association).forEach(refGuid=>associations.push({from:refGuid,to:mxobj.getGuid()},{from:mxobj.getGuid(),to:refGuid}))})}),associations}(mxobjs).filter(({from:from,to:to})=>isRetained(from)&&isRetained(to)));function isRetained(guid){return rootGuids.includes(guid)||guid in objectMap}}(mxobjs,rootGuids).reachableLabels(rootGuids)}let idCounter=0;class MxContext{constructor(kwArgs){this.id=this.ident=++idCounter,this.trackId="",this.trackEntity="",this.trackObject=null,this.localParams={},this.constraintby=[],this._entityToGuid={},this._mxidToObject={},kwArgs&&(kwArgs.mxcontext&&this.dupFrom(kwArgs.mxcontext),kwArgs.classname&&kwArgs.mendixguid?this.setContext(kwArgs.classname,kwArgs.mendixguid):kwArgs.entity&&kwArgs.guid&&this.setContext(kwArgs.entity,kwArgs.guid))}hasTrackEntity(){return""!==this.trackEntity}hasTrackId(){return!!this.trackId}hasTrackObject(){return!!this.trackObject}getTrackEntity(){return this.trackEntity}getTrackId(){return this.trackId}getTrackObject(){return this.trackObject}setTrackObject(obj){obj&&this.setContext(obj.getEntity(),obj.getGuid()),this.trackObject=obj}getObject(){return this.trackObject}setConstraints(constraints){null!=constraints&&""!==constraints&&0!==constraints.length&&(this.constraintby="string"==typeof constraints?constraints.split(","):constraints)}getConstraints(){for(var t=[],i=0;i<this.constraintby.length;i++)t.push(this.constraintby[i]);return t}hasBacktrack(){return 0!==this.constraintby.length}getEntities(){return Object.keys(this._entityToGuid).filter(e=>void 0!==e&&""!==this._entityToGuid[e])}setContext(entity,guid){if(1===arguments.length&&arguments[0]instanceof MxObject){var mxobj=arguments[0];entity=mxobj.getEntity(),guid=mxobj.getGuid()}this.trackEntity=null==entity?"":entity,this.trackId=null==guid?"":guid,this.trackObject=null,this._entityToGuid[this.trackEntity]=this.trackId}unsetContext(entity){if("string"!=typeof entity)throw new Error("mendix/lib/MxContext.unsetContext: parameter entity is not of type String");delete this._entityToGuid[entity]}getContext(entity){if("string"!=typeof entity)throw new Error("mendix/lib/MxContext.getContext: parameter entity is not of type String");if(entity in this._entityToGuid)return this._entityToGuid[entity];var meta=window.mx.meta.getEntity(entity),result=null;return meta.getSubEntities().some(subEntity=>subEntity in this._entityToGuid&&(result=this._entityToGuid[subEntity],!0)),result}hasContext(entity){if("string"!=typeof entity)throw new Error("mendix/lib/MxContext.hasContext: parameter entity is not of type String");return null!=this.getContext(entity)}reset(){this._entityToGuid={},this._mxidToObject={},this.trackId=null,this.trackEntity="",this.trackObject=null}dupFrom(context){this.reset(),this.mixin(context)}mixin(context){if(context)context.getEntities().forEach(e=>this.setContext(e,context.getContext(e))),context.getWidgetIds().forEach(mxid=>this.setWidgetObject(mxid,context.getWidgetObject(mxid))),this.setParams(context.getParams()),this.setConstraints(context.getConstraints()),this.setContext(context.getTrackEntity(),context.getTrackId()),this.setTrackObject(context.getTrackObject());else{const entity=this.getTrackEntity();entity&&this.unsetContext(entity),this.setContext(null,null)}}hasParam(key){return key in this.localParams}getParam(key){return this.hasParam(key)?this.localParams[key]:null}getParams(){return this.localParams}setParam(key,value){if(null==key)throw new Error("mendix/lib/MxContext["+this.ident+"].setParam key is null");this.localParams[key]=value}setParams(obj){if("object"!=typeof obj)throw new Error("mendix/lib/MxContext["+this.ident+"].setParams requires an Object.");for(var i in obj)this.localParams[i]=obj[i]}unsetParam(key){delete this.localParams[key]}resetParams(){this.localParams={}}isEmpty(){for(var j in this._entityToGuid)return!0;return!1}getGuids(){for(var contexts=this.getEntities(),trackId=this.getTrackId(),contextIds=trackId?[trackId]:[],i=0,l=contexts.length;i<l;i++){var c=contexts[i];if("System.owner"!==c&&"System.changedBy"!==c){var guid=this.getContext(c);guid!==trackId&&contextIds.push(guid)}}return contextIds}getWidgetIds(){return Object.keys(this._mxidToObject)}getWidgetObject(widgetId){return this._mxidToObject[widgetId]}setWidgetObject(widgetId,object){this.setTrackObject(object),this._mxidToObject[widgetId]=object}getWidgetObjectMap(){return clone$1(this._mxidToObject)}freeze(){this.setTrackObject=this.setConstraints=this.setContext=this.unsetContext=this.reset=this.dupFrom=this.setParam=this.setParams=this.unsetParam=this.setWidgetObject=this.resetParams=function(){return window.mx.logger.error("mendix/lib/MxContext["+this.ident+"].freeze: context is readonly"),!1}}}function StringSet(values){for(var m in this.__values={},values)this.__values[m+""]=!0}function performFetch(objectCache,curObj,pathComponents,schemaComponents,attr,params,callback,error){var ref,type,child,refGuid;if(pathComponents.length+schemaComponents.length===0)callback(null==curObj?null:attr?getAttribute(curObj,attr):curObj);else if(0===pathComponents.length&&schemaComponents.length>0)ref=schemaComponents[0],type=schemaComponents[1],curObj.isObjectReferenceSet(ref)?fetchReferenceSet(curObj,ref,type,callback,error):fetchReference(objectCache,curObj,pathComponents,schemaComponents.slice(2),attr,params,ref,type,params.schema,callback,error);else if(ref=pathComponents[0],type=pathComponents[1],curObj.isObjectReferenceSet(ref))pathComponents.length>2||schemaComponents.length>2?error&&error(new Error("reference set should be at end of path")):fetchReferenceSet(curObj,ref,type,callback,error);else if(curObj.isObjectReference(ref))if(child=curObj.getChild(ref))child.isA(type)?performFetch(objectCache,child,pathComponents.slice(2),schemaComponents,attr,params,callback,error):callback&&callback(null);else if(refGuid=curObj.getReference(ref))if(objectCache.has(refGuid)){var nextObj=objectCache.getObject(refGuid);nextObj.isA(type)?performFetch(objectCache,nextObj,pathComponents.slice(2),schemaComponents,attr,params,callback,error):callback&&callback(null)}else params.usexpath&&pathComponents.length>2?function(objectCache,curObj,pathComponents,schemaComponents,attr,params,refGuid,type,callback,error){var xpath=[`//${type}[id=${refGuid}]`].concat(pathComponents).join("/");new Promise((resolve,reject)=>{window.mx.data.get({xpath:xpath,callback:resolve,error:reject})}).then(mxobjs=>{0===mxobjs.length?callback(null):attr&&1===mxobjs.length?callback(getAttribute(mxobjs[0],attr)):attr?error&&error(new Error(attr+" is not a reference type")):!function(type,pathComponents){const path=[type].concat(pathComponents);if(pathComponents.length<2)return!1;const refMeta=window.mx.meta.getEntity(path.slice(-3)[0]),refAttr=pathComponents.slice(-2)[0];return refMeta.isObjectReferenceSet(refAttr)}(type,pathComponents)?performFetch(objectCache,mxobjs[0],[],schemaComponents,attr,params,callback,error):callback(mxobjs)},error)}(objectCache,0,pathComponents.slice(2),schemaComponents,attr,params,refGuid,type,callback,error):fetchReference(objectCache,curObj,pathComponents.slice(2),schemaComponents,attr,params,ref,type,null,callback,error);else callback(null);else error&&error(new Error("attribute "+ref+" is not a reference type"))}function fetchReference(objectCache,curObj,pathComponents,schemaComponents,attr,params,ref,type,schema,callback,error){const guid=curObj.getReference(ref);guid?new Promise((resolve,reject)=>{window.mx.data.get({guid:guid,filter:{id:schema},callback:resolve,error:reject})}).then(mxobj=>{mxobj&&mxobj.isA(type)?performFetch(objectCache,mxobj,pathComponents,schemaComponents,attr,params,callback,error):callback(null)},error):callback(null)}function fetchReferenceSet(curObj,ref,type,callback,error){0===curObj.getReferences(ref).length?callback([]):curObj.hasChildren(ref)?callback(curObj.getChildren(ref).filter(mxobj=>mxobj.isA(type))):new Promise((resolve,reject)=>{window.mx.data.get({guids:curObj.getReferences(ref),callback:resolve,error:reject})}).then(mxobjs=>{const res=mxobjs.reduce((acc,obj)=>(obj.isA(type)?acc.matching.push(obj):acc.releasing.push(obj),acc),{matching:[],releasing:[]});callback(res.matching)},error)}function getAttribute(curObj,attr){return curObj.isObjectReference(attr)?curObj.getReference(attr):curObj.isObjectReferenceSet(attr)?curObj.getReferences(attr):curObj.get(attr)}async function getByGuid(guid){return new Promise((resolve,reject)=>mx.data.get({guid:guid,callback:resolve,error:reject}))}function gatherUpdates(objectCache,json){const changedAttrs=Object.entries(json.changes||{}).map(([guid,objChanges])=>Object.keys(objChanges).map(attr=>({guid:guid,attr:attr}))),resetAttrs=Object.entries(json.resets||{}).map(([guid,attributes])=>attributes.map(attr=>({guid:guid,attr:attr}))),attrsChangedByObjects=(json.objects||[]).map(json=>{const obj=objectCache.getObject(json.guid);return null!==obj?function(cachedObj,incomingJson){const meta=mx.meta.getEntity(incomingJson.objectType),incomingObj=MxObject.fromJson(incomingJson);return meta.getAttributes().filter(attr=>!function(lhsObj,rhsObj,attr){if(lhsObj.isReadonlyAttr(attr)!==rhsObj.isReadonlyAttr(attr))return!1;if(lhsObj.isReference(attr)){if("System.changedBy"===attr||"System.owner"===attr)return!0;const lhsRefStr=lhsObj.getOriginalReferences(attr).sort((a,b)=>a.localeCompare(b)).join(","),rhsRefStr=rhsObj.getOriginalReferences(attr).sort((a,b)=>a.localeCompare(b)).join(",");return lhsRefStr===rhsRefStr}const lhsValue=lhsObj.getOriginalValue(attr),rhsValue=rhsObj.getOriginalValue(attr);return lhsValue===rhsValue||null!==lhsValue&&null!==rhsValue&&lhsValue.valueOf&&rhsValue.valueOf&&lhsValue.valueOf()===rhsValue.valueOf()}(cachedObj,incomingObj,attr))}(obj,json).map(attr=>({guid:json.guid,attr:attr})):[]}),refreshedGuids=unique(concat((json.instructions||[]).map(getRefreshGuids)).concat(json.deletes||[]));return[...uniqueBy(concat([...changedAttrs,...resetAttrs,...attrsChangedByObjects]),x=>`${x.guid}:${x.attr}`).map(({guid:guid,attr:attr})=>({guid:guid,attr:attr})).filter(({guid:guid})=>!refreshedGuids.includes(guid)&&objectCache.has(guid)),...refreshedGuids.filter(guid=>objectCache.has(guid)).map(guid=>({guid:guid})),...unique(concat((json.instructions||[]).map(i=>"refresh_class"===i.type?i.args.classnames:[]))).map(entity=>({entity:entity}))]}function getRefreshGuids(i){return"refresh_object_list"===i.type?i.args.ObjectIds:[]}async function handleRuntimeError(objectCache,e,onValidation){if(e instanceof ValidationError){const json=e.original,updates=gatherUpdates(objectCache,json).filter(u=>!("attr"in u));await publish(...updates),await async function(json){for(const instruction of json.instructions||[])switch(instruction.type){case"logout":mx.logout();break;case"show_login":mx.ui.showLogin();break;case"download_file":const obj=await getByGuid(instruction.args.FileDocumentGuid);mx.ui.downloadFile({mxobject:ensure(obj),target:instruction.args.Target});break;case"text_message":mx.ui.showMessage(instruction.args.MessageType,instruction.args.MessageContent,instruction.args.MessageBlock)}}(json),function(json,onValidation){const validations=ObjectValidation.fromResponse(json.datavalidation||[]);mx.data.sendValidationUpdates(validations),validations.length>0&&onValidation&&onValidation(validations)}(json,onValidation)}}StringSet.of=StringSet.prototype.of=function(x){return StringSet.fromArray([x])},StringSet.fromArray=function(values){for(var result={},i=0;i<values.length;++i)result[values[i]]=!0;return new StringSet(result)},StringSet.empty=StringSet.prototype.empty=function(){return StringSet.fromArray([])},StringSet.prototype.contains=function(test){return this.__values[test]||!1},StringSet.prototype.union=StringSet.prototype.concat=function(other){var result={};for(var m in this.__values)result[m]=!0;for(var n in other.__values)result[n]=!0;return new StringSet(result)},StringSet.prototype.intersection=function(other){var result={};for(var m in this.__values)other.contains(m)&&(result[m]=!0);return new StringSet(result)},StringSet.prototype.difference=function(other){var result={};for(var m in this.__values)other.contains(m)||(result[m]=!0);return new StringSet(result)},StringSet.prototype.length=function(){return this.values().length},StringSet.prototype.reduce=function(fn,acc){return this.values().reduce(fn,acc)},StringSet.prototype.chain=function(fn){return this.reduce(function(acc,x){return acc.concat(fn(x))},this.empty())},StringSet.prototype.map=function(fn){return this.chain(function(x){return this.of(fn(x))}.bind(this))},StringSet.prototype.values=function(){return Object.keys(this.__values)},StringSet.prototype.toString=function(){return"StringSet("+this.values()+")"};var strictUriEncode=function(str){return encodeURIComponent(str).replace(/[!'()*]/g,function(c){return"%"+c.charCodeAt(0).toString(16).toUpperCase()})},getOwnPropertySymbols=Object.getOwnPropertySymbols,hasOwnProperty$1=Object.prototype.hasOwnProperty,propIsEnumerable=Object.prototype.propertyIsEnumerable;function toObject(val){if(null==val)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(val)}var objectAssign=function(){try{if(!Object.assign)return!1;var test1=new String("abc");if(test1[5]="de","5"===Object.getOwnPropertyNames(test1)[0])return!1;for(var test2={},i=0;i<10;i++)test2["_"+String.fromCharCode(i)]=i;if("0123456789"!==Object.getOwnPropertyNames(test2).map(function(n){return test2[n]}).join(""))return!1;var test3={};return"abcdefghijklmnopqrst".split("").forEach(function(letter){test3[letter]=letter}),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},test3)).join("")}catch(err){return!1}}()?Object.assign:function(target,source){for(var from,symbols,to=toObject(target),s=1;s<arguments.length;s++){for(var key in from=Object(arguments[s]))hasOwnProperty$1.call(from,key)&&(to[key]=from[key]);if(getOwnPropertySymbols){symbols=getOwnPropertySymbols(from);for(var i=0;i<symbols.length;i++)propIsEnumerable.call(from,symbols[i])&&(to[symbols[i]]=from[symbols[i]])}}return to};function encode(value,opts){return opts.encode?opts.strict?strictUriEncode(value):encodeURIComponent(value):value}var DayOfWeek,stringify=function(obj,opts){!1===(opts=objectAssign({encode:!0,strict:!0,arrayFormat:"none"},opts)).sort&&(opts.sort=function(){});var formatter=function(opts){switch(opts.arrayFormat){case"index":return function(key,value,index){return null===value?[encode(key,opts),"[",index,"]"].join(""):[encode(key,opts),"[",encode(index,opts),"]=",encode(value,opts)].join("")};case"bracket":return function(key,value){return null===value?encode(key,opts):[encode(key,opts),"[]=",encode(value,opts)].join("")};default:return function(key,value){return null===value?encode(key,opts):[encode(key,opts),"=",encode(value,opts)].join("")}}}(opts);return obj?Object.keys(obj).sort(opts.sort).map(function(key){var val=obj[key];if(void 0===val)return"";if(null===val)return encode(key,opts);if(Array.isArray(val)){var result=[];return val.slice().forEach(function(val2){void 0!==val2&&result.push(formatter(key,val2,result.length))}),result.join("&")}return encode(key,opts)+"="+encode(val,opts)}).filter(function(x){return x.length>0}).join("&"):""};async function getSessionData(params){return post(xasUrl(),{action:"get_session_data",params:params})}async function keepalive(){return post(xasUrl(),{action:"keepalive",params:{}})}async function upload(guid,name,params,blob,changes,objects){const url=mx.remoteUrl+"file?"+stringify(Object.assign({},params,{guid:guid})),formData=new FormData;return formData.append("data",JSON.stringify({changes:changes,objects:objects})),name?formData.append("blob",blob,name):formData.append("blob",blob),post(url,formData)}function xasUrl(){return mx.remoteUrl+"xas/"}function handleUncachedObjects(objectCache,mxObjs,json){const{commits:commits=[],rollbacks:rollbacks=[],deletes:deletes=[]}=json;mxObjs.forEach(mxObj=>{const guid=mxObj.getGuid();if(commits.includes(guid)||rollbacks.indexOf(guid)>=0){const cachedMxObj=objectCache.getObject(guid);if(!cachedMxObj)throw new Error("inconsistent response: committed or rolled back object is missing from response and cache");mxObj.resetFromJSON(cachedMxObj.jsonData)}else deletes.includes(guid)&&mxObj.markAsUnavailable()})}!function(DayOfWeek){DayOfWeek[DayOfWeek.Sunday=0]="Sunday",DayOfWeek[DayOfWeek.Monday=1]="Monday",DayOfWeek[DayOfWeek.Tuesday=2]="Tuesday",DayOfWeek[DayOfWeek.Wednesday=3]="Wednesday",DayOfWeek[DayOfWeek.Thursday=4]="Thursday",DayOfWeek[DayOfWeek.Friday=5]="Friday",DayOfWeek[DayOfWeek.Saturday=6]="Saturday"}(DayOfWeek||(DayOfWeek={}));(new Date).getTime();function Data(config,objectCache){config=config||{};var self=this;const valSubscriptions=[];let currentBackend,gcInterval;const runCallback1=curryN(3,runCallback),createErrorHandler=curry(runErrorHandler);function normalizeArguments(args){if("object"!=typeof args)throw new AssertionError("args is not an object");if("function"!=typeof args.callback)throw new AssertionError("callback is not a function");if(args.mxobj&&!(args.mxobj instanceof MxObject))throw new AssertionError("mxobj is not a MxObject");if(args.mxobjs&&!(args.mxobjs instanceof Array))throw new AssertionError("mxobjs is not an Array");if(!args.mxobj&&!args.mxobjs||args.mxobj&&args.mxobjs)throw new AssertionError("one of mxobj or mxobjs should be passed");return args.mxobj?[args.mxobj]:args.mxobjs}function collectGarbage(){const cachedObjects=objectCache.getAllObjects(),cachedGuidSet=StringSet.fromArray(cachedObjects.map(mxobj=>mxobj.getGuid())),collectableGuids=cachedGuidSet.difference(StringSet.fromArray(function(){const userId=window.mx.session.getUserId(),sessionId=window.mx.session.getSessionObjectId(),rootGuids=unique$1(getSubscribedGuids().concat(valSubscriptions.map(vs=>vs.guid)).concat([userId,sessionId]));return findReachableGuidsToRetain(cachedObjects,rootGuids)}())).values();config.logCleanupStatistics&&window.mx.logger.debug(function(){const entityToGuids=groupBy(collectableGuids,guid=>objectCache.getObject(guid).getEntity()),objectsStr=arrayFromObject(entityToGuids).map(([entity,guids])=>entity+": "+guids.join(", ")).join("\n");return`Garbage collecting ${collectableGuids.length} of ${cachedGuidSet.length()}\n${objectsStr}`}()),objectCache.removeObjects(collectableGuids)}function runCallback0(callback,scope){return function(){runCallback(callback,scope)}}function runCallback(callback,scope,...args){try{callback&&callback.apply(scope,args)}catch(e){window.mx.onError(e)}}function runErrorHandler(error,scope,e){error?error.call(scope,e):window.mx.onError(e)}function isCached(mxobj){return objectCache.has(mxobj.getGuid())}function getGuid(mxobj){return mxobj.getGuid()}function getEntity(mxobj){return mxobj.getEntity()}this.getBacktrack=function(guid,paths,callback,error,scope){if("function"!=typeof error&&(scope=error,error=null),paths&&0!==paths.length){var mxobj=null,constraints=[],pathIndex=0,allMatched=!0,fetchConstraints=function(){var path=paths[pathIndex++];path?function(mxobj,path,callback,error){var split=path.split("/"),fetchDeepRefs=function(objs){var constraints,entity=split.shift(),ref=split.shift();if(null!=objs&&null!=objs.length&&0!==objs.length){for(var carr=[],i=0;i<objs.length;i++)null!=objs[i]&&carr.push("id='"+objs[i].getGuid()+"'");carr.length?(constraints="["+ref+"/"+entity+"["+carr.join(" or ")+"]]",1===split.length?callback(constraints):(entity=split.shift(),ref=split.shift(),callback("["+ref+"/"+entity+constraints+"]"))):callback(null)}else callback(null)};!function(){var entity=split.shift(),ref=split.shift();if(1===split.length){var constraint="["+ref+"='"+mxobj.getGuid()+"']";return void callback(constraint)}const meta=window.mx.meta.getEntity(entity);null!=meta?mxobj.isA(entity)?meta.isReference(ref)?""!==mxobj.get(ref)?self.get({guids:mxobj.getReferences(ref),callback:fetchDeepRefs,error:error}):callback(null):runErrorHandler(error,null,new Error(`Reference ${ref} not found in entity ${entity}`)):runErrorHandler(error,null,new AssertionError(`Entity ${mxobj.getEntity()} is not a ${entity} or one of its subclasses`)):runErrorHandler(error,null,new Error(`Entity ${entity} does not exist`))}()}(mxobj,path,function(constraint){constraint?constraints.push(constraint):allMatched=!1,fetchConstraints()},createErrorHandler(error,scope)):callback.call(scope,constraints.join(""),allMatched)};guid?self.get({guid:guid,callback:function(obj){obj?(mxobj=obj,fetchConstraints()):callback.call(scope,"",!1)},error:createErrorHandler(error,scope)}):callback.call(scope,"",!1)}else callback.call(scope,"",!0)},this.toString=function(){return"mendix.sys.Data"},this.startup=function(backend){currentBackend=backend;const gcPeriod=null!=config.garbageCollectionInterval?Number(config.garbageCollectionInterval):1e4;0!==gcPeriod&&(gcInterval=window.setInterval(collectGarbage,gcPeriod))},this.subscribe=function(args,scope){if(!args.val)return subscribe(Object.assign({},args,{callback(){if(args.callback){if(args.entity)return args.callback.apply(scope,[args.entity]);if(args.attr){const object=objectCache.getObject(args.guid),val=null!=object?object.get(args.attr):null;return args.callback.apply(scope,[args.guid,args.attr,null!=val?val:""])}return args.callback.apply(scope,[args.guid])}}}));const subscription=Object.assign({},args,{callback(...callbackArgs){args.callback&&args.callback.apply(scope,callbackArgs)}});return valSubscriptions.push(subscription),{unsubscribe:()=>{const index=valSubscriptions.indexOf(subscription);-1!==index&&valSubscriptions.splice(index,1)}}},this.unsubscribe=function(handle){if(!("unsubscribe"in handle))throw new AssertionError("Trying to unsubscribe using an invalid subscription handle");handle.unsubscribe()},this.sendValidationUpdates=action(function(validations){const lostValidations=[];if(validations.forEach(validation=>{const unhandledAttrVal=validation.clone(),valAttrs=validation.getAttributes().map(a=>a.name);valSubscriptions.filter(({val:val,guid:guid,attr:attr})=>val&&null!=attr&&guid===validation.getGuid()&&valAttrs.includes(attr)).forEach(({attr:attr,callback:callback})=>{callback(validation.getErrorReason(attr)),unhandledAttrVal.removeAttribute(attr)}),valSubscriptions.filter(({val:val,guid:guid,attr:attr})=>val&&null==attr&&guid===validation.getGuid()).forEach(({callback:callback})=>{const trackValidation=validation.clone();callback([trackValidation]);const leftAttrs=trackValidation.getAttributes().map(a=>a.name);unhandledAttrVal.getAttributes().forEach(({name:attr})=>{leftAttrs.includes(attr)||unhandledAttrVal.removeAttribute(attr)})}),unhandledAttrVal.getAttributes().length>0&&lostValidations.push(unhandledAttrVal)}),lostValidations.length){const validationsText=ObjectValidation.describe(lostValidations);window.mx.ui.showMessage("error",validationsText,!1)}}),this.updateInCache=function(json){return objectCache.removeAllChanges([json.guid]),objectCache.setMxObjects([json]),objectCache.getObject(json.guid)},this.removeChanges=function(guid){objectCache.removeAllChanges([guid])},this.action=function(kwArgs){currentBackend.action(kwArgs.params,kwArgs.context||new MxContext,kwArgs.origin,!!kwArgs.async,kwArgs.onValidation).then(kwArgs.callback,createErrorHandler(kwArgs.error,null))},this.callNanoflow=function({nanoflow:nanoflow,context:context,origin:origin,callback:callback,error:error}){(async function(){const nanoflowId=nanoflow.nanoflow,args=await getNanoflowArguments(nanoflowId,context);try{return nanoflowEngine.execute(nanoflowId,args,origin)}catch(e){throw await handleRuntimeError(this._objectCache,e),e}})().then(runCallback1(callback,null),createErrorHandler(error,null))},this.get=function(args,scope){var xpath=args.xpath,path=args.path,id=args.guid,ids="guids"in args||!id?""===args.guids?[]:args.guids:[id],entity=args.entity,direction=args.direction||"reverse",callback=args.callback,error=args.error,needCount=!!args.count,kwfilter=args.filter,context=args.context||new MxContext,microflow=args.microflow;if("guid"in args&&null==id)runCallback(callback,scope,null);else{if(!(xpath||ids||microflow||entity))throw new AssertionError("xpath, guid|guids and microflow arguments are undefined");if(path&&1!==ids.length)throw new AssertionError("path can only be used with a single guid");if("function"!=typeof callback)throw new AssertionError("callback is not a function");if(error&&"function"!=typeof error)throw new AssertionError("error is not a function");kwfilter&&kwfilter.limit&&(kwfilter.amount=kwfilter.limit,delete kwfilter.limit);var filter=function(target,source,map){if(!source)return target;for(var i in map)i in source&&null!=source[i]&&(target[i]=source[i]);return target}({},kwfilter,id?{id:null}:{id:null,attributes:null,offset:null,sort:null,amount:null,distinct:null,references:null}),errback=createErrorHandler(error,scope);if(filter.id&&ids&&!id&&delete filter.id,filter.id&&(delete filter.attributes,delete filter.distinct),microflow){var applyto=ids?"selection":xpath?"set":"none",params={actionname:microflow,applyto:applyto};"selection"===applyto?params.guids=ids:"set"===applyto&&(params.xpath=xpath,filter.sort&&(params.sort=filter.sort)),self.action({params:params,context:context,callback:runCallback1(callback,scope),error:errback})}else if(path&&ids)currentBackend.getByPath(ids[0],path,entity,direction).then(({mxobjs:mxobjs,count:count})=>{runCallback(callback,scope,mxobjs,{count:count})},createErrorHandler(error,scope));else if(ids){if(0===ids.length)return void runCallback(callback,scope,id?null:[],{count:0});(ids.every(guid=>objectCache.has(guid))?Promise.resolve(function(guids,filter){filter=filter||{};let objs=guids.map(guid=>objectCache.getObject(guid)).filter(mxobj=>null!=mxobj);filter.sort&&filter.sort.forEach(sort=>{var attr=sort[0],dir=sort[1];objs=objs.sort((a,b)=>(a=a.get(attr),b=b.get(attr),a<b?"asc"===dir?-1:1:a>b?"asc"===dir?1:-1:0))});const offset=filter.offset;if(offset){const limit=filter.amount;objs=limit?objs.slice(offset,offset+limit):objs.slice(offset)}return{mxobjs:objs,count:objs.length}}(ids,filter)):currentBackend.getByGuid(ids,filter)).then(({mxobjs:mxobjs,count:count})=>{var result;result=id?filter.id?mxobjs.find(mxobj=>mxobj.getGuid()===id)||null:mxobjs[0]||null:mxobjs,runCallback(callback,scope,result,{count:count})},errback)}else if(entity)if(window.mx.isOffline()){const{amount:limit,offset:offset,sort:sort}=filter;currentBackend.getSlice(entity,[],{limit:limit,offset:offset,sort:sort},!1).then(({mxobjs:mxobjs,count:count})=>{runCallback(callback,scope,mxobjs,{count:count})})}else{const{amount:amount,offset:offset,sort:sort}=filter;currentBackend.getByXPath(`//${entity}`,{amount:amount,offset:offset,sort:sort},needCount).then(({mxobjs:mxobjs,count:count})=>{runCallback(callback,scope,mxobjs,{count:count})},errback)}else currentBackend.getByXPath(xpath,filter,needCount).then(({mxobjs:mxobjs,count:count,aggregates:aggregates})=>{runCallback(callback,scope,mxobjs,{count:count,aggregates:aggregates})},errback)}},this.getOffline=function(entity,constraints,filter,callback,error){return this.getSlice(entity,constraints,filter,!1,callback,error)},this.getSlice=function(entity,constraints,filter,useCache,callback,error){currentBackend.getSlice(entity,constraints,filter,useCache).then(({mxobjs:mxobjs,count:count})=>{runCallback(callback,null,mxobjs,count)}).catch(createErrorHandler(error,null))},this.fetch=function(obj,path,params,callback,error){var pathComponents,attr;"function"==typeof params&&(error=callback,callback=params),pathComponents=path?path instanceof Array?path.slice():path.split("/"):[],obj&&obj.isA(pathComponents[0])&&pathComponents.shift(),attr=pathComponents.length%2==1?pathComponents.pop():"",function(objectCache,obj,pathComponents,attr,params,callback,error){let schemaComponents;schemaComponents=(params=params||{}).schema?pathComponents.splice(-2,pathComponents.length):[],performFetch(objectCache,obj,pathComponents,schemaComponents,attr,params,callback,error)}(objectCache,obj,pathComponents,attr,params,callback,createErrorHandler(error,null))},this.create=function(params,thisObject){if("function"!=typeof params.callback)throw new AssertionError("callback is not a function");if(params.error&&"function"!=typeof params.error)throw new AssertionError("error is not a function");if("string"!=typeof params.entity)throw new AssertionError("entity is not a string");currentBackend.create(params.entity).then(function(mxobj){params.context&&self.setObjectToContext(mxobj,params.context);runCallback(params.callback,thisObject,mxobj)},createErrorHandler(params.error,thisObject))},this.remove=function(kwArgs){const guids="guid"in kwArgs?[kwArgs.guid]:""===kwArgs.guids?[]:kwArgs.guids;if("guids"in kwArgs&&!(kwArgs.guids instanceof Array))throw new AssertionError("parameter guids set but not of type Array");if(kwArgs.error&&"function"!=typeof kwArgs.error)throw new AssertionError("parameter error set but not of type Function");if(kwArgs.callback&&"function"!=typeof kwArgs.callback)throw new AssertionError("parameter callback set but not of type Function");currentBackend.remove(guids).then(runCallback0(kwArgs.callback),createErrorHandler(kwArgs.error,null))},this.validate=function(mxobjs,callback,error){0!==mxobjs.length?currentBackend.validate(mxobjs.map(getGuid)).then(runCallback0(callback),createErrorHandler(error,null)):runCallback(callback)},this.commit=function(kwArgs,thisObject){const successHandler=runCallback0(kwArgs.callback,thisObject),errorHandler=createErrorHandler(kwArgs.error,thisObject),mxobjs=normalizeArguments(kwArgs);if(0===mxobjs.length&&kwArgs.callback)return void successHandler();const guids=mxobjs.map(mxobj=>mxobj.getGuid());currentBackend.commit(guids,kwArgs.context||new MxContext,kwArgs.store,kwArgs.onValidation).then(function(json){handleUncachedObjects(objectCache,mxobjs,json);const entityUpdates=unique$1(mxobjs.filter(isCached).map(getEntity)).map(entity=>({entity:entity})),objectUpdates=unique$1(mxobjs.map(getGuid)).map(guid=>({guid:guid})),updates=entityUpdates.concat(objectUpdates);publish(...updates).then(successHandler,errorHandler)},errorHandler)},this.rollback=function(kwArgs,thisObject){const errorHandler=createErrorHandler(kwArgs.error,thisObject),callingMxObjs=normalizeArguments(kwArgs);if(0===callingMxObjs.length)return void runCallback(kwArgs.callback,thisObject);const entityUpdates=unique$1(callingMxObjs.map(getEntity)).map(entity=>({entity:entity})),guids=callingMxObjs.map(mxobj=>mxobj.getGuid());currentBackend.rollback(guids).then(function(json){handleUncachedObjects(objectCache,callingMxObjs,json);const objectUpdates=unique$1(callingMxObjs.filter(isCached).map(getGuid)).map(guid=>({guid:guid})),updates=entityUpdates.concat(objectUpdates);publish(...updates).then(runCallback1(kwArgs.callback,thisObject),errorHandler)},errorHandler)},this.uploadOffline=async function(){await currentBackend.upload()},this.downloadOffline=async function(){const fetchConfig=window.mx.session.getConfig("sync_config.fetch")||[];await currentBackend.download(fetchConfig)},this.synchronizeOffline=function(_args,callback,error){this.uploadOffline().then(()=>this.downloadOffline()).then(runCallback0(callback),createErrorHandler(error,null))},this.saveDocument=function(guid,fileName,params,blob,callback,error){const errorHandler=createErrorHandler(error,null);currentBackend.saveDocument(guid,fileName,params,blob).then(function(){publish({guid:guid}).then(callback,errorHandler)},errorHandler)},this.generateReport=function(reportId,offset,limit,params,callback,error){currentBackend.generateReport(reportId,offset,limit,params).then(callback,createErrorHandler(error,null))},this.generateExcelReport=function(reportId,params,callback,error){currentBackend.generateExcelReport(reportId,params).then(callback,createErrorHandler(error,null))},this.getReportParameters=function(reportId,callback,error){currentBackend.getReportParameters(reportId).then(callback,createErrorHandler(error,null))},this.setObjectToContext=function(mxObj,context){if("object"!=typeof mxObj)throw new AssertionError("parameter mxObj is not of type Object");if("object"!=typeof context)throw new AssertionError("parameter context is not of type Object");for(var eAttrs=mxObj.getAttributes(),e=0;e<eAttrs.length;e++)if(mxObj.isReference(eAttrs[e])){var _className=mxObj.getSelectorEntity(eAttrs[e]);if("System.owner"===eAttrs[e]||"System.changedBy"===eAttrs[e])continue;context.hasContext(_className)&&mxObj.addReference(eAttrs[e],context.getContext(_className));var meta=window.mx.meta.getEntity(_className);if(meta&&meta.hasSubEntities())for(var subtypees=meta.getSubEntities(),i=0;i<subtypees.length;i++)context.hasContext(subtypees[i])&&mxObj.addReference(eAttrs[e],context.getContext(subtypees[i]))}},this.getObjectFromContext=function(context,callback){var trackObj=context.getObject(),trackId=context.getTrackId();trackObj?callback(trackObj):trackId?window.mx.data.get({guid:trackId,callback:function(obj){obj||window.mx.onError("Error while fetching object with guid "+trackId),callback(obj)},error:function(e){window.mx.onError(e),callback(null)}},this):callback(null)},this.isDirty=function(guid){return currentBackend.isDirty(guid)},this.isNew=function(guid){return objectCache.isNew(guid)},this.makeChange=function(guid,attr,rawValue){objectCache.makeChange(guid,attr,rawValue)},this.getChanges=function(guid){return objectCache.getChanges(guid)},this.getCachedObject=function(guid){return objectCache.getObject(guid)},this.dehydrateCache=function(){return objectCache.dehydrate()},this.hydrateCache=function(state){return objectCache.hydrate(state)},this.getDocumentUrl=function(guid,changedDate,isThumb){return currentBackend.getDocumentUrl(guid,changedDate,isThumb)},this.getImageUrl=function(url,callback,error){currentBackend.getImageUrl(url).then(callback,error)},this.clear=function(callback){objectCache.clear(),currentBackend.cleanup().then(callback)},this.uninitialize=function(){gcInterval&&window.clearInterval(gcInterval)},this.getObjectsStatistics=function(){return objectCache.getAllObjects().map(obj=>({object:obj,changes:objectCache.getChanges(obj.getGuid()),uncommitted:objectCache.isNew(obj.getGuid()),subscriptions:getTags(obj.getGuid()).concat(valSubscriptions.filter(v=>v.guid===obj.getGuid()).map(v=>v.tag))}))}}function MxMetaObject(kwArgs){var jsonData=kwArgs.json;if(!(jsonData&&jsonData.attributes&&jsonData.objectType&&jsonData.properties))throw new Error("MxMetaObject: invalid initialization");this.has=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.has: parameter attr is not of type String.");return Object.prototype.hasOwnProperty.call(jsonData.attributes,attr)},this.isEnum=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.isEnum : parameter attr is not of type String.");return/^(Enum|EnumSet)$/.test(this.getAttributeType(attr))},this.isNumeric=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.isNumeric : parameter attr is not of type String.");return/^(Integer|Long|Decimal)$/.test(this.getAttributeType(attr))},this.isPassword=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.isDate : parameter attr is not of type String.");return"HashString"===this.getAttributeType(attr)},this.isDate=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.isDate : parameter attr is not of type String.");return/^(Date|DateTime)$/.test(this.getAttributeType(attr))},this.isLocalizedDate=function(attr){return this.isDate(attr)?/true/.test(jsonData.attributes[attr].localize):null},this.isBoolean=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.isBoolean : parameter attr is not of type String.");return"Boolean"===this.getAttributeType(attr)},this.isReference=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.isReference : parameter attr is not of type String.");return/^(ObjectReference|ObjectReferenceSet)$/.test(this.getAttributeType(attr))},this.isObjectReference=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.isObjectReference : parameter attr is not of type String.");return"ObjectReference"===this.getAttributeType(attr)},this.isObjectReferenceSet=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.isObjectReferenceSet : parameter attr is not of type String.");return"ObjectReferenceSet"===this.getAttributeType(attr)},this.isBidirectionalReference=function(attr){return this.isReference(attr)&&Boolean(jsonData.attributes[attr].both)},this.getOptions=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.getOptions : parameter attr is not of type String.");if(!this.isEnum(attr))throw new Error("mendix/lib/MxMetaObject.getOptions : attribute '"+attr+"' is not an Enumeration.");try{var opts=[];if(this.has(attr)){var arr=jsonData.attributes[attr].options;if(arr&&arr.length){opts=[];for(var i=0;i<arr.length;i++)for(var j in arr[i])opts.push(arr[i][j])}}return opts}catch(e){return[]}},this.getEnumMap=function(attr){if(!this.isEnum(attr))return null;for(var map=[],arr=jsonData.attributes[attr].options,i=0;i<arr.length;i++)for(var j in arr[i]){map.push({key:j,caption:arr[i][j]});break}return map},this.getEnumKVPairs=function(attr){if(!this.isEnum(attr))return null;for(var map={},arr=jsonData.attributes[attr].options,i=0;i<arr.length;i++)for(var j in arr[i])map[j]=arr[i][j];return map},this.getEnumCaption=function(attr,value){if(!this.isEnum(attr))return null;for(var arr=jsonData.attributes[attr].options,i=0;i<arr.length;i++){var item=arr[i];for(var key in item)if(key===value)return item[key]}return value},this.getReferenceAttributes=function(){var refs=[];for(var i in jsonData.attributes)this.isReference(i)&&refs.push(i);return refs},this.getAttributes=function(){var attrs=[];for(var i in jsonData.attributes)attrs.push(i);return attrs},this.getAttributesWithoutReferences=function(){var attrs=[];for(var i in jsonData.attributes)this.isReference(i)||attrs.push(i);return attrs},this.getAttributeType=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.getAttributeType : parameter attr is not of type String.");return!!this.has(attr)&&jsonData.attributes[attr].type},this.getSelectorEntity=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.getSelectorEntity : parameter attr is not of type String.");return!!this.has(attr)&&jsonData.attributes[attr].klass},this.getEntity=function(){return jsonData.objectType},this.isPersistable=function(){return jsonData.persistable},this.needsReachableState=function(action){return!(action in jsonData.needsReachableState)||jsonData.needsReachableState[action]},this.isA=function(entity){return this.getEntity()===entity||this.inheritsFrom(entity)},this.hasSuperEntities=function(){return 0!==jsonData.properties.superclasses.length},this.getSuperEntities=function(){var supers=jsonData.properties.superclasses;return"string"==typeof supers?[supers]:supers},this.hasSubEntities=function(){return 0!==jsonData.properties.subclasses.length},this.getSubEntities=function(){var subs=jsonData.properties.subclasses;return"string"==typeof subs?[subs]:subs},this.inheritsFrom=function(ancestor){return(this.getSuperEntities()||[]).includes(ancestor)},this.isSyncable=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.isObjectReferenceSet : parameter attr is not of type String.");return!!this.has(attr)&&(void 0===jsonData.attributes[attr].sync||jsonData.attributes[attr].sync)}}function Meta(){const metaObjects={},cachedAttributeOwner={};this.startup=function(){window.mx.session.getConfig("metadata").forEach(function(metaJson){const metaObject=new MxMetaObject({json:metaJson});metaObjects[metaObject.getEntity()]=metaObject})},this.getMap=function(){return metaObjects},this.getEntity=function(entity){const meta=metaObjects[entity];return meta||window.mx.logger.error("No permission to read or write entity "+entity+", check security!"),meta},this.getAttributeOwner=function(entity,attr){const cacheKey=entity+"."+attr,cachedResult=cachedAttributeOwner[cacheKey];if(null!=cachedResult)return cachedResult;const meta=this.getEntity(entity);if(!meta||!meta.has(attr))return null;const[superMostEntity]=[entity].concat(meta.getSuperEntities()).filter(superEntity=>this.getEntity(superEntity).has(attr)).slice(-1);return cachedAttributeOwner[cacheKey]=superMostEntity,superMostEntity}}var UNKNOWN_FUNCTION="<unknown>";function parse(stackString){return stackString.split("\n").reduce(function(stack,line){var parseResult=function(line){var parts=chromeRe.exec(line);if(!parts)return null;var isNative=parts[2]&&0===parts[2].indexOf("native"),isEval=parts[2]&&0===parts[2].indexOf("eval"),submatch=chromeEvalRe.exec(parts[2]);isEval&&null!=submatch&&(parts[2]=submatch[1],parts[3]=submatch[2],parts[4]=submatch[3]);return{file:isNative?null:parts[2],methodName:parts[1]||UNKNOWN_FUNCTION,arguments:isNative?[parts[2]]:[],lineNumber:parts[3]?+parts[3]:null,column:parts[4]?+parts[4]:null}}(line)||function(line){var parts=winjsRe.exec(line);if(!parts)return null;return{file:parts[2],methodName:parts[1]||UNKNOWN_FUNCTION,arguments:[],lineNumber:+parts[3],column:parts[4]?+parts[4]:null}}(line)||function(line){var parts=geckoRe.exec(line);if(!parts)return null;var isEval=parts[3]&&parts[3].indexOf(" > eval")>-1,submatch=geckoEvalRe.exec(parts[3]);isEval&&null!=submatch&&(parts[3]=submatch[1],parts[4]=submatch[2],parts[5]=null);return{file:parts[3],methodName:parts[1]||UNKNOWN_FUNCTION,arguments:parts[2]?parts[2].split(","):[],lineNumber:parts[4]?+parts[4]:null,column:parts[5]?+parts[5]:null}}(line)||function(line){var parts=javaScriptCoreRe.exec(line);if(!parts)return null;return{file:parts[3],methodName:parts[1]||UNKNOWN_FUNCTION,arguments:[],lineNumber:+parts[4],column:parts[5]?+parts[5]:null}}(line)||function(line){var parts=nodeRe.exec(line);if(!parts)return null;return{file:parts[2],methodName:parts[1]||UNKNOWN_FUNCTION,arguments:[],lineNumber:+parts[3],column:parts[4]?+parts[4]:null}}(line);return parseResult&&stack.push(parseResult),stack},[])}var chromeRe=/^\s*at (.*?) ?\(((?:file|https?|blob|chrome-extension|native|eval|webpack|<anonymous>|\/).*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,chromeEvalRe=/\((\S*)(?::(\d+))(?::(\d+))\)/;var winjsRe=/^\s*at (?:((?:\[object object\])?.+) )?\(?((?:file|ms-appx|https?|webpack|blob):.*?):(\d+)(?::(\d+))?\)?\s*$/i;var geckoRe=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)((?:file|https?|blob|chrome|webpack|resource|\[native).*?|[^@]*bundle)(?::(\d+))?(?::(\d+))?\s*$/i,geckoEvalRe=/(\S+) line (\d+)(?: > eval line \d+)* > eval/i;var javaScriptCoreRe=/^(?:\s*([^@]*)(?:\((.*?)\))?@)?(\S.*?):(\d+)(?::(\d+))?\s*$/i;var nodeRe=/^\s*at (?:((?:\[object object\])?\S+(?: \[as \S+\])?) )?\(?(.*?):(\d+)(?::(\d+))?\)?\s*$/i;class RuntimeSocketConnection{constructor(url){this.url=url,this.reloadHandlers=[],this.connectHandlers=[]}isConnected(){return void 0!==this.socket&&this.socket.readyState===WebSocket.OPEN}onConnect(handler){this.isConnected()?handler():this.connectHandlers.push(handler)}onReloadMessage(handler){this.reloadHandlers.push(handler)}sendLog(level,message){if(this.isConnected()){const maxSendLength=6e4;for(let offset=0;offset<message.length;offset+=maxSendLength){const messagePart=message.substr(offset,maxSendLength);ensure(this.socket).send(`log:${level}:${messagePart}`)}}}connect(){try{this.socket=new WebSocket(this.url),this.socket.onopen=()=>{this.connectHandlers.forEach(handler=>handler()),this.connectHandlers.splice(0)},this.socket.onmessage=message=>{if("MENDIX_RELOAD"!==message.data)throw new AssertionError(`Unexpected command received from the runtime: ${message.data}`);this.reloadHandlers.forEach(handler=>handler())},this.socket.onclose=()=>this.reconnect()}catch(e){this.reconnect()}}reconnect(){this.socket=void 0,setTimeout(()=>this.connect(),1e3)}}class DevTools{constructor(remoteUrl){this.connection=new RuntimeSocketConnection(remoteUrl.replace(/^http/,"ws")+"reload/")}connect(){this.connection.connect()}addOnReload(handler){this.connection.onReloadMessage(handler)}log(level,...args){const messages=args.map(convertArgument);this.connection.onConnect(()=>this.connection.sendLog(level,messages.join("\n")))}}function convertArgument(arg){if("string"==typeof arg)return arg;if(arg instanceof Error)return`${arg.message} ${arg.stack}`;if(arg&&void 0!==arg.outerHTML)return arg.outerHTML;try{return JSON.stringify(arg)}catch(e){return"[Unserializable data. See browser console for the details]"}}class Logger{constructor({handleErrors:handleErrors=!0,isQuiet:isQuiet=!1}={}){this.logHandlers=[],isQuiet||this.addHandler(this.createConsoleLogHandler()),handleErrors&&"function"==typeof window.addEventListener&&(window.addEventListener("error",event=>this.error(event.error)),window.addEventListener("unhandledrejection",event=>this.error(event.reason)))}addHandler(handler){this.logHandlers.push(handler)}trace(...args){this.log("trace",...args)}debug(...args){this.log("debug",...args)}info(...args){this.log("info",...args)}warn(...args){this.log("warning",...args)}error(...args){this.log("error",...args)}critical(...args){this.log("critical",...args)}log(level,...args){this.logHandlers.forEach(handler=>handler(level,...args))}createConsoleLogHandler(){const originalLog={};return["debug","info","log","warn","error"].forEach(clientLevel=>{originalLog[clientLevel]=console[clientLevel];const runtimeLevel=function(clientLevel){switch(clientLevel){case"warn":return"warning";case"log":return"debug";default:return clientLevel}}(clientLevel);console[clientLevel]=(...args)=>this.log(runtimeLevel,...args)}),(runtimeLevel,...args)=>{const clientLevel=function(runtimeLevel){switch(runtimeLevel){case"trace":return;case"critical":return"error";case"warning":return"warn";default:return runtimeLevel}}(runtimeLevel);void 0!==clientLevel&&originalLog[clientLevel].call(console,...args)}}}function MxObjectCache(){this._objectCache={},this._newGuids={},this._changes={}}MxObjectCache.prototype.getAllObjects=function(){return Object.values(this._objectCache)},MxObjectCache.prototype.dehydrate=function(){return clone$1({data:this.getAllObjects(),newGuids:this._newGuids,changes:this._changes})},MxObjectCache.prototype.hydrate=function({data:data,newGuids:newGuids,changes:changes}){this._objectCache={},data.map(rawObj=>MxObject.fromJson(rawObj)).forEach(mxobj=>{this._objectCache[mxobj.getGuid()]=mxobj}),this._newGuids=clone$1(newGuids),this._changes=clone$1(changes)},MxObjectCache.prototype.getObject=function(guid){return this._objectCache[guid]||null},MxObjectCache.prototype.removeObjectKeepChanges=function(guid){delete this._objectCache[guid],delete this._newGuids[guid]},MxObjectCache.prototype.setMxObjects=function(rawObjs){rawObjs.forEach(function(rawObj){var guid=rawObj.guid,cacheObj=this._objectCache[guid];cacheObj?cacheObj.resetFromJSON(rawObj):this._objectCache[guid]=new MxObject({json:rawObj,meta:window.mx.meta.getEntity(rawObj.objectType)})},this)},MxObjectCache.prototype.has=function(guid){return!!this.getObject(guid)},MxObjectCache.prototype.isNew=function(guid){return this.has(guid)&&Boolean(this._newGuids[guid])},MxObjectCache.prototype.clear=function(){this._objectCache={},this._newGuids={},this._changes={}},MxObjectCache.prototype.hasChanges=function(guid){return guid in this._changes},MxObjectCache.prototype.getChanges=function(guid){return clone$1(this._changes[guid]||{})},MxObjectCache.prototype.makeChange=function(guid,attr,value){this._changes[guid]=this._changes[guid]||{},this._changes[guid][attr]={value:value}},MxObjectCache.prototype.removeAllChanges=function(guids){guids.forEach(function(guid){delete this._changes[guid]},this)},MxObjectCache.prototype.removeChanges=function(resets){Object.keys(resets).forEach(guid=>{const changes=this._changes[guid];changes&&(resets[guid].forEach(attr=>delete changes[attr]),0===Object.keys(changes).length&&delete this._changes[guid])})},MxObjectCache.prototype.onCreate=function(guids){guids.forEach(guid=>{this._newGuids[guid]=!0})},MxObjectCache.prototype.onCommit=function(guids){guids.forEach(guid=>delete this._newGuids[guid])},MxObjectCache.prototype.onDelete=function(guids){for(const guid of guids)guid in this._objectCache&&this._objectCache[guid].markAsUnavailable();this.removeObjects(guids)},MxObjectCache.prototype.addChanges=function(changes){for(const guid in changes){const objChanges=changes[guid];null==this._changes[guid]&&(this._changes[guid]={});const existingObjChanges=this._changes[guid];for(const attr in objChanges)existingObjChanges[attr]=objChanges[attr]}},MxObjectCache.prototype.removeObjects=function(guids){guids.forEach(guid=>{delete this._objectCache[guid],delete this._newGuids[guid],delete this._changes[guid]})};const clone=objectToClone=>{if(null===objectToClone||"object"!=typeof objectToClone)return objectToClone;const objectClone=Array.isArray(objectToClone)?[]:{};return Object.keys(objectToClone).forEach(prop=>objectClone[prop]=clone(objectToClone[prop])),objectClone};function getStaticResourceUrl(url){if(url.startsWith("data:"))return url;/^\w+:\/\//.test(url)||(url=function(path){return path.startsWith("data:")?path:mx.appUrl+path}(url));const cacheBust=mx.session.getConfig("cachebust");return url.startsWith(mx.appUrl)&&!url.endsWith(cacheBust)&&(url+=(url.includes("?")?"&":"?")+cacheBust),url}function getRemoteDynamicResourceUrl(guid,changedDate,isThumb){return mx.remoteUrl+function(guid,changedDate,isThumb){let url="file?"+["guid="+guid,"changedDate="+changedDate].join("&");return isThumb&&(url+="&thumb=true"),url}(guid,changedDate,isThumb)}function createRetryOnUnauthorizedMiddleware(recover){const ignoredActions=["get_session_data","login","logout"];let recoverPromise,sessionCounter=0;return async(request,next)=>{const currentSessionNumber=sessionCounter;try{return await next(request)}catch(e){const action=isJson(request.body)?request.body.action:void 0;if(!(e instanceof UnauthorizedError)||void 0!==action&&ignoredActions.includes(action))throw e;if(currentSessionNumber!==sessionCounter)return next(request);if(recoverPromise)return await recoverPromise,next(request);recoverPromise=recover();try{await recoverPromise}finally{recoverPromise=void 0}return++sessionCounter,next(request)}}}class Session{constructor(sessionStore,tokenStore,config){this.sessionStore=sessionStore,this.tokenStore=tokenStore,this.config=config,this.clientMetadata={}}isValid(){return void 0!==this.sessionData}getConfig(path){if(void 0===this.sessionData)throw new Error("Session is not available");if(!path)return clone(this.sessionData);const steps=path.split(".");let result=this.sessionData;for(let i=0;i<steps.length&&result;i++)result=result[steps[i]];return clone(result)}getUserObject(){return this.userObject||(this.userObject=MxObject.fromJson(this.getConfig("user"))),this.userObject}isGuest(){return this.getUserObject().get("IsAnonymous")}getSessionObjectId(){return this.getConfig("sessionObjectId")}getUserId(){return this.getUserObject().getGuid()}getUserRoleNames(){return this.getConfig("roles")}hasSomeRole(roles){if(void 0===roles)return!0;const userRoleNames=this.getUserRoleNames();return roles.some(role=>userRoleNames.includes(role))}getMicroflowInfo(microflowName){return this.clientMetadata[microflowName]}async login(args){const data=await async function(username,password,shouldGenerateToken){return post(xasUrl(),{action:"login",params:{username:username,password:password,shouldgeneratetoken:shouldGenerateToken}})}(args.username,args.password,this.config.shouldGenerateToken);await this.sessionStore.remove(),data.authtoken&&await this.tokenStore.set(data.authtoken)}destroySession(callback){callback()}async logout(){try{const token=await this.tokenStore.get();await async function(authToken){return post(xasUrl(),{action:"logout",params:authToken?{authtoken:authToken}:{}})}(token)}catch(e){if(!(e instanceof ConnectionError))throw e}finally{await this.tokenStore.remove(),await this.sessionStore.remove()}}async startup(params){const authToken=await this.tokenStore.get();this.sessionParams=authToken?Object.assign({authtoken:authToken},params):params;const{sessionData:sessionData,fromCache:fromCache}=await this.loadSessionData();this.sessionData=sessionData;const isOffline=Boolean(sessionData.sync_config);var handler,getCsrfToken;return isOffline&&await this.sessionStore.set(JSON.stringify(sessionData)),registerMiddleware(authToken&&isOffline?createRetryOnUnauthorizedMiddleware(this.restoreSessionOnUnauthorized.bind(this)):authToken?createRetryOnUnauthorizedMiddleware(async()=>mx.reload()):(handler=this.failOnUnauthorized.bind(this),async(request,next)=>{try{return await next(request)}catch(err){const action=isJson(request.body)&&request.body.action;if(err instanceof UnauthorizedError&&"login"!==action)return handler(err);throw err}})),!sessionData.sync_config&&sessionData.keepalive&&setInterval(keepalive,sessionData.keepalive),registerMiddleware((getCsrfToken=()=>ensure(this.sessionData).csrftoken,(request,next)=>{const requestWithToken={url:request.url,init:Object.assign({},request.init,{headers:new Headers(request.init.headers)}),body:request.body};return requestWithToken.init.headers.append("X-Csrf-Token",getCsrfToken()),next(requestWithToken)})),await this.loadClientMetadata(),!fromCache}onUnauthorized(status){return status}async loadSessionData(){const oldSessionDataStr=await this.sessionStore.get(),oldSessionData=void 0!==oldSessionDataStr?JSON.parse(oldSessionDataStr):void 0;if(oldSessionData&&oldSessionData.cachebust===this.config.currentCacheBust)return{fromCache:!0,sessionData:oldSessionData};try{return{fromCache:!1,sessionData:await getSessionData(ensure(this.sessionParams))}}catch(e){if(401===e.status)throw await this.sessionStore.remove(),await this.tokenStore.remove(),e;if(460!==e.status&&oldSessionData)return{fromCache:!0,sessionData:oldSessionData};throw e}}async loadClientMetadata(){const response=await get$1(getStaticResourceUrl("metamodel.json"),"json");Object.keys(response).forEach(key=>{const mfData=response[key];this.clientMetadata[key]={parameters:mfData.p},mfData.a&&(this.clientMetadata[key].followedAssociations=mfData.a.map(([association,fromEntity])=>({association:association,fromEntity:fromEntity})))})}async restoreSessionOnUnauthorized(){try{const{csrftoken:csrftoken}=await getSessionData(ensure(this.sessionParams));ensure(this.sessionData).csrftoken=csrftoken,await this.sessionStore.set(JSON.stringify(this.sessionData))}catch(e){if(!(e instanceof UnauthorizedError))throw e;await this.failOnUnauthorized(e)}}async failOnUnauthorized(error){return await this.sessionStore.remove(),await this.tokenStore.remove(),this.onUnauthorized(error.status),never()}}function executeSql(sql,parameters){return Transaction.inside((tx,resolve,reject)=>tx.executeSql(sql,parameters,(_,r)=>resolve(r.rows),(_,e)=>(reject(e),!0))).chain(rows=>{const result=[];for(let i=0;i<rows.length;++i)result.push(rows.item(i));return result})}class Transaction{constructor(){this.work=[]}chain(onfulfilled){const result=new Transaction;return result.work.push(...this.work,{action:!1,item:onfulfilled}),result}async read(database){return this.execute((cb,err)=>database.readTransaction(cb,err))}async execute(createTx){return new Promise((resolve,reject)=>createTx(tx=>{const works=Array.from(this.work);!function process(previousResult){previousResult instanceof Transaction&&(works.unshift(...previousResult.work),previousResult=void 0);const work=works.shift();if(!work)return void resolve(previousResult);if(work.action)work.item(tx,process,reject);else try{const newResult=work.item(previousResult);process(newResult)}catch(e){reject(e)}}(tx)},reject))}static inside(action){const result=new Transaction;return result.work.push({action:!0,item:action}),result}}const NUMBER_PRECISION=20,METADATA_TABLE="_guidToTable",GUID_COLUMN="guid",READONLY_COLUMN="readonlyAttrs",METADATA_COLUMNS=[GUID_COLUMN,READONLY_COLUMN],LIKE_ANY_CHAR="%",LIKE_SOME_CHAR="_";function toSafeKey(key){return key.replace(".","$")}function attributeToSql(value){if(void 0===value)return null;if(value instanceof Big$1)return function(x){const nrOfZeroes=NUMBER_PRECISION-Math.max(0,x.e)-1,sign=x.s<0?"-":"",zeroes=new Array(nrOfZeroes+1).join("0"),absNumber=x.abs().toFixed();return sign+zeroes+absNumber}(value);if(value instanceof Date)return Number(value);if("boolean"==typeof value)return function(x){return x?1:0}(value);if(Array.isArray(value))throw new AssertionError;return value}function sqlToRuntime(value,type){if(null===value)return null;switch(type){case"DateTime":return value;case"Boolean":return Boolean(value);case"Decimal":case"Integer":case"Long":return function(x){const sign=x.startsWith("-")?"-":"",meaningfulDigits=x.replace(/^-?0*/,"");return sign+(""!==meaningfulDigits?meaningfulDigits:"0")}(value);default:return String(value)}}class SqlQueryBuilder{constructor(entity){this.tableName=toSafeKey(entity),this.fromClause=`FROM ${this.tableName} AS ${this.tableName}`}filtered(filter){const{type:type,expr:expr,params:params}=function toSqlFilter(filter,tableName){switch(filter.type){case"attribute":return{type:"Boolean"===filter.attributeType||"DateTime"===filter.attributeType?"int":"string",expr:`${tableName}.[${"id"!==filter.attribute?toSafeKey(filter.attribute):"guid"}]`,params:[]};case"value":const value=attributeToSql(filter.value);return null===value?{type:"null",expr:"NULL",params:[]}:{type:"number"==typeof value?"int":"string",expr:"?",params:[value]};case"function":const args=filter.parameters.map(p=>toSqlFilter(p,tableName));switch(filter.name){case"true":return ONE;case"false":return ZERO;case"not":{const arg1=toIntOrStringResult(args[0]);return{type:"int",expr:`(not ${arg1.expr})`,params:arg1.params}}case"or":case"and":{const fixedArgs=args.map(toIntOrStringResult);return{type:"int",expr:"("+fixedArgs.map(a=>a.expr).join(` ${filter.name} `)+")",params:combineParams(...fixedArgs)}}case"=":case"!=":case">":case">=":case"<":case"<=":{const[arg1,arg2]=args.some(a=>"int"===a.type)?args.map(castAsInt):args,operation="="===filter.name?"is":"!="===filter.name?"is not":filter.name;return{type:"int",expr:`(${arg1.expr} ${operation} ${arg2.expr})`,params:combineParams(arg1,arg2)}}case"contains":case"starts-with":case"ends-with":{if("null"===args[1].type)return ONE;if("null"===args[0].type)return ZERO;const expected=`replace(${`replace(${`replace(${args[1].expr}, "${escapeChar="~"}", "${escapeChar+escapeChar}")`}, "${LIKE_ANY_CHAR}", "${escapeChar+LIKE_ANY_CHAR}")`}, "${LIKE_SOME_CHAR}", "${escapeChar+LIKE_SOME_CHAR}")`,like="starts-with"===filter.name?`${expected} || '${LIKE_ANY_CHAR}'`:"ends-with"===filter.name?`'${LIKE_ANY_CHAR}' || ${expected}`:`'${LIKE_ANY_CHAR}' || ${expected} || '${LIKE_ANY_CHAR}'`;return{type:"int",expr:`(${args[0].expr} like ${like} escape '~')`,params:args[0].params.concat(args[1].params)}}case"length":case"string-length":return"null"===args[0].type?ZERO:{type:"int",expr:`length(${args[0].expr})`,params:args[0].params};default:throw new AssertionError(`Operator ${filter.name} is not yet supported`)}}var escapeChar}(filter,this.tableName);"null"!==type&&(this.whereClause=`WHERE ${expr}`,this.bindParameters=params||[])}sorted(sort){const sortStr=sort.map(([attr,order])=>`${this.tableName}.[${toSafeKey(attr)}] ${order}`).join(", ");this.orderClause=sortStr?`ORDER BY ${sortStr}`:""}paged(offset,amount){this.limitClause=`LIMIT ${void 0!==amount?amount:-1} OFFSET ${offset||0}`}selectWithMeta(columns){return[["SELECT",columns.map(col=>`${this.tableName}.[${toSafeKey(col)}] as "${toSafeKey(col)}"`).concat(METADATA_COLUMNS.map(col=>`${METADATA_TABLE}.[${col}] as "${METADATA_TABLE}.${col}"`)).join(", "),this.fromClause,`JOIN ${METADATA_TABLE} AS ${METADATA_TABLE} USING (${GUID_COLUMN})`,this.whereClause,this.orderClause,this.limitClause].filter(s=>s).join(" "),this.bindParameters||[]]}totalCount(){return[["SELECT count(*) AS count",this.fromClause,this.whereClause].filter(s=>s).join(" "),this.bindParameters||[]]}}const ONE={type:"int",expr:"1",params:[]},ZERO={type:"int",expr:"0",params:[]};function toIntOrStringResult(result){return"null"===result.type?{type:"int",expr:"0",params:[]}:result}function castAsInt(result){return"string"===result.type?{type:"int",expr:`cast(${result.expr} as integer)`,params:result.params}:result}function combineParams(...args){return[].concat(...args.map(a=>a.params))}class OfflineData{constructor(objectCache,database){this.objectCache=objectCache,this.database=database}async getByQuery(entity,filter,options){const meta=mx.meta.getEntity(entity),queryBuilder=new SqlQueryBuilder(entity);void 0!==filter&&queryBuilder.filtered(filter),void 0===options.offset&&void 0===options.amount||queryBuilder.paged(options.offset,options.amount),void 0!==options.sort&&queryBuilder.sorted(options.sort);const{rows:rows,count:count}=await executeSql(...queryBuilder.selectWithMeta(meta.getAttributes())).chain(rows=>executeSql(...queryBuilder.totalCount()).chain(countRows=>({rows:rows,count:countRows[0].count}))).read(this.database),objJsons=rows.map(r=>(function(meta,row){const result={guid:row[`${METADATA_TABLE}.${GUID_COLUMN}`],objectType:meta.getEntity(),attributes:{}},readonlyAttributes=JSON.parse(row[`${METADATA_TABLE}.${READONLY_COLUMN}`]);return Object.keys(row).filter(attrKey=>!attrKey.startsWith(METADATA_TABLE)).forEach(attrKey=>{const attr=function(key){return key.replace("$",".")}(attrKey),attrType=meta.getAttributeType(attr);result.attributes[attr]=Object.assign({value:sqlToRuntime(row[attrKey],attrType)},readonlyAttributes.includes(attr)?{readonly:!0}:{})}),result})(meta,r));return this.objectCache.setMxObjects(objJsons),{mxobjs:objJsons.map(json=>ensure(this.objectCache.getObject(json.guid))),count:count}}}class _DataBackend{getByGuid(guids,filter){return Promise.reject(new NotImplementedError("getByGuid"))}getByPath(guid,path,entity,direction){return Promise.reject(new NotImplementedError("getByPath"))}getByXPath(xpath,filter,wantCount){return Promise.reject(new NotImplementedError("getByXPath"))}getSlice(entity,constraints,filter,useCache){return Promise.reject(new NotImplementedError("getSlice"))}action(params,context,targetForm,async,onValidation){return Promise.reject(new NotImplementedError("action"))}create(entity){return Promise.reject(new NotImplementedError("create"))}commit(guids,context,targetForm,onValidation){return Promise.reject(new NotImplementedError("commit"))}rollback(guids){return Promise.reject(new NotImplementedError("rollback"))}remove(guids){return Promise.reject(new NotImplementedError("remove"))}validate(guids){return Promise.reject(new NotImplementedError("validate"))}saveDocument(guid,name,params,blob){return Promise.reject(new NotImplementedError("saveDocument"))}generateReport(reportId,offset,limit,params){return Promise.reject(new NotImplementedError("generateReport"))}generateExcelReport(reportId,params){return Promise.reject(new NotImplementedError("generateExcelReport"))}getReportParameters(reportId){return Promise.reject(new NotImplementedError("getReportParameters"))}getDocumentUrl(guid,changedDate,isThumb){throw new NotImplementedError("getDocumentUrl")}getImageUrl(url){return Promise.reject(new NotImplementedError("getImageUrl"))}upload(){return Promise.reject(new NotImplementedError("upload"))}download(fetchConfig){return Promise.reject(new NotImplementedError("download"))}cleanupDirtyObjects(){return Promise.reject(new NotImplementedError("cleanupDirtyObjects"))}isDirty(guid){throw new NotImplementedError("isDirty")}cleanup(){return Promise.reject(new NotImplementedError("cleanup"))}}const DEFAULT_ATTRIBUTE_VALUES={String:null,Integer:"0",Long:"0",Decimal:"0",Enum:null,HashString:null,ObjectReference:null,DateTime:null,Boolean:!1,AutoNumber:"0",Binary:null};class OfflineDataBackend extends _DataBackend{constructor(objectCache,store,fileBackend,synchronizer,getDocumentUrlFn){super(),this._store=store,this._getDocumentUrl=getDocumentUrlFn||getDefaultDocumentUrl,this._objectCache=objectCache,this._fileBackend=fileBackend,this._synchronizer=synchronizer,this._dirtyGuids=[]}async initialize(){const dirtyObjs=await this._store.fetchDirty();this._dirtyGuids=dirtyObjs.map(obj=>obj.guid)}async getByGuid(externalGuids,filter){const mxobjs=(await Promise.all(externalGuids.map(guid=>this._getByGuid(guid)))).filter(obj=>null!=obj).map(obj=>objectToJson(obj));return this._objectCache.setMxObjects(mxobjs),{mxobjs:mxobjs.map(({guid:guid})=>this._objectCache.getObject(guid)),count:mxobjs.length}}async getByPath(guid,path,entity,direction){if("reverse"===direction){const cachedMxObjectsReferencingRoot=this._objectCache.getAllObjects().filter(mxobj=>mxobj.getReferences(path).includes(guid)),{mxobjs:storedRefMxObjs}=await this.getSlice(entity,[{attribute:path,operator:"equals",value:guid}]),uncachedMxObjectsReferencingRoot=storedRefMxObjs.filter(storedMxObject=>storedMxObject.getReferences(path).includes(guid)).filter(storedMxObject=>!cachedMxObjectsReferencingRoot.some(cachedObj=>cachedObj.getGuid()===storedMxObject.getGuid()));this._objectCache.setMxObjects(uncachedMxObjectsReferencingRoot.map(mxobj=>mxobj.jsonData));const resultMxobjs=cachedMxObjectsReferencingRoot.concat(uncachedMxObjectsReferencingRoot);return{mxobjs:resultMxobjs,count:resultMxobjs.length}}{let rootMxObj=this._objectCache.getObject(guid);if(!rootMxObj){const{mxobjs:[storedRootObj]}=await this.getByGuid([guid]);storedRootObj&&(rootMxObj=storedRootObj)}if(!rootMxObj)return{mxobjs:[],count:0};const refGuids=rootMxObj.getReferences(path),cachedRefMxobjs=refGuids.map(refGuid=>this._objectCache.getObject(refGuid)).filter(mxobj=>null!==mxobj),uncachedRefGuids=refGuids.filter(refGuid=>!this._objectCache.has(refGuid)),{mxobjs:storedRefMxobjs}=await this.getByGuid(uncachedRefGuids),refMxobjs=storedRefMxobjs.concat(cachedRefMxobjs);return this._objectCache.setMxObjects(storedRefMxobjs.map(mxobj=>mxobj.jsonData)),{mxobjs:refMxobjs,count:refMxobjs.length}}}async getSlice(entity,constraints,filter,useCache){const meta=window.mx.meta.getEntity(entity),internalConstraints=(constraints||[]).map(constraint=>(constraint.attribute&&meta.isReference(constraint.attribute)&&(constraint.value=this._synchronizer.getInternalGuid(constraint.value)),constraint)),[internalObjs,count]=await this._store.getSlice(entity,internalConstraints,filter),objects=internalObjs.map(this._synchronizer.makeObjectExternal,this._synchronizer).map(objectToJson);let mxobjs=[];return useCache?(this._objectCache.setMxObjects(objects),mxobjs=objects.map(jsonObj=>this._objectCache.getObject(jsonObj.guid))):mxobjs=objects.map(MxObject.fromJson),{mxobjs:mxobjs,count:count}}create(entity){const externalGuid=createUnsyncedGuid();return this._objectCache.onCreate([externalGuid]),this._objectCache.setMxObjects([createNewJson(externalGuid,entity)]),Promise.resolve(this._objectCache.getObject(externalGuid))}async commit(commitGuids,context){const commitChanges=objectFromArray(commitGuids.map(guid=>[guid,this._objectCache.getChanges(guid)])),[cachedCommitGuids,uncachedCommitGuids]=partition(guid=>this._objectCache.has(guid),commitGuids),cachedCommitObjs=cachedCommitGuids.map(guid=>this._objectCache.getObject(guid)),[peObjsFromCache,npeObjsFromCache]=partition(obj=>obj.isPersistable(),cachedCommitObjs),originalCachedCommitObjs=peObjsFromCache.map(mxObjectToObj),persistableCommitObjs=(await Promise.all(uncachedCommitGuids.map(guid=>this._getByGuid(guid)))).concat(originalCachedCommitObjs).map(applyChanges);persistableCommitObjs.length>0&&(await this._store.insertOrReplace(persistableCommitObjs.map(this._synchronizer.makeObjectInternal,this._synchronizer)),this._dirtyGuids.push(...persistableCommitObjs.map(obj=>obj.guid)),this._objectCache.setMxObjects(persistableCommitObjs.map(obj=>objectToJson(obj))));const nonPersistableCommitObjs=npeObjsFromCache.map(mxObjectToObj).map(applyChanges);return this._objectCache.setMxObjects(nonPersistableCommitObjs.map(obj=>objectToJson(obj))),this._objectCache.onCommit(commitGuids),this._objectCache.removeChanges(function(changes){const resets={};return Object.keys(changes).forEach(guid=>{resets[guid]=Object.keys(changes[guid])}),resets}(commitChanges)),{};function applyChanges(obj){return Object.assign({},obj,mapObject(commitChanges[obj.guid],change=>change.value))}}rollback(rollbackGuids){this._objectCache.removeAllChanges(rollbackGuids);const newRollbackGuids=rollbackGuids.filter(guid=>this._objectCache.isNew(guid));return this._objectCache.removeObjects(newRollbackGuids),Promise.resolve({})}validate(validateGuids){return Promise.resolve({})}async saveDocument(documentGuid,name,params,blob){if(blob.size/1048576>params.maxFileSize)throw new DescribedError("File too large");const obj=await this._getByGuid(documentGuid),fileName=getFsFileName(this._synchronizer.getInternalGuid(documentGuid),obj?obj.changedDate:void 0);await this._fileBackend.storeFile(blob,this._fileBackend.toAbsolutePath(DOCUMENT_DIR+"/"+fileName)),this._objectCache.makeChange(documentGuid,"HasContents",!0),await this.commit([documentGuid],null)}getDocumentUrl(externalGuid,changedDate,isThumb){return this._getDocumentUrl(getFsFileName(this._synchronizer.getInternalGuid(externalGuid),changedDate),changedDate,isThumb)}getImageUrl(url){return Promise.resolve(url)}upload(){return this._synchronizer.upload()}async download(fetchConfig){const updates=await this._synchronizer.download(fetchConfig);this._dirtyGuids=[],await publish(...updates)}cleanupDirtyObjects(){return this._store.cleanupDirtyObjects()}isDirty(guid){return this._dirtyGuids.includes(guid)}async cleanup(){await this._store.cleanDatabase(),await this._fileBackend.removeDir(this._fileBackend.toAbsolutePath(DOCUMENT_DIR)),await this._fileBackend.removeDir(this._fileBackend.toAbsolutePath(THUMBNAIL_DIR)),this._dirtyGuids=[]}_getByGuid(externalGuid){return this._store.getByGuid(this._synchronizer.getInternalGuid(externalGuid)).then(internalObj=>this._synchronizer.makeObjectExternal(internalObj))}}function mxObjectToObj(mxobj){return jsonToObject(mxobj.jsonData)}function createNewJson(guid,entity){const json={guid:guid,objectType:entity,attributes:{}},meta=window.mx.meta.getEntity(entity);return meta.getAttributes().forEach(attr=>{json.attributes[attr]={value:DEFAULT_ATTRIBUTE_VALUES[meta.getAttributeType(attr)]}}),json}function getDefaultDocumentUrl(fileName,changedDate,isThumb){var dir=DEFAULT_FILES_DIRECTORY+"/"+(isThumb?"thumbnails":"documents");return`filesystem:${window.mx.appUrl}temporary/${dir}/${fileName}?${Date.now()}`}const LIKE_ESCAPE_CHAR="~",QUOTE_CHAR='"';class SqlSelectBuilder{constructor(other,params){this._select=params&&params.select||other&&other._select||null,this._from=params&&params.from||other&&other._from||null,this._join=params&&params.join||other&&other._join||null,this._constraints=params&&params.constraints||other&&other._constraints||[],this._orderBy=params&&params.orderBy||other&&other._orderBy||[],this._limit=params&&params.limit||other&&other._limit||null,this._offset=params&&params.offset||other&&other._offset||null}from(tableName){return new SqlSelectBuilder(this,{from:tableName})}join(tableName,joinOnColumn,selectedColumns){return new SqlSelectBuilder(this,{join:{tableName:tableName,joinOnColumn:joinOnColumn,selectedColumns:selectedColumns}})}where(constraints){return new SqlSelectBuilder(this,{constraints:this._constraints.concat(constraints)})}order(column,direction){return new SqlSelectBuilder(this,{orderBy:this._orderBy.concat([[column,direction]])})}limit(n){return new SqlSelectBuilder(this,{limit:n})}offset(n){return new SqlSelectBuilder(this,{offset:n})}selectDistinct(what){return Array.isArray(what)&&(what=what.join(", ")),`SELECT DISTINCT ${what} ${this._buildSql()}`}selectCount(alias){return`SELECT COUNT(*) AS ${alias}`+this._buildSql()}select(){let select=`SELECT ${this._from}.*`;return this._join&&this._join.selectedColumns.forEach(col=>{select+=`, ${this._join.tableName}.[${col}] as "${this._join.tableName}.${col}"`}),select+this._buildSql()}_buildSql(){let sql=` FROM ${this._from} AS ${this._from}`;return this._join&&(sql+=` JOIN ${this._join.tableName} AS ${this._join.tableName} USING (${this._join.joinOnColumn})`),this._constraints.length>0&&(sql+=" WHERE "+this._constraints.map(constraint=>constraint.build(this._from)).join(" AND ")),this._orderBy.length>0&&(sql+=" ORDER BY "+this._orderBy.map(sortItem=>`${this._from}.[${sortItem[0]}] ${sortItem[1]}`).join(", ")),this._limit&&(sql+=" LIMIT "+this._limit),this._offset&&(sql+=" OFFSET "+this._offset),sql}}const OPERATOR_FN_MAP={equals:columnSimpleCompare("="),lessThan:columnSimpleCompare("<"),lessThanOrEquals:columnSimpleCompare("<="),greaterThan:columnSimpleCompare(">"),greaterThanOrEquals:columnSimpleCompare(">="),contains:function(column){let constraint="";return constraint+=column,constraint+=" LIKE '%' || ? || '%'",constraint+=" ESCAPE '"+LIKE_ESCAPE_CHAR+"'"}};class OperatorConstraint{constructor(column,operator,negate){this._column=column,this._operator=operator,this._negate=!!negate}build(from){const constraintFn=OPERATOR_FN_MAP[this._operator],column=this._column.indexOf(".")>-1?this._column:`${from}.[${this._column}]`;return(this._negate?"NOT ":"")+constraintFn(column)}}class NullConstraint{constructor(column,negate){this._column=column,this._negate=!!negate}build(from){return(this._column.indexOf(".")>-1?this._column:`${from}.[${this._column}]`)+" IS "+(this._negate?"NOT ":"")+"NULL"}}class GroupConstraint{constructor(group,constraints){this.group=group,this.constraints=constraints||[]}add(constraint){this.constraints.push(constraint)}build(from){return"("+this.constraints.map(c=>c.build(from)).join(` ${this.group} `)+")"}}const constraintBuilder={and:constraints=>new GroupConstraint("and",constraints),or:constraints=>new GroupConstraint("or",constraints),equals:(column,negate)=>new OperatorConstraint(column,"equals",negate),isNull:(column,negate)=>new NullConstraint(column,negate),lessThan:(column,negate)=>new OperatorConstraint(column,"lessThan",negate),lessThanOrEquals:(column,negate)=>new OperatorConstraint(column,"lessThanOrEquals",negate),greaterThan:(column,negate)=>new OperatorConstraint(column,"greaterThan",negate),greaterThanOrEquals:(column,negate)=>new OperatorConstraint(column,"greaterThanOrEquals",negate),contains:(column,negate)=>new OperatorConstraint(column,"contains",negate)};function columnSimpleCompare(operator){return function(column){return column+" "+operator+" ?"}}function SqlCreateBuilder(other,params){this._tableName=params&&params.tableName||other&&other._tableName||null,this._columns=params&&params.columns||other&&other._columns||[]}function quoteIdentifier(identifier){return QUOTE_CHAR+identifier+QUOTE_CHAR}function SqlInsertBuilder(other,params){if(!(this instanceof SqlInsertBuilder))return new SqlInsertBuilder;this._tableName=params&&params.tableName||other&&other._tableName||null,this._columnNames=params&&params.columnNames||other&&other._columnNames||[]}function quoteIdentifier$1(identifier){return QUOTE_CHAR+identifier+QUOTE_CHAR}function Task(f){this.fork=f}SqlCreateBuilder.prototype.table=function(tableName){return new SqlCreateBuilder(this,{tableName:tableName})},SqlCreateBuilder.prototype.column=function(columnName,columnType){return new SqlCreateBuilder(this,{columns:this._columns.concat({columnName:columnName,columnType:columnType,isPrimary:!1})})},SqlCreateBuilder.prototype.primaryKeyColumn=function(primaryKeyName,primaryKeyType){return new SqlCreateBuilder(this,{columns:this._columns.concat({columnName:primaryKeyName,columnType:primaryKeyType,isPrimary:!0})})},SqlCreateBuilder.prototype.createIfNotExists=function(){var sqlStr="";return sqlStr+="CREATE TABLE IF NOT EXISTS "+quoteIdentifier(this._tableName),sqlStr+=this._buildSql()},SqlCreateBuilder.prototype._buildSql=function(){var sqlStr="";return this._columns.length>0&&(sqlStr+=" (",sqlStr+=this._columns.map(function(columnDescription){return[quoteIdentifier(columnDescription.columnName),columnDescription.columnType,"text"===columnDescription.columnType?" COLLATE NOCASE ":"",columnDescription.isPrimary?"PRIMARY KEY ":""].join(" ").slice(0,-1)},this).join(", "),sqlStr+=")"),sqlStr},SqlInsertBuilder.prototype.into=function(tableName){return new SqlInsertBuilder(this,{tableName:tableName})},SqlInsertBuilder.prototype.column=function(columnName){return new SqlInsertBuilder(this,{columnNames:this._columnNames.concat(columnName)})},SqlInsertBuilder.prototype.insert=function(){var sqlStr="";return sqlStr+="INSERT INTO "+quoteIdentifier$1(this._tableName),sqlStr+=this._buildSql()},SqlInsertBuilder.prototype.insertOrReplace=function(){var sqlStr="";return sqlStr+="INSERT OR REPLACE INTO "+quoteIdentifier$1(this._tableName),sqlStr+=this._buildSql()},SqlInsertBuilder.prototype._buildSql=function(){var sqlStr="";return this._columnNames.length>0&&(sqlStr+=" (",sqlStr+=this._columnNames.map(quoteIdentifier$1).join(", "),sqlStr+=")"),sqlStr+=" VALUES (",sqlStr+="?"+new Array(this._columnNames.length).join(", ?"),sqlStr+=")"},Task.of=function(x){return new Task(function(reject,resolve){resolve(x)})},Task.prototype.chain=function(f){var self=this;return new Task(function(reject,resolve){self.fork(reject,function(x){f(x).fork(reject,resolve)})})},Task.prototype.orElse=function(f){var self=this;return new Task(function(reject,resolve){self.fork(function(e){f(e).fork(reject,resolve)},resolve)})},Task.prototype.ap=function(a){var func,value,error,self=this,counter=2;return new Task(function(reject,resolve){function resolveSuccess(){0==--counter&&resolve(func(value))}function resolveError(e){void 0===error&&reject(error=e)}self.fork(resolveError,function(f){func=f,resolveSuccess()}),a.fork(resolveError,function(x){value=x,resolveSuccess()})})},Task.prototype.map=function(f){return this.chain(function(x){return Task.of(f(x))})},Task.rejected=Task.prototype.rejected=function(e){return new Task(function(reject,resolve){reject(e)})},Task.parallel=function(tasks){return new Task(function(reject,resolve){var error,counter=tasks.length,results=new Array(tasks.length);0!==tasks.length?tasks.forEach(function(task,i){task.fork(function(e){void 0===error&&(error=e,reject(e))},function(i){return function(x){results[i]=x,void 0===error&&0==--counter&&resolve(results)}}(i))}):resolve(results)})},Task.sequence=function(tasks){return tasks.reduce(function(acc,task){return acc.chain(function(_){return task})},Task.of(null))};const TaskReader=new function(M){function ReaderX(f){this.run=f}return ReaderX.prototype.chain=function(f){return new ReaderX(function(r){return this.run(r).chain(function(a){return f(a).run(r)})}.bind(this))},ReaderX.prototype.ap=function(ma){return new ReaderX(function(r){return this.run(r).ap(ma.run(r))}.bind(this))},ReaderX.prototype.map=function(f){return this.chain(function(x){return ReaderX.of(f(x))})},ReaderX.of=function(x){return new ReaderX(function(_){return M.of(x)})},ReaderX.ask=function(){return new ReaderX(M.of)},ReaderX}(Task);TaskReader.rejected=function(e){return new TaskReader(function(_){return Task.rejected(e)})},TaskReader.parallel=function(taskReaders){return new TaskReader(tx=>new Task((reject,resolve)=>{if(0===taskReaders.length)return void resolve([]);const results=new Array(taskReaders.length);let counter=taskReaders.length,rejected=!1;taskReaders.forEach((taskReader,i)=>{taskReader.run(tx).fork(e=>{rejected||(rejected=!0,reject(e))},result=>{results[i]=result,rejected||0!=--counter||resolve(results)})})}))},TaskReader.sequence=function(taskReaders){return taskReaders.reduce((accReader,taskReader)=>accReader.chain(acc=>taskReader.map(x=>acc.concat([x]))),TaskReader.of([]))};const METADATA_TABLE$1="_guidToTable",ATTRIBUTE_TO_SQL_TYPE={String:"text",Integer:"text",Long:"text",Decimal:"text",Enum:"text",HashString:"text",ObjectReference:"text",DateTime:"integer",Boolean:"integer",AutoNumber:"integer",Binary:"blob"},RUNTIME_TO_SQL_CONVERTER={String:convertString,Integer:convertNumber,Long:convertNumber,Decimal:convertNumber,Enum:convertString,HashString:convertString,ObjectReference:convertString,DateTime:function(x){return null!=x?Number(x):null},Boolean:Number,AutoNumber:convertString,Binary:convertString},SQL_TO_RUNTIME_CONVERTER={String:convertString,Integer:convertString,Long:convertString,Decimal:convertString,Enum:convertString,HashString:convertString,ObjectReference:convertString,DateTime:identity,Boolean:Boolean,AutoNumber:convertString,Binary:convertString},MODELER_TO_RUNTIME_CONVERTER={String:identity,Integer:identity,Long:identity,Decimal:identity,Enum:identity,HashString:identity,ObjectReference:identity,DateTime:function(s){return s?Number(s):null},Boolean:function(s){return"false"!==s},AutoNumber:identity,Binary:identity};function createFetchSliceTransaction(entity,constraints,offset,limit,sort){constraints=constraints||[],sort=sort||[];const meta=window.mx.meta.getEntity(entity),result=function(meta,constraintList){const args=[];return{builder:(new SqlSelectBuilder).where(constraintList.map(function processConstraint(constraint){if(constraint.constraints)return constraintBuilder[constraint.operator](constraint.constraints.map(processConstraint).filter(c=>null!==c));if(null==constraint.value)switch(constraint.operator){case"contains":return null;case"equals":return constraintBuilder.isNull(toSafeKey$1(constraint.attribute),constraint.negate)}const attrType=meta.getAttributeType(constraint.attribute);const parseFn=MODELER_TO_RUNTIME_CONVERTER[attrType];const conversionFn=RUNTIME_TO_SQL_CONVERTER[attrType];const queryValue=conversionFn(parseFn(constraint.value));args.push("contains"===constraint.operator?(s=queryValue,escapeChar=LIKE_ESCAPE_CHAR,s.replace(new RegExp(escapeChar,"g"),escapeChar+escapeChar).replace(/%/g,escapeChar+"%").replace(/_/g,escapeChar+"_")):queryValue);var s,escapeChar;return constraintBuilder[constraint.operator](toSafeKey$1(constraint.attribute),constraint.negate)}).filter(c=>null!==c)),args:args}}(meta,constraints),countBuilder=result.builder.from(toSafeKey$1(entity)),constraintValues=result.args;let objectsBuilder=countBuilder.offset(offset).limit(limit).join(METADATA_TABLE$1,"guid",["dirty","readonlyAttrs"]);var objectsTransaction=createTransaction((objectsBuilder=sort.reduce(function(acc,sortItem){return acc.order(sortItem[0],sortItem[1])},objectsBuilder)).select(),constraintValues).map(function(res){const objs=[];for(let i=0;i<res.rows.length;++i){const row=res.rows.item(i),isDirty=Boolean(row[`${METADATA_TABLE$1}.dirty`]),readonlyAttrs=getMetadata(row,"readonlyAttrs");objs.push(rowToObject(meta,isDirty,readonlyAttrs,row))}return objs}),countTransaction=createTransaction(countBuilder.selectCount("cnt"),constraintValues).map(function(res){return res.rows.item(0).cnt});return TaskReader.parallel([objectsTransaction,countTransaction])}function createRebuildTransaction(tableNames,objs){const resetTransaction=function(tableNames){var dropTransactions=[METADATA_TABLE$1].concat(tableNames).map(toSafeKey$1).map(function(safeTableName){return"DROP TABLE IF EXISTS '"+safeTableName+"'"}).map(function(sqlText){return createTransaction(sqlText,[])});return TaskReader.sequence([TaskReader.parallel(dropTransactions),createCreateTransaction(tableNames)])}(tableNames),fillTransactions=tableNames.map(tableName=>{const objsOfType=objs.filter(obj=>obj.$objectType===tableName);return function(storeName,objs){var transactions=objs.reduce(function(acc,obj){var insertIntoGuidTableBuilder=getInsertIntoGuidTableBuilder(),insertParameters=getInsertParameters(storeName,obj);return acc.concat([createTransaction(insertIntoGuidTableBuilder.insert(),[obj.guid,storeName,0,JSON.stringify(obj.$readonlyAttrs)]),createTransaction(insertParameters.builder.insert(),insertParameters.values)])},[]);return TaskReader.parallel(transactions).map(_=>void 0)}(tableName,objsOfType)});return TaskReader.sequence([resetTransaction,TaskReader.parallel(fillTransactions)]).map(_=>void 0)}function createCreateTransaction(tableNames){var sql,createTransactions=[(sql=(new SqlCreateBuilder).table(METADATA_TABLE$1).primaryKeyColumn("guid","text").column("tableName","text").column("dirty","boolean").column("readonlyAttrs","text").createIfNotExists(),createTransaction(sql,[]))].concat(tableNames.map(function(entityName){return createTransaction(function(entityName){var meta=window.mx.meta.getEntity(entityName);return meta.getAttributes().map(function(attr){var attributeType=meta.getAttributeType(attr);return{attr:attr,type:ATTRIBUTE_TO_SQL_TYPE[attributeType]}})}(entityName).reduce(function(acc,columnDescription){return acc.column(toSafeKey$1(columnDescription.attr),columnDescription.type)},(new SqlCreateBuilder).table(toSafeKey$1(entityName)).primaryKeyColumn("guid","text")).createIfNotExists(),[])}));return TaskReader.parallel(createTransactions).map(_=>void 0)}function createFetchDirtyTablesTransaction(){return createTransaction((new SqlSelectBuilder).from(METADATA_TABLE$1).where(constraintBuilder.equals("dirty")).selectDistinct("tableName"),[1])}function getInsertIntoGuidTableBuilder(){return(new SqlInsertBuilder).into(METADATA_TABLE$1).column("guid").column("tableName").column("dirty").column("readonlyAttrs")}function getInsertParameters(storeName,obj){var meta=window.mx.meta.getEntity(storeName),insertObjectDescription=meta.getAttributes().reduce(function(acc,attribute){var attrType=meta.getAttributeType(attribute),conversionFn=RUNTIME_TO_SQL_CONVERTER[attrType];if(!conversionFn)return acc;var value=conversionFn(obj[attribute]);return{attrs:acc.attrs.concat([attribute]),values:acc.values.concat([value])}},{attrs:["guid"],values:[obj.guid]});return{builder:insertObjectDescription.attrs.reduce(function(acc,attr){return acc.column(toSafeKey$1(attr))},(new SqlInsertBuilder).into(toSafeKey$1(storeName))),values:insertObjectDescription.values}}function convertNumber(x){if(null==x)return null;var bigNumber=new Big$1(x),nrOfZeroes=20-Math.max(0,bigNumber.e)-1;return(bigNumber.s<0?"-":"")+new Array(nrOfZeroes+1).join("0")+bigNumber.abs().toFixed()}function convertString(x){return null!=x?String(x):null}function identity(x){return x}function rowsToArray(rows){for(var arr=[],i=0;i<rows.length;++i)arr.push(rows.item(i));return arr}function toSafeKey$1(key){return key.replace(".","$")}function fromSafeKey$1(safeKey){return safeKey.replace("$",".")}function rowToObject(meta,dirty,readonlyAttrs,row){const result={guid:row.guid,$objectType:meta.getEntity(),$dirty:dirty,$readonlyAttrs:JSON.parse(readonlyAttrs)};for(const safeKey in row){if("guid"===(keyName=safeKey)||keyName.indexOf(".")>-1)continue;const attr=fromSafeKey$1(safeKey),attrType=meta.getAttributeType(attr),toObjectFn=SQL_TO_RUNTIME_CONVERTER[attrType];toObjectFn&&(result[attr]=toObjectFn(row[safeKey]))}var keyName;return result}function getMetadata(row,field){return row[`${METADATA_TABLE$1}.${field}`]}function createTransaction(sql,args){return args=args||[],new TaskReader(function(tx){return new Task(function(reject,resolve){tx.executeSql(sql,args,(_,res)=>resolve(res),(_,e)=>reject(e))})})}const runReadTransaction=createRunner("readTransaction"),runWriteTransaction=createRunner("transaction");function createRunner(name){return function(db,transaction){return new Task(function(reject,resolve){var result,counter=2;db[name](function(tx){transaction.run(tx).fork(reject,function(r){result=r,0==--counter&&resolve(result)})},reject,function(){0==--counter&&resolve(result)})})}}function promiseFromTask(t){return new Promise(function(resolve,reject){t.fork(reject,resolve)})}class SqlStore{constructor(schema,database){this._tableNames=schema;const initTransaction=createCreateTransaction(this._tableNames);this._databasePromise=promiseFromTask(runWriteTransaction(database,initTransaction)).then(()=>database)}async getByGuid(guid){const db=await this._databasePromise,transaction=function(guid){return createTransaction((new SqlSelectBuilder).from(METADATA_TABLE$1).where(constraintBuilder.equals("guid")).select(),[guid]).chain(function(metaRes){if(0===metaRes.rows.length)return TaskReader.of(null);if(1!==metaRes.rows.length)return TaskReader.rejected(new Error("db consistency error"));const row=metaRes.rows.item(0),entity=row.tableName,isDirty=Boolean(row.dirty),readonlyAttrs=row.readonlyAttrs;return createTransaction((new SqlSelectBuilder).from(toSafeKey$1(entity)).where(constraintBuilder.equals("guid")).select(),[guid]).chain(function(res){return 0===res.rows.length?TaskReader.rejected(new Error("entity not found")):1!==res.rows.length?TaskReader.rejected(new Error("db consistency error")):TaskReader.of(rowToObject(window.mx.meta.getEntity(entity),isDirty,readonlyAttrs,res.rows.item(0)))})})}(guid);return promiseFromTask(runReadTransaction(db,transaction))}async getSlice(entity,constraints,filter={}){const db=await this._databasePromise,transaction=createFetchSliceTransaction(entity,constraints,filter.offset,filter.limit,filter.sort);return promiseFromTask(runReadTransaction(db,transaction))}async rebuildDatabase(objs){const db=await this._databasePromise,transaction=createRebuildTransaction(this._tableNames,objs);return promiseFromTask(runWriteTransaction(db,transaction))}async insertOrReplace(objs){const db=await this._databasePromise,transaction=function(objs){return TaskReader.parallel(objs.map(obj=>{const storeName=obj.$objectType,insertIntoGuidTableBuilder=getInsertIntoGuidTableBuilder(),insertParameters=getInsertParameters(storeName,obj);return[createTransaction(insertIntoGuidTableBuilder.insertOrReplace(),[obj.guid,storeName,1,JSON.stringify(obj.$readonlyAttrs)]),createTransaction(insertParameters.builder.insertOrReplace(),insertParameters.values)]}).reduce((a,b)=>a.concat(b),[])).map(_=>void 0)}(objs);return promiseFromTask(runWriteTransaction(db,transaction))}async cleanDatabase(){const db=await this._databasePromise,transaction=(tableNames=this._tableNames,deleteTransactions=[METADATA_TABLE$1].concat(tableNames).map(toSafeKey$1).map(safeTableName=>`DELETE FROM '${safeTableName}'`).map(sqlText=>createTransaction(sqlText,[])),TaskReader.parallel(deleteTransactions).map(_=>void 0));var tableNames,deleteTransactions;return promiseFromTask(runWriteTransaction(db,transaction))}async fetchDirty(){const db=await this._databasePromise,transaction=createFetchDirtyTablesTransaction().chain(function(resTables){const transactions=rowsToArray(resTables.rows).map(({tableName:tableName})=>{const sql=(new SqlSelectBuilder).from(toSafeKey$1(tableName)).join(METADATA_TABLE$1,"guid",["dirty","readonlyAttrs"]).where(constraintBuilder.equals(`${METADATA_TABLE$1}.dirty`)).select(),meta=window.mx.meta.getEntity(tableName);return createTransaction(sql,[1]).map(resRows=>rowsToArray(resRows.rows).map(row=>rowToObject(meta,!0,getMetadata(row,"readonlyAttrs"),row)))});return TaskReader.parallel(transactions)}).map(arrs=>arrs.reduce((a,b)=>a.concat(b),[]));return promiseFromTask(runReadTransaction(db,transaction))}async makeClean(objs){const db=await this._databasePromise,transaction=function(objs){var transactions=objs.map(obj=>createTransaction(`UPDATE ${METADATA_TABLE$1} set dirty = 0 where guid = ?`,[obj.guid]));return TaskReader.parallel(transactions).map(_=>void 0)}(objs);return promiseFromTask(runWriteTransaction(db,transaction))}async cleanupDirtyObjects(){const db=await this._databasePromise,transaction=createFetchDirtyTablesTransaction().chain(function(res){var deleteTransactions=rowsToArray(res.rows).map(function(row){var entity=row.tableName;return createTransaction(`DELETE FROM ${toSafeKey$1(entity)} WHERE guid IN (\n                            SELECT guid FROM ${METADATA_TABLE$1} WHERE tableName = ? AND dirty = 1)`,[entity])});return TaskReader.sequence([TaskReader.parallel(deleteTransactions),createTransaction(`DELETE FROM ${METADATA_TABLE$1} WHERE dirty = 1`)]).map(_=>void 0)});return promiseFromTask(runWriteTransaction(db,transaction))}}class SynchronizationError extends Error{constructor(message="Could temporarily not synchronize data. Please try again later."){super(message),Object.setPrototypeOf(this,SynchronizationError.prototype)}}class Synchronizer{constructor(store,fileBackend,objectCache){this._store=store,this._fileBackend=fileBackend,this._objectCache=objectCache,this._internalToExternal={}}async upload(){try{await this._upload()}catch(e){throw window.mx.logger.warn(e),e instanceof DanglingError?e:new SynchronizationError}}async download(fetchConfig){try{return await this._download(fetchConfig)}catch(e){throw window.mx.logger.warn(e),new SynchronizationError}}async _upload(){const dirtyObjs=await this._store.fetchDirty();if(0===dirtyObjs.length)return{};!function(syncInternalObjs){const internalGuidsToSync=syncInternalObjs.map(obj=>obj.guid),danglingGuids=unique$1(syncInternalObjs.map(obj=>collectGuidAttrs(obj).map(([attr,guid])=>guid)).reduce((a,b)=>a.concat(b),[])).filter(guid=>!wasGuidSynced(guid)).filter(guid=>!internalGuidsToSync.includes(guid));if(danglingGuids.length>0){const danglingGuidsInfo=unique$1(syncInternalObjs.map(obj=>collectGuidAttrs(obj).filter(([_,guid])=>danglingGuids.includes(guid)).map(([attr,_])=>`object of type ${obj.$objectType} (reference ${attr})`)).reduce((a,b)=>a.concat(b),[])).join(", "),errorText=`Sync has failed due to a modeling error. Your database contains objects that reference uncommitted objects:\n${danglingGuidsInfo}.`;throw new DanglingError(errorText)}}(dirtyObjs);const[modifiedObjs,createdObjs]=partition(internalObj=>wasGuidSynced(internalObj.guid),dirtyObjs),dirtyFileObjs=dirtyObjs.filter(function(obj){return window.mx.meta.getEntity(obj.$objectType).isA("System.FileDocument")&&obj.HasContents}),[tempUploadPairs,instantiatedPairs]=await Promise.all([Promise.all(dirtyFileObjs.map(fileObj=>this._tempUploadFile(fileObj))),Promise.all(createdObjs.map(function(obj){return async function(entity,changes,objects){return post(xasUrl(),{action:"instantiate",params:{objecttype:entity},changes:changes,objects:objects})}(obj.$objectType).then(json=>{const remote=json.objects.find(objJson=>objJson.guid===json.actionResult);return{internalObj:obj,remoteJson:remote}})}))]),internalToRemoteGuidMap=objectFromArray(instantiatedPairs.map(({internalObj:internalObj,remoteJson:remoteJson})=>[internalObj.guid,remoteJson.guid])),tempFileToFileGuidMap=objectFromArray(tempUploadPairs.map(({tempGuid:tempGuid,fileObjGuid:fileObjGuid})=>wasGuidSynced(fileObjGuid)?[tempGuid,fileObjGuid]:[tempGuid,internalToRemoteGuidMap[fileObjGuid]])),guidsToSend=modifiedObjs.map(obj=>obj.guid).concat(instantiatedPairs.map(({remoteJson:remoteJson})=>remoteJson.guid)),jsonToSend=instantiatedPairs.map(({remoteJson:remoteJson})=>remoteJson),changesToSend=objectFromArray(dirtyObjs.map(obj=>(function(internalObj,guidMap){const meta=window.mx.meta.getEntity(internalObj.$objectType),changesEntries=Object.keys(internalObj).filter(function(attr){return!isSpecialAttributeName(attr)&&meta.isSyncable(attr)&&!isReadonlyAttr(internalObj,attr)}).map(attr=>{const internalValue=internalObj[attr],remoteValue=meta.isObjectReference(attr)&&null!=internalValue&&!wasGuidSynced(internalValue)?guidMap[internalValue]:internalValue;return[attr,{value:remoteValue}]});return[wasGuidSynced(internalObj.guid)?internalObj.guid:guidMap[internalObj.guid],objectFromArray(changesEntries)]})(obj,internalToRemoteGuidMap))),syncResponse=await async function(guids,fileGuidMapping,changes,objects){return post(xasUrl(),{action:"synchronize",params:{guids:guids,fileGuidMapping:fileGuidMapping},changes:changes,objects:objects})}(guidsToSend,tempFileToFileGuidMap,changesToSend,jsonToSend);return await this._store.makeClean(dirtyObjs),await Promise.all(dirtyFileObjs.map(async obj=>{const newGuid=internalToRemoteGuidMap[obj.guid]||obj.guid,newChangedDate=syncResponse.fileChangedDates[newGuid],documentsPath=this._fileBackend.toAbsolutePath(DOCUMENT_DIR+"/"),currentPath=documentsPath+getFsFileName(obj.guid,obj.changedDate),stablePath=documentsPath+getFsFileName(newGuid,newChangedDate);await this._fileBackend.moveFile(currentPath,stablePath)})),arrayFromObject(internalToRemoteGuidMap).forEach(([internalGuid,remoteGuid])=>this._mapInternalGuid(internalGuid,remoteGuid)),{};function collectGuidAttrs(obj){const meta=window.mx.meta.getEntity(obj.$objectType);return arrayFromObject(obj).filter(([attr,_])=>"guid"===attr||!isSpecialAttributeName(attr)&&meta.isReference(attr))}}async _download(fetchConfig){const fetchedObjs=flatten(await Promise.all(fetchConfig.map(({store:store,xpath:xpath})=>(async function(objectCache,expectedObjectType,xpath){const json=await async function(xpath,schema={},wantCount=!1){return post(xasUrl(),{action:"retrieve_by_xpath",params:{xpath:xpath,schema:schema,count:wantCount}})}(xpath);return json.resultGuids.map(guid=>json.objects.find(obj=>obj.guid===guid)).map(jsonToObject).map(obj=>Object.assign({},obj,{$objectType:expectedObjectType}))})(this._objectCache,store,xpath)))),[downloadFileInstructions,filesToRemove]=await this._computeFilesToDownloadAndDelete(fetchedObjs,!1),[downloadThumbInstructions,thumbsToRemove]=await this._computeFilesToDownloadAndDelete(fetchedObjs,!0);await Promise.all(downloadFileInstructions.concat(downloadThumbInstructions).map(({source:source,destination:destination})=>this._fileBackend.downloadFile(source,destination))),await this._store.rebuildDatabase(fetchedObjs),Promise.all(filesToRemove.concat(thumbsToRemove).map(file=>this._fileBackend.removeFile(file))).catch(window.mx.onError);const externalFetchedObjs=fetchedObjs.map(this.makeObjectExternal,this),cachedWithFetchedObjs=this._objectCache.getAllObjects().filter(mxobj=>mxobj.isPersistable()&&!this._objectCache.isNew(mxobj.getGuid())).map(mxobj=>[externalFetchedObjs.find(obj=>obj.guid===mxobj.getGuid()),mxobj]),[updates,deletes]=partition(([obj])=>void 0!==obj,cachedWithFetchedObjs);return this._objectCache.setMxObjects(updates.map(([obj])=>objectToJson(obj))),this._objectCache.onDelete(deletes.map(([_,mxobj])=>mxobj.getGuid())),[...fetchConfig.map(({store:store})=>({entity:store})),...updates.map(([{guid:guid}])=>({guid:guid})),...deletes.map(([_,mxobj])=>({guid:mxobj.getGuid()}))]}getExternalGuid(internalGuid){return this._internalToExternal[internalGuid]||internalGuid}getInternalGuid(externalGuid){for(const ig in this._internalToExternal)if(this._internalToExternal[ig]===externalGuid)return ig;return externalGuid}makeObjectExternal(internalObj){return remapGuidsInObject(internalObj,this.getExternalGuid.bind(this))}makeObjectInternal(externalObj){return remapGuidsInObject(externalObj,this.getInternalGuid.bind(this))}_mapInternalGuid(oldInternalGuid,newInternalGuid){this._internalToExternal[newInternalGuid]=oldInternalGuid}async _tempUploadFile(fileObj){const filePath=DOCUMENT_DIR+"/"+getFsFileName(fileObj.guid,fileObj.changedDate),blob=await this._fileBackend.readFile(this._fileBackend.toAbsolutePath(filePath));return{tempGuid:(await async function(fileObjGuid,fileName,blob,numberOfRetries){for(let i=0;i<=numberOfRetries;i++)try{return await upload(fileObjGuid,fileName,{},blob,{},[])}catch(e){if(!(i<numberOfRetries))throw e;{const timeout=Math.pow(2,i);await wait(timeout)}}throw new AssertionError}("__sync__","",blob,2)).commits[0],fileObjGuid:fileObj.guid}}async _computeFilesToDownloadAndDelete(internalObjs,isThumb){const root=this._fileBackend.toAbsolutePath(isThumb?THUMBNAIL_DIR:DOCUMENT_DIR)+"/",objsToHaveFiles=internalObjs.filter(obj=>window.mx.meta.getEntity(obj.$objectType).isA(isThumb?"System.Image":"System.FileDocument")).filter(obj=>obj.HasContents).map(obj=>({source:getRemoteDynamicResourceUrl(obj.guid,obj.changedDate,isThumb),destination:root+getFsFileName(obj.guid,obj.changedDate)})),existingFiles=(await this._fileBackend.listDir(root)).map(name=>root+name);return[objsToHaveFiles.filter(x=>!existingFiles.includes(x.destination)),existingFiles.filter(path=>!objsToHaveFiles.find(x=>x.destination===path))]}}function remapGuidsInObject(obj,remapFn){if(null===obj)return null;const meta=window.mx.meta.getEntity(obj.$objectType);return mapObject(obj,(val,attr)=>{return("guid"===attr||!isSpecialAttributeName(attr)&&meta.isReference(attr))&&null!=val?remapFn(val):val})}class Parser{formatValue(value,type,config){if(""===value||null===value)return"";switch(type.toLowerCase()){case"decimal":case"integer":case"long":{if("string"==typeof value||"number"==typeof value)try{value=new Big$1(value)}catch(e){throw new Error(`Value '${value}' cannot be formatted as a numeric value.`)}if(!(value instanceof Big$1))throw new Error(`Value '${value}' cannot be formatted as a numeric value.`);const numberConfig=toNumberFormatterConfig(config),groupDigits=numberConfig&&numberConfig.groupDigits,configuredDecimals=numberConfig&&numberConfig.decimalPrecision,defaultDecimals="decimal"===type.toLowerCase()?void 0:0;return formatNumber(value,groupDigits,void 0!==configuredDecimals?configuredDecimals:defaultDecimals)}case"datetime":{if(!("number"==typeof value||value instanceof Date))throw new Error(`Value '${value}' cannot be formatted as Date.`);const dateTimeConfig=toDateTimeFormatterConfig(config);return formatDate(new Date(value),dateTimeConfig)}case"boolean":if("boolean"!=typeof value)throw new Error(`Value '${value}' cannot be formatted as boolean.`);return translate("mxui.common",value.toString());default:return String(value)}}formatAttribute(object,attribute,config){const type=object.getAttributeType(attribute);let value=object.get(attribute);if("Enum"===type){const caption=object.getEnumCaption(attribute,value);caption&&(value=caption)}return this.formatValue(value,type,config)}parseValue(value,type,config){if(""===value)return"";switch(type.toLowerCase()){case"integer":case"long":case"decimal":{const numberConfig=toNumberFormatterConfig(config),configuredDecimals=numberConfig&&numberConfig.decimalPrecision;return parseNumber(value,configuredDecimals)||null}case"datetime":{const dateTimeConfig=toDateTimeFormatterConfig(config);return parseDate(value,dateTimeConfig)||null}case"enum":return value;case"boolean":return value===translate("mxui.common","true");default:return value}}}function toNumberFormatterConfig(config){if(config)return"places"in config?{decimalPrecision:config.places,groupDigits:Boolean(config.groups)}:config}function toDateTimeFormatterConfig(config){return config?"datePattern"in config&&config.datePattern?{type:"custom",pattern:config.datePattern}:"selector"in config?{type:config.selector}:config:{type:"date"}}const DocumentDirectoryPath=NativeModules.NativeFsModule.DocumentDirectoryPath;async function startupNativeClient(remoteUrl,cacheBust,resourcesMap,legacyProfile){const cache=new MxObjectCache,session=new Session(new AsyncStore("session"),new AsyncStore("token"),{currentCacheBust:cacheBust,shouldGenerateToken:!0}),meta=new Meta,data=new Data({garbageCollectionInterval:1e4,logCleanupStatistics:!1},cache),logger=new Logger;window.mx={appUrl:"resources://",data:data,homeUrl:"not-supported",isOffline:()=>!0,logger:logger,login:login$1,logout:logout$1,meta:meta,onError:e=>NativeModules.NativeErrorHandler.handle(e.message,parse(e.stack)),reload:()=>NativeModules.NativeReloadHandler.reload(),remoteUrl:remoteUrl,session:session,ui:new NativeUI,version:"{{mendix-version}}"},window.mx.data.update=function(args){publish(args).then(args.callback,window.mx.onError)},window.mx.ui.openForm=function(path,args,scope){const pageObjectGuid=args.context&&args.context.getTrackId()||void 0,params=Object.assign({location:"content"},args,{context:void 0,contextParams:args.context?args.context.getParams():{}},args.domNode?{location:"node"}:void 0),callback=args.callback?args.callback.bind(scope):void 0,error=args.error?args.error.bind(scope):window.mx.onError;window.mx.ui.openForm2(path,pageObjectGuid,args.title,window.mx.ui.getContentForm(),params).then(callback,error)},window.mx.server={getCacheBust:()=>window.mx.session.getConfig("cachebust")},window.mx.session.getUserName=function(){return this.getUserObject().get("Name")},FormBase.prototype.commit=function(callback,error){const self=this;function handleError(e){self.setSuspend(!1),error?error(e):window.mx.onError(e)}this.setSuspend(!0),this.publish("submit",function(){self.publish("commit",function(){window.mx.data.commit({mxobjs:self.getSubmitObjects(),callback(){self.setSuspend(!1),callback&&callback()},error:handleError})},handleError)},handleError)},FormBase.prototype.rollback=function(callback,error){const self=this;function handleError(e){self.setSuspend(!1),error?error(e):window.mx.onError(e)}this.setSuspend(!0),this.publish("rollback",function(){window.mx.data.rollback({mxobjs:self.getSubmitObjects(),callback(){self.setSuspend(!1),callback&&callback()},error:handleError})},handleError)},FormBase.prototype.validate=function(callback,error){this.publish("validate",callback,error)},window.mx.parser=new Parser,function(resourcesMap){registerMiddleware((request,next)=>{if(!request.url.startsWith(window.mx.appUrl))return next(request);let resource;if((resource=-1===request.url.indexOf("?")?request.url.substring(window.mx.appUrl.length):request.url.substring(window.mx.appUrl.length,request.url.indexOf("?")))in resourcesMap){const resourceValue=resourcesMap[resource]();return Promise.resolve(new Response(JSON.stringify(resourceValue),{status:200,statusText:"OK"}))}return Promise.reject(new Error(`Failed to locate resource ${resource}`))})}(resourcesMap);const shouldSync=await session.startup({hybrid:!0,offline:!0,profile:legacyProfile?"HybridPhoneOffline":"NativePhone",timezoneoffset:(new Date).getTimezoneOffset()});if(session.getConfig("isDevModeEnabled")){const devTools=new DevTools(remoteUrl);devTools.connect(),devTools.addOnReload(reloadWithState),logger.addHandler((level,...args)=>{devTools.log(level,...args)}),new NativeEventEmitter(NativeModules.NativeReloadHandler).addListener("reloadWithState",reloadWithState)}startupLocalization(session.getConfig("locale"),session.getConfig("uiconfig.roundingmode")),meta.startup();const rootDirectory=NativeModules.MxConfiguration.FILES_DIRECTORY_NAME,database=openDatabase(NativeModules.MxConfiguration.DATABASE_NAME,"1","Mendix Database",-1),fileBackend=new NativeFileBackend(rootDirectory),{offlineData:offlineData,dataBackend:dataBackend}=await async function(objectCache,database,fileBackend,getDocumentUrlFn){const store=new SqlStore(window.mx.session.getConfig("sync_config.schema"),database),synchronizer=new Synchronizer(store,fileBackend,objectCache),dataBackend=new OfflineDataBackend(objectCache,store,fileBackend,synchronizer,getDocumentUrlFn);return await dataBackend.initialize(),{dataBackend:dataBackend,offlineData:new OfflineData(objectCache,database)}}(cache,database,fileBackend,(fileName,changedDate,isThumb)=>`${DocumentDirectoryPath}/${rootDirectory}/${isThumb?"thumbnails":"documents"}/${fileName}`);window.mx.offlineData=offlineData,data.startup(dataBackend),shouldSync&&(await data.uploadOffline(),await data.downloadOffline())}function login$1(username,password,onSuccess,onError){window.mx.session.login({username:username,password:password}).then(()=>{onSuccess&&onSuccess(),window.mx.reload()},onError)}function logout$1(){window.mx.session.logout().then(()=>window.mx.data.clear(window.mx.reload))}async function reloadWithState(){await NativeUI.savePageState(),window.mx.reload()}async function startApp({cacheBust:cacheBust,resourcesMap:resourcesMap,legacyProfile:legacyProfile,tabs:tabs}){try{const remoteUrl=NativeModules.MxConfiguration.RUNTIME_URL;await startupNativeClient(remoteUrl,cacheBust,resourcesMap,legacyProfile),await NativeUI.startApp(tabs)}catch(e){NativeModules.NativeErrorHandler.handle(e.message,parse(e.stack))}}configure({reactionScheduler:unstable_batchedUpdates});export{NativeUI,asPluginWidget,asPluginWidgets,startApp};
