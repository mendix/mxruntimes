import{NativeModules}from"react-native";import{A as AssertionError}from"./53bf75a6.js";import{i as isJson}from"./567083d6.js";import{n as DescribedServerError,q as getUniqueId}from"./a4defc10.js";import{V as ValidationError}from"./b92dd682.js";class ConnectionError extends Error{constructor(message){super(message),Object.setPrototypeOf(this,ConnectionError.prototype)}}const middlewares=[];function registerMiddleware(middleware){middlewares.push(middleware)}async function applyMiddleware(request,actual){return async function doProcess(index,req){if(index===middlewares.length)return actual(req);return middlewares[index](req,r=>doProcess(index+1,r))}(0,request)}class ServerError extends Error{constructor(status,message){super(message),this.status=status,Object.setPrototypeOf(this,ServerError.prototype)}}class UnauthorizedError extends ServerError{constructor(status){super(status),Object.setPrototypeOf(this,UnauthorizedError.prototype)}}async function get(url,handleAs){const request={url:url,init:{method:"get",headers:new Headers,cache:"force-cache",credentials:"include"}},response=await applyMiddleware(request,doFetch);if(!response.ok)throw new ServerError(response.status,response.statusText);switch(handleAs){case"text":return response.text();case"json":return response.json();case"blob":return response.blob()}}async function post(url,data){const request={url:url,body:data,init:{method:"post",headers:new Headers(Object.assign({Accept:"application/json"},isJson(data)?{"Content-Type":"application/json"}:{})),redirect:"error",credentials:"include"}};return(await applyMiddleware(request,doFetch)).json()}async function doFetch(request){if(request.init.body)throw new AssertionError;let response;request.init.body=isJson(request.body)?JSON.stringify(request.body):request.body;try{response=await window.fetch(request.url,request.init)}catch(e){throw new ConnectionError(e.message)}switch(response.status){case 200:return response;case 400:case 401:case 402:case 403:case 460:throw new UnauthorizedError(response.status);case 502:case 504:throw new ServerError(response.status,response.statusText);case 551:throw new ValidationError(await response.json());case 560:const description=await getXasErrorDescription(response);throw description?new DescribedServerError(description):new ServerError(response.status);case 12029:throw new ConnectionError("No connection");default:throw new ServerError(response.status,await getXasErrorDescription(response))}}async function getXasErrorDescription(response){const json=await response.json();return json&&"description"in json?json.description:void 0}const DEFAULT_FILES_DIRECTORY="files",DOCUMENT_DIR="documents",THUMBNAIL_DIR="thumbnails";function getFsFileName(guid,changeDate){return guid.replace(/:/g,"_")+"@"+(null!=changeDate&&""!==changeDate?changeDate.toString():"local")}const GUID_PREFIX="GUID:",GUID_REGEXP=new RegExp("^"+GUID_PREFIX);function createUnsyncedGuid(){return GUID_PREFIX+getUniqueId()}function wasGuidSynced(internalGuid){return!GUID_REGEXP.test(internalGuid)}function isSpecialAttributeName(attrName){return"guid"===attrName||"$"===attrName[0]}function isReadonlyAttr(obj,attr){return obj.$readonlyAttrs.includes(attr)}function objectToJson(obj){const attributes=Object.keys(obj).filter(attrName=>!isSpecialAttributeName(attrName)).reduce((acc,key)=>(acc[key]={value:obj[key]},isReadonlyAttr(obj,key)&&(acc[key].readonly=!0),acc),{});return{guid:obj.guid,objectType:obj.$objectType,attributes:attributes}}function jsonToObject(jsonData){const dbObj={guid:jsonData.guid,$objectType:jsonData.objectType,$readonlyAttrs:[]};for(const key in jsonData.attributes)dbObj[key]=jsonData.attributes[key].value,jsonData.attributes[key].readonly&&dbObj.$readonlyAttrs.push(key);return dbObj}const DocumentDirectoryPath=NativeModules.NativeFsModule.DocumentDirectoryPath;FormData.prototype.append=function(key,value,name){"blob"===key&&value.nativePayload&&(value=value.nativePayload,name&&(value.name=name)),this._parts.push([key,value])};class NativeFileBackend{constructor(rootDirectory){this.rootDirectory=rootDirectory}async listDir(dirPath){return NativeModules.NativeFsModule.list(relativeToAbsolutePath(dirPath))}async removeDir(dirPath){return NativeModules.NativeFsModule.remove(relativeToAbsolutePath(dirPath))}async readFile(filePath){const blob=new Blob;return blob.nativePayload={uri:`file://${relativeToAbsolutePath(filePath)}`,name:filePath.substring(filePath.lastIndexOf("/")+1),type:"*/*"},blob}async storeFile(blob,filePath){await NativeModules.NativeFsModule.save(blob.data,relativeToAbsolutePath(filePath)),blob.close()}async moveFile(filePath,newPath){return NativeModules.NativeFsModule.move(relativeToAbsolutePath(filePath),relativeToAbsolutePath(newPath))}async removeFile(filePath){return NativeModules.NativeFsModule.remove(relativeToAbsolutePath(filePath))}async downloadFile(url,filePath){const blob=await get(url,"blob");await NativeModules.NativeFsModule.save(blob.data,relativeToAbsolutePath(filePath)),blob.close()}toAbsolutePath(path){return function(rootDirectory,path){return rootDirectory+"/"+path}(this.rootDirectory,path)}static async readAsDataURL(filePath){return NativeModules.NativeFsModule.readAsDataURL(relativeToAbsolutePath(filePath))}}function relativeToAbsolutePath(path){return path.includes(DocumentDirectoryPath)?path:[DocumentDirectoryPath,path].join("/")}export{ConnectionError as C,DOCUMENT_DIR as D,NativeFileBackend as N,THUMBNAIL_DIR as T,UnauthorizedError as U,getFsFileName as a,DEFAULT_FILES_DIRECTORY as b,createUnsyncedGuid as c,isReadonlyAttr as d,get as g,isSpecialAttributeName as i,jsonToObject as j,objectToJson as o,post as p,registerMiddleware as r,wasGuidSynced as w};
