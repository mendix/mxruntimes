import{f as computed,r as reaction,a as action}from"./ef69c932.js";import{t as tuple,B as Big}from"./0e413733.js";import{p as pageScope}from"./5838721f.js";import{b as using,j as loadableDependentResource,m as mapL,r as runActionInComputed,s as subscriptionDependency,t as timerDependency,l as loading,k as liftL}from"./b3d27a00.js";import{t as toObjectItem}from"./7975ceb4.js";function getClientPagedList(config,store,widgetId,getParameters$,fetch){const fetchTrigger=objectListTrigger(config,store,getParameters$),fetchResult=loadableDependentResource(`Execute data source of ${config.friendlyId}`,()=>fetchTrigger.get(),async trigger=>trigger.load?mapL(await fetch(trigger.parameters),mxobjs=>tuple(mxobjs,trigger.version)):loading()),unpagedListValue=using(()=>[reaction(()=>mapL(fetchResult.get(),([allObjects])=>allObjects.forEach(o=>subscriptionDependency(config.friendlyId,{guid:o.getGuid()}).reportObserved())),()=>{}),reaction(()=>fetchResult.get(),liftL(([allObjects])=>store.set(widgetId,"allGuids",allObjects.map(o=>o.getGuid())))),()=>store.set(widgetId,"allGuids",void 0)],()=>mapL(fetchResult.get(),([allObjects,version])=>({items:allObjects.map(o=>toObjectItem(o,widgetId)),offset:0,totalCount:allObjects.length,hasMoreItems:!1,version:version}))),pagedListValue=using(()=>[reaction(()=>getApplyContextCount$(store),applyContextCount=>{void 0!==applyContextCount&&applyContextCount>0&&store.set(widgetId,"offset",Big(0))})],()=>mapL(unpagedListValue.get(),unpagedList=>{const{amount:amount,offset:offset}=getCurrentPage$(config,store,widgetId),fixedOffset=offset>=unpagedList.totalCount?0:offset;return offset!==fixedOffset&&runActionInComputed(()=>store.set(widgetId,"offset",Big(fixedOffset))),{items:unpagedList.items.slice(fixedOffset,fixedOffset+amount),offset:fixedOffset,totalCount:unpagedList.totalCount,hasMoreItems:fixedOffset+amount<unpagedList.totalCount,version:unpagedList.version}}));return withPageInfoSharing(()=>pagedListValue.get(),store,widgetId)}function getApplyContextCount$(store){return store.get$(pageScope,"applyContextCount")}function objectListTrigger(config,store,getParameters$){const entityDependency=subscriptionDependency(`Data source of ${config.friendlyId}`,{entity:config.entity}),refreshDependency=config.refreshTime?timerDependency(`Data source of ${config.friendlyId}`,config.refreshTime):void 0;let version=0;return computed(()=>(entityDependency.reportObserved(),refreshDependency&&refreshDependency.reportObserved(),void 0!==getApplyContextCount$(store)?{load:!0,parameters:getParameters$(),version:version++}:{load:!1}))}function getCurrentPage$(config,store,widgetId){const offset=store.get$(widgetId,"offset"),amount=store.get$(widgetId,"amount");return{offset:void 0!==offset?Number(offset):0,amount:void 0!==amount?Number(amount):config.defaultAmount||Number.POSITIVE_INFINITY}}function withPageInfoSharing(getListInfo$,store,widgetId){return using(()=>[reaction(()=>getListInfo$(),liftL(({items:items,hasMoreItems:hasMoreItems,totalCount:totalCount})=>{store.set(widgetId,"total",void 0!==totalCount?Big(totalCount):void 0),store.set(widgetId,"hasMoreItems",hasMoreItems),store.set(widgetId,"pageGuids",items.map(i=>i.id)),store.set(widgetId,"count",Big(items.length))}),{fireImmediately:!0}),action(()=>{store.set(widgetId,"total",void 0),store.set(widgetId,"hasMoreItems",void 0),store.set(widgetId,"pageGuids",void 0),store.set(widgetId,"count",void 0)})],()=>getListInfo$())}export{getApplyContextCount$ as a,getCurrentPage$ as b,getClientPagedList as g,objectListTrigger as o,withPageInfoSharing as w};
